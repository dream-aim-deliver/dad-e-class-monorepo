'use client';

// Auto-generated by page-scaffold command v2
// Notion: https://www.notion.so/CMS-Single-user-Manage-Users-13a5a7432d018065bea7fcc7370b0adf
// Usecases from Notion: getPersonalProfile, getProfessionalProfile, listStudentCourses, listCoachReviews, listUserRoles, listCoachCourses, updateUserRoles
// Features from Notion: Personal Profile, Professional Profile, Student Courses, Coach Courses, Coach Reviews, User Roles Management
// User Types from Notion: CMS (admin/superadmin)
// Figma: https://www.figma.com/design/8KEwRuOoD5IgxTtFAtLlyS/Just_Do_Ad-1.2?node-id=8441-211961&t=VMezG7e44vUaPrMu-4
// Comments from Notion:
// Change: similar to the Coach Profile page (visitor)
// DECISION: we won't let admins change personal & professional details of users
// For Students: only render PersonalProfile, StudentCourses, Roles
// For Coach and higher: PersonalProfile, ProfessionalProfile, StudentCourses, CoachCourses, CoachReviews, Roles

import { useState } from 'react';
import Link from 'next/link';
import { useLocale, useTranslations } from 'next-intl';
import { TLocale, getDictionary } from '@maany_shr/e-class-translations';
import { trpc } from '../trpc/cms-client';
import { viewModels } from '@maany_shr/e-class-models';
import { DefaultLoading, DefaultError, UserAvatar, Badge, StarRating, CourseCard, Dropdown, ConfirmationModal, CoachReviewCard, Banner } from '@maany_shr/e-class-ui-kit';
import { useGetPersonalProfilePresenter } from '../hooks/use-get-personal-profile-presenter';
import { useListUserRolesPresenter } from '../hooks/use-list-user-roles-presenter';

import { useGetProfessionalProfilePresenter } from '../hooks/use-get-professional-profile-presenter';
import { useListStudentCoursesPresenter } from '../hooks/use-list-student-courses-presenter';
import { useListCoachReviewsPresenter } from '../hooks/use-list-coach-reviews-presenter';
import { useListCoachCoursesPresenter } from '../hooks/use-list-coach-courses-presenter';
import { useGetCoachApplicationPresenter } from '../hooks/use-get-coach-application-presenter';
import { getHighestRole } from '../../common/utils/role-utils';
import { TEClassRole } from '@dream-aim-deliver/e-class-cms-rest';
import Tooltip from 'packages/ui-kit/lib/components/tooltip';
import { useRequiredPlatform } from '../context/platform-context';

interface SingleUserProps {
  locale: TLocale;
  platformSlug: string;
  platformLocale: TLocale;
  username: string;
}


export default function SingleUser({ locale, platformSlug, platformLocale, username }: SingleUserProps) {
  // TRPC utils for query invalidation
  const utils = trpc.useUtils();

  const t = useTranslations('pages.singleUser');
  const tRoles = useTranslations('common.roles');
  const currentLocale = useLocale() as TLocale;
  const { platform } = useRequiredPlatform();

  // View models
  const [personalProfileVM, setPersonalProfileVM] = useState<viewModels.TGetPersonalProfileViewModel | undefined>(undefined);
  const [userRolesVM, setUserRolesVM] = useState<viewModels.TListUserRolesViewModel | undefined>(undefined);

  const [professionalProfileVM, setProfessionalProfileVM] = useState<viewModels.TGetProfessionalProfileViewModel | undefined>(undefined);
  const [studentCoursesVM, setStudentCoursesVM] = useState<viewModels.TListStudentCoursesViewModel | undefined>(undefined);
  const [coachReviewsVM, setCoachReviewsVM] = useState<viewModels.TListCoachReviewsViewModel | undefined>(undefined);
  const [coachCoursesVM, setCoachCoursesVM] = useState<viewModels.TListCoachCoursesViewModel | undefined>(undefined);
  const [coachApplicationVM, setCoachApplicationVM] = useState<viewModels.TGetCoachApplicationViewModel | undefined>(undefined);

  // Role management state
  const [selectedRole, setSelectedRole] = useState<string>('');
  const [showConfirmation, setShowConfirmation] = useState(false);
  const [roleUpdateSuccess, setRoleUpdateSuccess] = useState<string | null>(null);
  const [roleUpdateError, setRoleUpdateError] = useState<string | null>(null);

  const [reviewSortOrder, setReviewSortOrder] = useState<string>('highest');

  const { presenter: personalProfilePresenter } = useGetPersonalProfilePresenter(setPersonalProfileVM);
  const { presenter: userRolesPresenter } = useListUserRolesPresenter(setUserRolesVM);

  const { presenter: professionalProfilePresenter } = useGetProfessionalProfilePresenter(setProfessionalProfileVM);
  const { presenter: studentCoursesPresenter } = useListStudentCoursesPresenter(setStudentCoursesVM);
  const { presenter: coachReviewsPresenter } = useListCoachReviewsPresenter(setCoachReviewsVM);
  const { presenter: coachCoursesPresenter } = useListCoachCoursesPresenter(setCoachCoursesVM);
  const { presenter: coachApplicationPresenter } = useGetCoachApplicationPresenter(setCoachApplicationVM);

  const [personalProfileResponse, { refetch: refetchPersonalProfile }] = trpc.getPersonalProfile.useSuspenseQuery({ username: username });
  const [userRolesResponse, { refetch: refetchUserRoles }] = trpc.listUserRoles.useSuspenseQuery({ username: username });

  const [professionalProfileResponse] = trpc.getProfessionalProfile.useSuspenseQuery({ username: username });
  const [studentCoursesResponse] = trpc.listStudentCourses.useSuspenseQuery({ studentUsername: username });
  const [coachReviewsResponse] = trpc.listCoachReviews.useSuspenseQuery({ coachUsername: username });
  const [coachCoursesResponse] = trpc.listCoachCourses.useSuspenseQuery({ forStudent: false, coachUsername: username });

  // Query coach application (for students who may have applied to become a coach)
  const [coachApplicationResponse] = trpc.getCoachApplication.useSuspenseQuery({ username: username });

  // Mutation for updating user roles
  const updateUserRolesMutation = trpc.updateUserRoles.useMutation();

  // Present responses
  // @ts-ignore
  personalProfilePresenter.present(personalProfileResponse, personalProfileVM);
  // @ts-ignore
  userRolesPresenter.present(userRolesResponse, userRolesVM);

  // @ts-ignore
  professionalProfilePresenter.present(professionalProfileResponse, professionalProfileVM);
  // @ts-ignore
  studentCoursesPresenter.present(studentCoursesResponse, studentCoursesVM);
  // @ts-ignore
  coachReviewsPresenter.present(coachReviewsResponse, coachReviewsVM);
  // @ts-ignore
  coachCoursesPresenter.present(coachCoursesResponse, coachCoursesVM);
  // @ts-ignore
  coachApplicationPresenter.present(coachApplicationResponse, coachApplicationVM);

  // Loading state - only for page-critical data
  if (!personalProfileVM || !userRolesVM) {
    return <DefaultLoading locale={currentLocale} variant="minimal" />;
  }

  // Error handling - only for page-critical data
  if (personalProfileVM.mode === 'kaboom' || userRolesVM.mode === 'kaboom') {
    const dictionary = getDictionary(currentLocale);
    return (
      <DefaultError
        type="simple"
        locale={currentLocale}
        title={dictionary.components.defaultError.title}
        description={dictionary.components.defaultError.description}
        onRetry={() => {
          refetchPersonalProfile();
          refetchUserRoles();
        }}
      />
    );
  }

  // User truly not found - both profile AND roles fail
  if (personalProfileVM.mode === 'not-found' && userRolesVM.mode === 'not-found') {
    return (
      <DefaultError
        type="simple"
        locale={currentLocale}
        title={t('error.notFound.title')}
        description={t('error.notFound.description')}
      />
    );
  }

  const personalProfile = personalProfileVM.mode === 'default' ? personalProfileVM.data : null;
  const userRoles = userRolesVM.mode === 'default' ? userRolesVM.data : null;

  // Construct full name from name and surname
  const fullName = personalProfile?.profile.name && personalProfile?.profile.surname
    ? `${personalProfile.profile.name} ${personalProfile.profile.surname}`
    : personalProfile?.profile.name || personalProfile?.profile.surname || username;

  const professionalProfile = professionalProfileVM?.mode === 'default' ? professionalProfileVM.data : null;
  const studentCourses = studentCoursesVM?.mode === 'default' && studentCoursesVM.data
    ? studentCoursesVM.data.courses || []
    : [];
  const coachCourses = coachCoursesVM?.mode === 'default' && coachCoursesVM.data
    ? coachCoursesVM.data.courses || []
    : [];
  const coachReviews = coachReviewsVM?.mode === 'default' && coachReviewsVM.data
    ? coachReviewsVM.data.reviews || []
    : [];
  const averageRating = coachReviews && coachReviews.length > 0
    ? coachReviews.reduce((sum, review) => sum + (review.rating || 0), 0) / coachReviews.length
    : 0;
  const totalReviews = coachReviews?.length || 0;
  const isCoachOrHigher = userRoles?.roles && userRoles.roles.some(role =>
    ['coach', 'course-creator', 'admin'].includes(role.toLowerCase())
  );
  const isStudent = userRoles?.roles && userRoles.roles.includes('student');

  // Extract coach application data from view model
  const coachApplication = coachApplicationVM?.mode === 'default' ? coachApplicationVM.data : null;

  const sortedReviews = [...coachReviews].sort((a, b) => {
    if (reviewSortOrder === 'highest') {
      return (b.rating || 0) - (a.rating || 0);
    } else if (reviewSortOrder === 'lowest') {
      return (a.rating || 0) - (b.rating || 0);
    }
    return 0;
  });

  // Handle role change
  const handleRoleChange = (value: string | string[] | null) => {
    if (updateUserRolesMutation.isPending) return;
    if (typeof value === 'string') {
      setSelectedRole(value);
      setShowConfirmation(true);
    }
  };

  const handleConfirmRoleChange = async () => {
    if (!selectedRole) return;

    // Clear previous messages
    setRoleUpdateSuccess(null);
    setRoleUpdateError(null);

    try {
      // Convert course-creator to course_creator for API
      const apiRole = selectedRole === 'course-creator' ? 'course_creator' : selectedRole;

      const result = await updateUserRolesMutation.mutateAsync({
        username,
        role: apiRole as 'student' | 'coach' | 'course_creator' | 'admin',
      });

      // Check if the mutation actually succeeded
      if (result && result.success === true) {
        // On success - invalidate query to trigger refetch
        await utils.listUserRoles.invalidate({ username });
        setRoleUpdateSuccess(t('roleUpdateSuccess', { role: selectedRole }));
        // Auto-dismiss after 5 seconds
        setTimeout(() => setRoleUpdateSuccess(null), 5000);
      } else {
        // Mutation completed but returned error status
        const errorMessage = typeof result === 'object' && result !== null && 'message' in result && typeof result.message === 'string'
          ? result.message
          : t('roleUpdateError');
        setRoleUpdateError(errorMessage);
      }
    } catch (error: unknown) {
      // On error - extract error message if available
      const errorMessage = error instanceof Error && error.message
        ? error.message
        : t('roleUpdateError');
      setRoleUpdateError(errorMessage);
    } finally {
      setShowConfirmation(false);
      setSelectedRole('');
    }
  };

  const handleCancelRoleChange = () => {
    setShowConfirmation(false);
    setSelectedRole('');
  };

  const handleReviewSortChange = (value: string | string[] | null) => {
    if (typeof value === 'string') {
      setReviewSortOrder(value);
    }
  };

  const roleOptions = [
    { label: tRoles('student'), value: 'student' },
    { label: tRoles('coach'), value: 'coach' },
    { label: tRoles('course_creator'), value: 'course-creator' },
    { label: tRoles('admin'), value: 'admin' },
  ];

  const reviewSortOptions = [
    { label: t('highestRating'), value: 'highest' },
    { label: t('lowestRating'), value: 'lowest' },
  ];

  // Check if user is superadmin - if so, disable role changes
  const isSuperadmin = userRoles?.roles && userRoles.roles.includes('superadmin');

  return (
    <div className="flex flex-col space-y-5">
      {/* Success/Error Messages */}
      {roleUpdateSuccess && (
        <Banner
          style="success"
          description={roleUpdateSuccess}
          closeable
          onClose={() => setRoleUpdateSuccess(null)}
        />
      )}
      {roleUpdateError && (
        <Banner
          style="error"
          description={roleUpdateError}
          closeable
          onClose={() => setRoleUpdateError(null)}
        />
      )}

      {/* Back Link */}
      <Link
        href={`/${locale}/platform/${platformSlug}/${platformLocale}/users`}
        className="text-sm text-text-secondary hover:text-text-primary transition-colors flex items-center gap-1 w-fit"
      >
        ‚Üê {t('backToUsers')}
      </Link>

      {/* Hero Section with Personal & Professional Profile */}
      <div className="flex flex-col gap-6 ">
        <div className="flex flex-row gap-7 items-start">
          <UserAvatar
            size="xLarge"
            imageUrl={personalProfile?.profile.avatarImage?.downloadUrl}
            fullName={fullName}
          />

          {/* Name, Roles, and Reviews Column */}
          <div className="flex flex-col gap-4 flex-1">
            <div className="flex flex-row justify-between items-center gap-4">
              {/* User Name */}
              <h1>{fullName}</h1>

              {/* Role Management Dropdown or Protection Message */}
              {isSuperadmin ? (
                <div className="min-w-[200px] flex items-center justify-end">
                  <p className="text-sm text-text-secondary italic">
                    {t('superadminRoleProtected')}
                  </p>
                </div>
              ) : (
                <div className="flex flex-row min-w-[200px] gap-1 items-center">
                  <Tooltip text='' description='After changing roles, it may take up to 15 minutes for the system to fully update.' tipPosition='bottom' />
                  <Dropdown
                    type="simple"
                    options={roleOptions}
                    onSelectionChange={handleRoleChange}
                    text={{ simpleText: t('changeRole') }}
                    className="w-full"
                  />
                </div>
              )}
            </div>

            {/* Roles and Reviews Row */}
            <div className="flex items-center gap-3 flex-wrap">
              {/* Roles - Show only highest role */}
              {userRoles?.roles && userRoles.roles.length > 0 && (() => {
                const highestRole = getHighestRole(userRoles.roles as TEClassRole[]);
                if (!highestRole) return null;

                // Get translated role name, fallback to role key if translation missing
                const translatedRole = tRoles(highestRole) || highestRole;

                return (
                  <Badge
                    text={translatedRole}
                    variant="info"
                    size="medium"
                  />
                );
              })()}

              {totalReviews > 0 && (
                <div className="flex flex-row gap-2 items-center">
                  <StarRating
                    rating={averageRating}
                    totalStars={5}
                  />
                  <span className="md:text-sm text-xs text-text-primary font-important">
                    {averageRating.toFixed(1)}
                  </span>
                  <span className="sm:text-xs text-[10px] text-text-secondary font-important">
                    ({totalReviews})
                  </span>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Personal Profile Information */}
        <div className="flex flex-col gap-3 border-t border-card-stroke pt-4">
          <h3 className="text-text-primary">{t('personalInformation')}</h3>
          {personalProfile ? (
            <div className="flex flex-col gap-4">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                  <p className="text-sm text-text-secondary">{t('name')}</p>
                  <p className="text-text-primary">{personalProfile.profile.name || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-text-secondary">{t('surname')}</p>
                  <p className="text-text-primary">{personalProfile.profile.surname || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-text-secondary">{t('email')}</p>
                  <p className="text-text-primary">{personalProfile.profile.email || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-text-secondary">{t('phone')}</p>
                  <p className="text-text-primary">{personalProfile.profile.phone || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-text-secondary">{t('dateOfBirth')}</p>
                  <p className="text-text-primary">
                    {personalProfile?.profile?.dateOfBirth
                      ? new Date(personalProfile.profile.dateOfBirth).toLocaleDateString(currentLocale, {
                          year: 'numeric',
                          month: 'long',
                          day: 'numeric',
                        })
                      : '-'}
                  </p>
                </div>
              </div>

              {/* Company Information (if representing a company) */}
              {personalProfile?.profile?.companyDetails?.isRepresentingCompany && (
                <div className="border-t border-card-stroke/50 pt-4">
                  <h4 className="text-text-secondary text-sm font-medium mb-3">{t('companyInformation')}</h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                      <p className="text-sm text-text-secondary">{t('companyName')}</p>
                      <p className="text-text-primary">{personalProfile.profile.companyDetails.companyName ?? '-'}</p>
                    </div>
                    <div>
                      <p className="text-sm text-text-secondary">{t('companyUid')}</p>
                      <p className="text-text-primary">{personalProfile.profile.companyDetails.companyUid ?? '-'}</p>
                    </div>
                    <div>
                      <p className="text-sm text-text-secondary">{t('companyAddress')}</p>
                      <p className="text-text-primary">{personalProfile.profile.companyDetails.companyAddress ?? '-'}</p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          ) : (
            <p className="text-text-secondary">{t('noPersonalProfile')}</p>
          )}
        </div>

        {isCoachOrHigher && professionalProfile && (
          <div className="flex flex-col gap-3 border-t border-card-stroke pt-4">
            <h3 className="text-text-primary">{t('professionalInformation')}</h3>
            <div className="flex flex-col gap-4">
              <div>
                <p className="text-sm text-text-secondary">{t('professionalBio')}</p>
                <p className="text-text-primary">{professionalProfile?.profile.bio || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-text-secondary">{t('skills')}</p>
                <div className="flex flex-wrap gap-2 mt-2">
                  {professionalProfile?.profile.skills && professionalProfile.profile.skills.length > 0 ? (
                    professionalProfile.profile.skills.map((skill, index) => (
                      <Badge key={index} text={skill.name} variant="primary" size="small" />
                    ))
                  ) : (
                    <p className="text-text-primary">-</p>
                  )}
                </div>
              </div>

              {/* Links */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                  <p className="text-sm text-text-secondary">{t('linkedinUrl')}</p>
                  {professionalProfile?.profile?.linkedinUrl ? (
                    <a
                      href={professionalProfile.profile.linkedinUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-button-primary-fill hover:underline"
                    >
                      {professionalProfile.profile.linkedinUrl}
                    </a>
                  ) : (
                    <p className="text-text-primary">-</p>
                  )}
                </div>
                <div>
                  <p className="text-sm text-text-secondary">{t('portfolioWebsite')}</p>
                  {professionalProfile?.profile?.portfolioWebsite ? (
                    <a
                      href={professionalProfile.profile.portfolioWebsite}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-button-primary-fill hover:underline"
                    >
                      {professionalProfile.profile.portfolioWebsite}
                    </a>
                  ) : (
                    <p className="text-text-primary">-</p>
                  )}
                </div>
                <div>
                  <p className="text-sm text-text-secondary">{t('coachApplication.cv')}</p>
                  {professionalProfile?.profile?.curriculumVitae?.downloadUrl ? (
                    <a
                      href={professionalProfile.profile.curriculumVitae.downloadUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-button-primary-fill hover:underline"
                    >
                      {t('coachApplication.downloadCv')}
                    </a>
                  ) : (
                    <p className="text-text-primary">-</p>
                  )}
                </div>
              </div>

              {/* Professional Company Information */}
              {(professionalProfile?.profile?.companyName || professionalProfile?.profile?.companyRole || professionalProfile?.profile?.companyIndustry) && (
                <div className="border-t border-card-stroke/50 pt-4">
                  <h4 className="text-text-secondary text-sm font-medium mb-3">{t('professionalCompanyInfo')}</h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                      <p className="text-sm text-text-secondary">{t('companyName')}</p>
                      <p className="text-text-primary">{professionalProfile?.profile?.companyName ?? '-'}</p>
                    </div>
                    <div>
                      <p className="text-sm text-text-secondary">{t('companyRole')}</p>
                      <p className="text-text-primary">{professionalProfile?.profile?.companyRole ?? '-'}</p>
                    </div>
                    <div>
                      <p className="text-sm text-text-secondary">{t('companyIndustry')}</p>
                      <p className="text-text-primary">{professionalProfile?.profile?.companyIndustry ?? '-'}</p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Coach Application Section - for students who have applied to become a coach */}
        {isStudent && coachApplication && (
          <div className="flex flex-col gap-3 border-t border-card-stroke pt-4">
            <div>
              <h3 className="text-text-primary">{t('coachApplication.title')}</h3>
              <p className="text-text-secondary text-sm italic mt-1">{t('coachApplication.helperText')}</p>
            </div>

            {/* Application Submission Date */}
            <div>
              <p className="text-sm text-text-secondary">{t('coachApplication.submittedOn')}</p>
              <p className="text-text-primary">
                {coachApplication.createdAt
                  ? new Date(coachApplication.createdAt).toLocaleString(currentLocale, {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit',
                    })
                  : '-'}
              </p>
            </div>

            {/* Professional Profile submitted with the application */}
            {professionalProfile && (
              <div className="flex flex-col gap-4 mt-2">
                <div>
                  <p className="text-sm text-text-secondary">{t('professionalBio')}</p>
                  <p className="text-text-primary">{professionalProfile?.profile.bio || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-text-secondary">{t('skills')}</p>
                  <div className="flex flex-wrap gap-2 mt-2">
                    {professionalProfile?.profile.skills && professionalProfile.profile.skills.length > 0 ? (
                      professionalProfile.profile.skills.map((skill, index) => (
                        <Badge key={index} text={skill.name} variant="primary" size="small" />
                      ))
                    ) : (
                      <p className="text-text-primary">-</p>
                    )}
                  </div>
                </div>

                {/* Links */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div>
                    <p className="text-sm text-text-secondary">{t('linkedinUrl')}</p>
                    {professionalProfile?.profile?.linkedinUrl ? (
                      <a
                        href={professionalProfile.profile.linkedinUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="text-button-primary-fill hover:underline"
                      >
                        {professionalProfile.profile.linkedinUrl}
                      </a>
                    ) : (
                      <p className="text-text-primary">-</p>
                    )}
                  </div>
                  <div>
                    <p className="text-sm text-text-secondary">{t('portfolioWebsite')}</p>
                    {professionalProfile?.profile?.portfolioWebsite ? (
                      <a
                        href={professionalProfile.profile.portfolioWebsite}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="text-button-primary-fill hover:underline"
                      >
                        {professionalProfile.profile.portfolioWebsite}
                      </a>
                    ) : (
                      <p className="text-text-primary">-</p>
                    )}
                  </div>
                  <div>
                    <p className="text-sm text-text-secondary">{t('coachApplication.cv')}</p>
                    {professionalProfile?.profile?.curriculumVitae?.downloadUrl ? (
                      <a
                        href={professionalProfile.profile.curriculumVitae.downloadUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="text-button-primary-fill hover:underline"
                      >
                        {t('coachApplication.downloadCv')}
                      </a>
                    ) : (
                      <p className="text-text-primary">-</p>
                    )}
                  </div>
                </div>

                {/* Company Information */}
                {(professionalProfile?.profile?.companyName || professionalProfile?.profile?.companyRole || professionalProfile?.profile?.companyIndustry) && (
                  <div className="border-t border-card-stroke/50 pt-4">
                    <h4 className="text-text-secondary text-sm font-medium mb-3">{t('professionalCompanyInfo')}</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      <div>
                        <p className="text-sm text-text-secondary">{t('companyName')}</p>
                        <p className="text-text-primary">{professionalProfile?.profile?.companyName ?? '-'}</p>
                      </div>
                      <div>
                        <p className="text-sm text-text-secondary">{t('companyRole')}</p>
                        <p className="text-text-primary">{professionalProfile?.profile?.companyRole ?? '-'}</p>
                      </div>
                      <div>
                        <p className="text-sm text-text-secondary">{t('companyIndustry')}</p>
                        <p className="text-text-primary">{professionalProfile?.profile?.companyIndustry ?? '-'}</p>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        )}
      </div>

      <div className="flex flex-col gap-4">
        <div className="flex flex-row justify-between items-center">
          <h3>{t('studentCourses')}</h3>
        </div>
        {!studentCoursesVM ? (
          <DefaultLoading locale={currentLocale} variant="minimal" />
        ) : studentCoursesVM.mode === 'kaboom' ? (
          <DefaultError
            type="simple"
            locale={currentLocale}
            title={t('error.title')}
            description={t('error.description')}
          />
        ) : studentCourses && studentCourses.length > 0 ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {studentCourses.map((course) => {
              const progress = course.status?.status === 'inProgress' ? course.status.progress : 100;

              return (
                <CourseCard
                  key={course.id}
                  userType="student"
                  reviewCount={course.ratingCount}
                  locale={currentLocale}
                  language={{ name: course.language.name, code: course.language.code }}
                  course={{
                    title: course.title,
                    description: course.briefDescription,
                    rating: course.rating,
                    author: {
                      name: `${course.creator.name} ${course.creator.surname}`,
                      image: course.creator.avatarImage?.downloadUrl || ''
                    },
                    pricing: {
                      fullPrice: course.fullPrice || 0,
                      currency: course.currency,
                      partialPrice: course.partialPrice || 0,
                    },
                    duration: {
                      video: course.durationMinutes || 0,
                      coaching: 0,
                      selfStudy: 0
                    },
                    language: course.language,
                    imageUrl: course.image?.downloadUrl || 'https://res.cloudinary.com/dgk9gxgk4/image/upload/v1733464948/2151206389_1_c38sda.jpg'
                  }}
                  progress={progress}
                  sales={course.salesCount}
                  onBegin={() => {
                    window.open(`${platform.domainName}/${platformLocale}/courses/${course.slug}`, '_blank');
                  }}
                  onResume={() => {
                    window.open(`${platform.domainName}/${platformLocale}/courses/${course.slug}`, '_blank');
                  }}
                  onReview={() => {
                    window.open(`${platform.domainName}/${platformLocale}/courses/${course.slug}`, '_blank');
                  }}
                  onDetails={() => {
                    window.open(`${platform.domainName}/${platformLocale}/courses/${course.slug}`, '_blank');
                  }}
                  onClickUser={() => {
                    // No-op: admin is already viewing this user's profile
                  }}
                />
              );
            })}
          </div>
        ) : (
          <p className="text-text-secondary">{t('noCoursesFound')}</p>
        )}
      </div>

      {isCoachOrHigher && (
        <div className="flex flex-col gap-4">
          <div className="flex flex-row justify-between items-center">
            <h3>{t('coachCourses')}</h3>
          </div>
          {!coachCoursesVM ? (
            <DefaultLoading locale={currentLocale} variant="minimal" />
          ) : coachCoursesVM.mode === 'kaboom' ? (
            <DefaultError
              type="simple"
              locale={currentLocale}
              title={t('error.title')}
              description={t('error.description')}
            />
          ) : coachCourses && coachCourses.length > 0 ? (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {coachCourses.map((course) => {
                return (
                  <CourseCard
                    key={course.id}
                    userType="coach"
                    reviewCount={course.ratingCount}
                    locale={currentLocale}
                    language={{ name: course.language.name, code: course.language.code }}
                    course={{
                      title: course.title,
                      description: course.briefDescription,
                      rating: course.rating,
                      author: {
                        name: `${course.creator.name} ${course.creator.surname}`,
                        image: course.creator.avatarImage?.downloadUrl || ''
                      },
                      pricing: {
                        fullPrice: course.fullPrice || 0,
                        currency: course.currency,
                        partialPrice: course.partialPrice || 0,
                      },
                      duration: {
                        video: course.durationMinutes || 0,
                        coaching: 0,
                        selfStudy: 0
                      },
                      language: course.language,
                      imageUrl: course.image?.downloadUrl || 'https://res.cloudinary.com/dgk9gxgk4/image/upload/v1733464948/2151206389_1_c38sda.jpg'
                    }}
                    sessions={course.coachingSessionCount}
                    sales={course.salesCount || 0}
                    onManage={() => {
                      window.open(`${platform.domainName}/edit/course/${course.slug}`, '_blank');
                    }}
                    onClickUser={() => {
                      // No-op: admin is already viewing this user's profile
                    }}
                  />
                );
              })}
            </div>
          ) : (
            <p className="text-text-secondary">{t('noCoursesFound')}</p>
          )}
        </div>
      )}

      {isCoachOrHigher && (
        <div className="flex flex-col gap-4">
          <div className="flex flex-row justify-between items-center">
            <h3>{t('coachReviews')}</h3>
            {coachReviews && coachReviews.length > 0 && (
              <div className="w-48">
                <Dropdown
                  type="simple"
                  options={reviewSortOptions}
                  onSelectionChange={handleReviewSortChange}
                  text={{ simpleText: t('sortByRating') }}
                  className="w-full"
                />
              </div>
            )}
          </div>
          {!coachReviewsVM ? (
            <DefaultLoading locale={currentLocale} variant="minimal" />
          ) : coachReviewsVM.mode === 'kaboom' ? (
            <DefaultError
              type="simple"
              locale={currentLocale}
              title={t('error.title')}
              description={t('error.description')}
            />
          ) : coachReviews && coachReviews.length > 0 ? (
            <div className="grid gap-4 lg:grid-cols-2 md:grid-cols-1 grid-cols-1">
              {sortedReviews
                .filter(review => review && review.student && review.coachingSession)
                .map((review, index) => {
                  const startTime = new Date(review.coachingSession.startTime);
                  const endTime = new Date(review.coachingSession.endTime);
                  const timeRange = `${startTime.toLocaleTimeString(currentLocale, { hour: '2-digit', minute: '2-digit' })} - ${endTime.toLocaleTimeString(currentLocale, { hour: '2-digit', minute: '2-digit' })}`;

                  const baseProps = {
                    locale: currentLocale,
                    rating: review.rating || 0,
                    reviewText: review.notes || '',
                    reviewerAvatar: review.student.avatarImage?.downloadUrl,
                    reviewerName: review.student.username,
                    workshopTitle: review.coachingSession.coachingOfferingTitle,
                    date: startTime,
                    time: timeRange,
                    onClickReviewer: () => window.open(`/${currentLocale}/students/${review.student.username}`, '_blank'),
                  };

                  if (review.course) {
                    return (
                      <CoachReviewCard
                        key={index}
                        {...baseProps}
                        type="with-course"
                        courseTitle={review.course.title || ''}
                        courseImage={review.course.image?.downloadUrl || ''}
                      />
                    );
                  }

                  return (
                    <CoachReviewCard
                      key={index}
                      {...baseProps}
                      type="standalone"
                    />
                  );
                })}
            </div>
          ) : (
            <p className="text-text-secondary">{t('noReviewsFound')}</p>
          )}
        </div>
      )}

      {/* Confirmation Modal for Role Changes */}
      {showConfirmation && (
        <ConfirmationModal
          locale={currentLocale}
          title={t('confirmRoleChangeTitle')}
          message={t('confirmRoleChangeMessage', { role: selectedRole })}
          confirmText={updateUserRolesMutation.isPending ? t('updatingButton') : t('confirmButton')}
          type="accept"
          isOpen={showConfirmation}
          onConfirm={handleConfirmRoleChange}
          onClose={handleCancelRoleChange}
          isLoading={updateUserRolesMutation.isPending}
        />
      )}
    </div>
  );
}
