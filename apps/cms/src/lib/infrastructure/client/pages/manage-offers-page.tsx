'use client';

// Auto-generated by page-scaffold command v2
// Notion: https://www.notion.so/CMS-Manage-Offers-Page-22d5a7432d01809487b5f5592b2013f3
// Usecases: saveOffersPage, listPackages, requestFileUpload, getOffersPageOutline, listOffersPagePackagesShort
// User Types: CMS (admin/superadmin - enforced by middleware)
// Figma: https://www.figma.com/design/8KEwRuOoD5IgxTtFAtLlyS/Just_Do_Ad-1.2?node-id=8540-240257&t=qGirq2t6ka6iwg1A-4

import { useState, useEffect, useMemo } from 'react';
import { DefaultLoading, DefaultError, Outline, PageTitleSection, PackageSection, CarouselSection, Banner, IconSave, Breadcrumbs, FeedBackMessage, Button } from '@maany_shr/e-class-ui-kit';
import { useLocale, useTranslations } from 'next-intl';
import { TLocale } from '@maany_shr/e-class-translations';
import { trpc } from '../trpc/cms-client';
import { useSession } from 'next-auth/react';
import { useContentLocale } from '../hooks/use-platform-translations';

import { Button } from '@maany_shr/e-class-ui-kit';
import { viewModels } from '@maany_shr/e-class-models';
import { useListOffersPagePackagesShortPresenter } from '../hooks/use-list-offers-page-packages-short-presenter';
import { useListPackagesPresenter } from '../hooks/use-list-packages-presenter';
import { useGetOffersPageOutlinePresenter } from '../hooks/use-get-offers-page-outline-presenter';
import { useSaveOffersPagePresenter } from '../hooks/use-save-offers-page-presenter';
import { useHomePageFileUpload } from './common/hooks/use-homepage-file-upload';
import { useFormState } from 'packages/ui-kit/lib/hooks/use-form-state';
import { useRouter } from 'next/navigation';
import { useRequiredPlatform } from '../context/platform-context';

type CarouselItem = {
    title: string;
    description: string;
    buttonText: string;
    imageUrl: string | null;
    imageId: number | null;
    imageName: string | null;
    imageSize: number | null;
    buttonUrl: string;
    badge?: string;
};

type OffersPageFormData = {
    title: string;
    description: string;
    packageIds: number[];
    carousel: CarouselItem[];
};

// Static default data - moved outside component for better performance
const DEFAULT_OFFERS_PAGE_DATA: OffersPageFormData = {
    title: '',
    description: '',
    packageIds: [],
    carousel: [],
} as const;

interface ManageOffersPageProps {
    locale: string;
    platformSlug: string;
    platformLocale: string;
}

export default function ManageOffersPage({
    locale: _locale,
    platformSlug,
    platformLocale,
}: ManageOffersPageProps) {
    const locale = useLocale() as TLocale;
    const t = useTranslations('pages.manageOffersPage');
    const platformTranslations = useTranslations('pages.managePagesGeneral');
    const breadcrumbsTranslations = useTranslations('components.breadcrumbs');
    const router = useRouter();
    const { platform } = useRequiredPlatform();
    const contentLocale = useContentLocale();

    const [_uploadProgress, setUploadProgress] = useState<number | undefined>(undefined);
    const [offersPageViewModel, setOffersPageViewModel] = useState<
        viewModels.TGetOffersPageOutlineViewModel | undefined
    >(undefined);
    const [packagesViewModel, setPackagesViewModel] = useState<
        viewModels.TListPackagesViewModel | undefined
    >(undefined);
    const [packagesShortViewModel, setPackagesShortViewModel] = useState<
        viewModels.TListOffersPagePackagesShortViewModel | undefined
    >(undefined);


    const sessionDTO = useSession();
    const session = sessionDTO.data;
    const isAdmin = session?.user?.roles?.includes('admin') || session?.user?.roles?.includes('superadmin');


    const [offersPageOutlineResponse, { refetch: refetchOffersPageOutline }] = trpc.getOffersPageOutline.useSuspenseQuery(
        {},
        {
            refetchOnWindowFocus: false,
        }
    );
    const [packagesShortResponse, { refetch: refetchPackagesShort }] = trpc.listOffersPagePackagesShort.useSuspenseQuery(
        {},
        {
            refetchOnWindowFocus: false,
        }
    );
    const [packagesResponse, { refetch: refetchPackages }] = trpc.listPackages.useSuspenseQuery(
        {},
        {
            refetchOnWindowFocus: false,
        }
    );

    const { presenter: manageOffersPagePresenter } = useGetOffersPageOutlinePresenter(setOffersPageViewModel);
    const { presenter: packagesPresenter } = useListPackagesPresenter(setPackagesViewModel);
    const { presenter: packagesShortPresenter } = useListOffersPagePackagesShortPresenter(setPackagesShortViewModel);

    const { handleFileUpload, handleFileDelete, handleFileDownload } = useHomePageFileUpload(setUploadProgress);

    // Extract data from view models
    const offersPageData = offersPageViewModel?.mode === 'default' ? offersPageViewModel.data : null;
    const packagesData = packagesViewModel?.mode === 'default' ? packagesViewModel.data : null;
    const packagesShortData = packagesShortViewModel?.mode === 'default' ? packagesShortViewModel.data : null;

    const allPackages = useMemo(() =>
        (packagesData?.packages || []).map(pkg => ({ ...pkg, id: String(pkg.id) }))
        , [packagesData?.packages]);

    const linkedPackageIds = useMemo(() =>
        (packagesShortData?.packageIds || []).map(String)
        , [packagesShortData?.packageIds]);

    const initialPackageIds = useMemo(() =>
        allPackages.filter((pkg) =>
            pkg.id != null && linkedPackageIds.includes(String(pkg.id))
        ).map(pkg => Number(pkg.id))
        , [allPackages, linkedPackageIds]);

    const initialFormData: OffersPageFormData = useMemo(() =>
        (offersPageViewModel?.mode === 'default' && packagesViewModel?.mode === 'default' && packagesShortViewModel?.mode === 'default')
            ? {
                title: offersPageData?.title || '',
                description: offersPageData?.description || '',
                packageIds: initialPackageIds,
                carousel: (offersPageData?.items || []).map(item => ({
                    title: item.title,
                    description: item.description,
                    buttonText: item.buttonText,
                    buttonUrl: item.buttonUrl,
                    badge: item.badge ?? undefined,
                    imageUrl: item.image?.downloadUrl ?? null,
                    imageId: item.image?.id ? Number(item.image.id) : null,
                    imageName: item.image?.name ?? null,
                    imageSize: item.image?.size ?? null,
                })),
            }
            : DEFAULT_OFFERS_PAGE_DATA
        , [offersPageViewModel?.mode, packagesViewModel?.mode, packagesShortViewModel?.mode, offersPageData, initialPackageIds]);

    const formState = useFormState(initialFormData, { enableReloadProtection: true });
    const setFormValue = formState.setValue;

    // Handlers must be defined before conditional returns (Rules of Hooks)
    const handlePageTitleChange = (newValue: { title: string; description: string }) => {
        setFormValue((prev) => {
            if (!prev) return prev;
            return {
                ...prev,
                title: newValue.title,
                description: newValue.description
            };
        });
    };

    const handlePackagesChange = (newSelected: any[]) => {
        const newPackageIds = newSelected.map((pkg: any) => Number(pkg.id));
        setFormValue((prev) => {
            if (!prev) return prev;
            return {
                ...prev,
                packageIds: newPackageIds
            };
        });
    };

    const handleCarouselChange = (newCarousel: Array<{
        title: string;
        description: string;
        buttonText: string;
        buttonUrl: string;
        badge?: string | null | undefined;
        image: { id: string; name: string; size: number; category: 'image'; downloadUrl: string } | null;
    }>) => {
        const transformedCarousel = newCarousel.map((item) => ({
            title: item.title,
            description: item.description,
            buttonText: item.buttonText,
            buttonUrl: item.buttonUrl,
            badge: item.badge ?? undefined,
            imageUrl: item.image?.downloadUrl ?? null,
            imageId: item.image?.id ? Number(item.image.id) : null,
            imageName: item.image?.name ?? null,
            imageSize: item.image?.size ?? null,
        }));
        setFormValue((prev) => {
            if (!prev) return prev;
            return {
                ...prev,
                carousel: transformedCarousel
            };
        });
    };

    // Save mutation
    const saveOffersPageMutation = trpc.saveOffersPage.useMutation();
    const [saveViewModel, setSaveViewModel] = useState<
        viewModels.TSaveOffersPageViewModel | undefined
    >(undefined);

    // Mutation presenter
    const { presenter: savePresenter } = useSaveOffersPagePresenter(setSaveViewModel);

    // Error and success message state
    const [errorMessage, setErrorMessage] = useState<string | null>(null);
    const [successMessage, setSuccessMessage] = useState<string | null>(null);

    useEffect(() => {
        if (saveOffersPageMutation.isSuccess && saveOffersPageMutation.data) {
            // @ts-ignore
            savePresenter.present(saveOffersPageMutation.data, saveViewModel);
        }
    }, [saveOffersPageMutation.isSuccess, saveOffersPageMutation.data, savePresenter, saveViewModel]);

    useEffect(() => {
        if (
            saveOffersPageMutation.isSuccess &&
            saveViewModel?.mode === 'default'
        ) {
            // Success case
            setErrorMessage(null);
            setSuccessMessage('Offers page content saved successfully!');
            // Auto-dismiss success message after 5 seconds
            const timer = setTimeout(() => setSuccessMessage(null), 5000);
            return () => clearTimeout(timer);
        }
        // Handle kaboom and other error modes
        if (
            saveOffersPageMutation.isSuccess &&
            saveViewModel?.mode === 'kaboom'
        ) {
            setErrorMessage(
                'Failed to save offers page content. Please try again.'
            );
            setSuccessMessage(null);
        }
    }, [saveViewModel, saveOffersPageMutation.isSuccess]);

    useEffect(() => {
        if (saveOffersPageMutation.isError) {
            setErrorMessage(
                saveOffersPageMutation.error?.message ||
                'Failed to save offers page content. Please try again.'
            );
            setSuccessMessage(null);
        }
    }, [saveOffersPageMutation.isError, saveOffersPageMutation.error]);

    // Present data on mount and when responses change
    useEffect(() => {
        // @ts-ignore
        packagesPresenter.present(packagesResponse, packagesViewModel);
        // @ts-ignore
        manageOffersPagePresenter.present(offersPageOutlineResponse, offersPageViewModel);
        // @ts-ignore
        packagesShortPresenter.present(packagesShortResponse, packagesShortViewModel);
    }, [offersPageOutlineResponse, packagesResponse, packagesShortResponse, manageOffersPagePresenter, packagesPresenter, packagesShortPresenter]);

    // Now handle conditional rendering after all hooks are called
    // Error handling - only kaboom errors should prevent rendering
    // Note: 'not-found' is acceptable since save mutation supports upsert
    if (offersPageViewModel?.mode === 'kaboom' || packagesViewModel?.mode === 'kaboom' || packagesShortViewModel?.mode === 'kaboom') {
        return (
            <DefaultError
                locale={locale}
                title={t('error.title')}
                description={t('error.description')}
            />
        );
    }
    // Defensive auth check on client side
    if (!session || !isAdmin) {
        return (
            <DefaultError
                locale={locale}
                title={t('error.unauthorized.title')}
                description={t('error.unauthorized.description')}
            />
        );
    }

    // Loading state - show loading until all data is ready
    if (!offersPageOutlineResponse || !packagesShortResponse || !packagesResponse) {
        return <DefaultLoading locale={locale} variant="minimal" />;
    }

    // Loading state - show loading until viewModels are presented
    if (!offersPageViewModel || !packagesViewModel || !packagesShortViewModel) {
        return <DefaultLoading locale={locale} variant="minimal" />;
    }

    // Safety check for formState.value
    if (!formState.value) {
        return <DefaultLoading locale={locale} variant="minimal" />;
    }

    const handleSave = async () => {
        if (!formState.value) return;

        setErrorMessage(null);
        setSuccessMessage(null);

        const packageIdsAsNumbers = formState.value.packageIds;

        const carouselForSave = formState.value.carousel.map(item => ({
            title: item.title,
            description: item.description,
            buttonText: item.buttonText,
            buttonUrl: item.buttonUrl,
            badge: item.badge,
            imageId: item.imageId ?? 0,
        }));

        try {
            await saveOffersPageMutation.mutateAsync({
                title: formState.value.title,
                description: formState.value.description,
                carousel: carouselForSave,
                packageIds: packageIdsAsNumbers,
            });
            // Refetch to get fresh data - useFormState will auto-sync when new data arrives
            await Promise.all([
                refetchOffersPageOutline(),
                refetchPackagesShort(),
                refetchPackages()
            ]);
        } catch (error) {
            // Error handled by useEffect
        }
    };

    // Form state is always initialized with either real data or default empty data
    // Safe to derive selected packages
    const selectedPackages = allPackages.filter(pkg => formState.value?.packageIds.includes(Number(pkg.id)));

    // Transform carousel items for CarouselSection component (needs image object format)
    const carouselItemsForComponent = (formState.value?.carousel || []).map(item => ({
        title: item.title,
        description: item.description,
        buttonText: item.buttonText,
        buttonUrl: item.buttonUrl,
        badge: item.badge,
        image: item.imageUrl && item.imageId ? {
            id: String(item.imageId),
            name: item.imageName || '',
            size: item.imageSize || 0,
            category: 'image' as const,
            downloadUrl: item.imageUrl
        } : null
    }));

    // Breadcrumbs following the standard pattern
    const breadcrumbItems = [
        {
            label: breadcrumbsTranslations('platforms'),
            onClick: () => router.push('/'),
        },
        {
            label: platform.name,
            onClick: () => router.push(`/platform/${platformSlug}/${platformLocale}`),
        },
        {
            label: breadcrumbsTranslations('manageOffersPage'),
            onClick: () => {
                // Nothing should happen on clicking the current page
            },
        },
    ];

    return (
        <div className="flex flex-col space-y-2 gap-4">
            <Breadcrumbs items={breadcrumbItems} />

            {/* Page header with translations */}
            <div className="flex flex-col space-y-2">
                <h1>{t('title')}</h1>
                <p className="text-text-secondary text-sm">
					{platformTranslations('platformLabel')} {platform.name} | {platformTranslations('contentLanguageLabel')} {contentLocale.toUpperCase()}
				</p>
            </div>

            <div className="sticky top-18 z-50 flex justify-end">
                <Button
                    onClick={handleSave}
                    disabled={saveOffersPageMutation.isPending || !formState.isDirty}
                    variant="primary"
                    size="medium"
                    text={saveOffersPageMutation.isPending ? t('savingBanner') : t('save')}
                    className='shadow-lg'
                />
            </div>

            {/* Success Banner */}
            {successMessage && (
                <Banner
                    title="Success!"
                    description={successMessage}
                    style="success"
                    closeable={true}
                    onClose={() => setSuccessMessage(null)}
                />
            )}

            {/* Error Message */}
            {errorMessage && (
                <FeedBackMessage
                    type="error"
                    message={errorMessage}
                />
            )}

            {/* Page Title Section */}
            <PageTitleSection
                value={{ title: formState.value.title, description: formState.value.description }}
                onChange={handlePageTitleChange}
                locale={locale}
            />

            {/* Packages Section */}
            <PackageSection
                packages={allPackages}
                linkedPackages={selectedPackages}
                onChange={handlePackagesChange}
                locale={locale}
            />

            {/* Carousel Section */}
            <CarouselSection
                value={carouselItemsForComponent}
                onChange={handleCarouselChange}
                onFileUpload={handleFileUpload}
                onFileDelete={handleFileDelete}
                onFileDownload={handleFileDownload}
                uploadType='upload_offers_page_carousel_card_image'
                locale={locale}
            />

        </div>
    );
}
