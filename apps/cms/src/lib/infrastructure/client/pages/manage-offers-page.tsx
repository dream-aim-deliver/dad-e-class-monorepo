'use client';

// Auto-generated by page-scaffold command v2
// Notion: https://www.notion.so/CMS-Manage-Offers-Page-22d5a7432d01809487b5f5592b2013f3
// Usecases: saveOffersPage, listPackages, requestFileUpload, getOffersPageOutline, listOffersPagePackagesShort
// User Types: CMS (admin/superadmin - enforced by middleware)
// Figma: https://www.figma.com/design/8KEwRuOoD5IgxTtFAtLlyS/Just_Do_Ad-1.2?node-id=8540-240257&t=qGirq2t6ka6iwg1A-4

import { useState, useEffect, useRef } from 'react';
import { DefaultLoading, DefaultError, Outline, PageTitleSection, PackageSection, CarouselSection, Banner } from '@maany_shr/e-class-ui-kit';
import { useLocale, useTranslations } from 'next-intl';
import { TLocale } from '@maany_shr/e-class-translations';
import { trpc } from '../trpc/cms-client';
import { useSession } from 'next-auth/react';

import { Button } from '@maany_shr/e-class-ui-kit';
import { viewModels } from '@maany_shr/e-class-models';
import { useListOffersPagePackagesShortPresenter } from '../hooks/use-list-offers-page-packages-short-presenter';
import { useListPackagesPresenter } from '../hooks/use-list-packages-presenter';
import { useGetOffersPageOutlinePresenter } from '../hooks/use-get-offers-page-outline-presenter';
import { useHomePageFileUpload } from './common/hooks/use-homepage-file-upload';
import { useFormState } from 'packages/ui-kit/lib/hooks/use-form-state';
interface ManageOffersPageProps {
    locale: string;
    platformSlug: string;
    platformLocale: string;
}

export default function ManageOffersPage({
    locale: _locale,
    platformSlug,
    platformLocale,
}: ManageOffersPageProps) {
    const locale = useLocale() as TLocale;
    const t = useTranslations('pages.manageOffersPage');

    // All hooks must be called at the top level before any conditional returns
    const [_uploadProgress, setUploadProgress] = useState<number | undefined>(undefined);
    const [saveStatus, setSaveStatus] = useState<'idle' | 'success' | 'error'>('idle');
    const [offersPageViewModel, setOffersPageViewModel] = useState<
        viewModels.TGetOffersPageOutlineViewModel | undefined
    >(undefined);
    const [packagesViewModel, setPackagesViewModel] = useState<
        viewModels.TListPackagesViewModel | undefined
    >(undefined);
    const [packagesShortViewModel, setPackagesShortViewModel] = useState<
        viewModels.TListOffersPagePackagesShortViewModel | undefined
    >(undefined);

    // Defensive client-side auth check (middleware already enforces admin/superadmin)
    const sessionDTO = useSession();
    const session = sessionDTO.data;
    const isAdmin = session?.user?.roles?.includes('admin') || session?.user?.roles?.includes('superadmin');

    // TRPC queries for page data - using EXACT usecase names from Notion
    const [offersPageOutlineResponse] = trpc.getOffersPageOutline.useSuspenseQuery({});
    const [packagesShortResponse] = trpc.listOffersPagePackagesShort.useSuspenseQuery({});
    const [packagesResponse] = trpc.listPackages.useSuspenseQuery({});

    const { presenter: manageOffersPagePresenter } = useGetOffersPageOutlinePresenter(setOffersPageViewModel);
    const { presenter: packagesPresenter } = useListPackagesPresenter(setPackagesViewModel);
    const { presenter: packagesShortPresenter } = useListOffersPagePackagesShortPresenter(setPackagesShortViewModel);

    const { handleFileUpload, handleFileDelete, handleFileDownload } = useHomePageFileUpload(setUploadProgress);

    // Extract data from view models
    const offersPageData = offersPageViewModel?.mode === 'default' ? offersPageViewModel.data : null;
    const packagesData = packagesViewModel?.mode === 'default' ? packagesViewModel.data : null;
    const packagesShortData = packagesShortViewModel?.mode === 'default' ? packagesShortViewModel.data : null;

    type CarouselItem = {
        title: string;
        description: string;
        buttonText: string;
        imageUrl: string | null;
        imageId: number | null;
        buttonUrl: string;
        badge?: string;
    };
    type OffersPageFormData = {
        title: string;
        description: string;
        packageIds: number[];
        carousel: CarouselItem[];
    };

    // Create default offers page data when it doesn't exist (for upsert functionality)
    const defaultOffersPageData: OffersPageFormData = {
        title: '',
        description: '',
        packageIds: [],
        carousel: [],
    };

    const allPackages = (packagesData?.packages || []).map(pkg => ({ ...pkg, id: String(pkg.id) }));
    const linkedPackageIds = (packagesShortData?.packageIds || []).map(String);
    const initialPackageIds = allPackages.filter((pkg) =>
        pkg.id != null && linkedPackageIds.includes(String(pkg.id))
    ).map(pkg => Number(pkg.id));

    // Use actual data if available (mode is 'default'), otherwise use default
    const initialFormData: OffersPageFormData = (offersPageViewModel?.mode === 'default' && packagesViewModel?.mode === 'default' && packagesShortViewModel?.mode === 'default')
        ? {
            title: offersPageData?.title || '',
            description: offersPageData?.description || '',
            packageIds: initialPackageIds,
            carousel: (offersPageData?.items || []).map(item => ({
                title: item.title,
                description: item.description,
                buttonText: item.buttonText,
                buttonUrl: item.buttonUrl,
                badge: item.badge ?? undefined,
                imageUrl: item.image?.downloadUrl ?? null,
                imageId: item.image?.id ? Number(item.image.id) : null,
            })),
        }
        : defaultOffersPageData;

    const formState = useFormState(initialFormData, { enableReloadProtection: true });
    const isInitializedRef = useRef(false);

    const saveOffersPageMutation = trpc.saveOffersPage.useMutation({
        onMutate: () => {
            setSaveStatus('idle');
        },
        onSuccess: (data) => {
            if (data.success) {
                formState.markAsSaved();
                setSaveStatus('success');
            }
        },
        onError: (error) => {
            setSaveStatus('error');
        },
    });

    // Present data on mount and when responses change
    useEffect(() => {
        // @ts-ignore
        packagesPresenter.present(packagesResponse, packagesViewModel);
        // @ts-ignore
        manageOffersPagePresenter.present(offersPageOutlineResponse, offersPageViewModel);
        // @ts-ignore
        packagesShortPresenter.present(packagesShortResponse, packagesShortViewModel);
    }, [offersPageOutlineResponse, packagesResponse, packagesShortResponse, manageOffersPagePresenter, packagesPresenter, packagesShortPresenter, offersPageViewModel, packagesViewModel, packagesShortViewModel]);

    // Update form state when data loads ONLY on initial load
    // Don't reset form after save to prevent showing stale data
    useEffect(() => {
        if (offersPageViewModel?.mode === 'default' && packagesViewModel?.mode === 'default' && packagesShortViewModel?.mode === 'default' && !isInitializedRef.current) {
            const loadedFormData: OffersPageFormData = {
                title: offersPageViewModel.data.title || '',
                description: offersPageViewModel.data.description || '',
                packageIds: initialPackageIds,
                carousel: (offersPageViewModel.data.items || []).map(item => ({
                    title: item.title,
                    description: item.description,
                    buttonText: item.buttonText,
                    buttonUrl: item.buttonUrl,
                    badge: item.badge ?? undefined,
                    imageUrl: item.image?.downloadUrl ?? null,
                    imageId: item.image?.id ? Number(item.image.id) : null,
                })),
            };
            formState.setValue(loadedFormData);
            isInitializedRef.current = true;
        }
    }, [offersPageViewModel?.mode, packagesViewModel?.mode, packagesShortViewModel?.mode]);

    // Now handle conditional rendering after all hooks are called
    // Error handling - only kaboom errors should prevent rendering
    // Note: 'not-found' is acceptable since save mutation supports upsert
    if (offersPageViewModel?.mode === 'kaboom' || packagesViewModel?.mode === 'kaboom' || packagesShortViewModel?.mode === 'kaboom') {
        return (
            <DefaultError
                locale={locale}
                title={t('error.title')}
                description={t('error.description')}
            />
        );
    }
    // Defensive auth check on client side
    if (!session || !isAdmin) {
        return (
            <DefaultError
                locale={locale}
                title={t('error.unauthorized.title')}
                description={t('error.unauthorized.description')}
            />
        );
    }

    // Loading state (defensive check)
    if (!offersPageOutlineResponse || !packagesShortResponse) {
        return <DefaultLoading locale={locale} variant="minimal" />;
    }

    // Derive selected packages from form state
    // (moved below the loading guard to avoid accessing null formState.value)


    const handleSave = async () => {
        setSaveStatus('idle');

        const packageIdsAsNumbers = formState.value.packageIds;

        const carouselForSave = formState.value.carousel.map(item => ({
            title: item.title,
            description: item.description,
            buttonText: item.buttonText,
            buttonUrl: item.buttonUrl,
            badge: item.badge,
            imageId: item.imageId ?? 0,
        }));

        await saveOffersPageMutation.mutateAsync({
            title: formState.value.title,
            description: formState.value.description,
            carousel: carouselForSave,
            packageIds: packageIdsAsNumbers,
        });

    };

    // Form state is always initialized with either real data or default empty data
    // Safe to derive selected packages
    const selectedPackages = allPackages.filter(pkg => formState.value.packageIds.includes(Number(pkg.id)));

    // Transform carousel items for CarouselSection component (needs image object format)
    const carouselItemsForComponent = formState.value.carousel.map(item => ({
        title: item.title,
        description: item.description,
        buttonText: item.buttonText,
        buttonUrl: item.buttonUrl,
        badge: item.badge ?? null,
        image: item.imageUrl && item.imageId ? {
            id: String(item.imageId),
            name: '',
            size: 0,
            category: 'image' as const,
            downloadUrl: item.imageUrl
        } : null
    }));

    return (
        <div className="flex flex-col space-y-5">
            {/* Page header with translations */}
            <div className="flex justify-between items-start">
                <div className="flex-1">
                    <Outline
                        title={t('title')}
                        description={t('description')}
                    />
                </div>
                <div className="ml-4">
                    <Button
                        variant="primary"
                        size="medium"
                        text="Save Offers Page"
                        onClick={handleSave}
                        disabled={saveOffersPageMutation.isPending}
                    />
                </div>
            </div>

            {saveOffersPageMutation.isPending && (
                <Banner style="success" title="Saving offers page changes..." />
            )}
            {saveStatus === 'success' && (
                <Banner style="success" title="Offers page saved successfully!" />
            )}
            {saveStatus === 'error' && (
                <Banner style="error" title="Failed to save offers page" />
            )}

            {/* Page Title Section */}
            <PageTitleSection
                value={{ title: formState.value.title, description: formState.value.description }}
                onChange={(newValue) => formState.setValue({ ...formState.value, title: newValue.title, description: newValue.description })}
            />

            {/* Packages Section */}
            <PackageSection
                packages={allPackages}
                linkedPackages={selectedPackages}
                onChange={(newSelected) => {
                    const newPackageIds = newSelected.map((pkg: any) => Number(pkg.id));
                    formState.setValue({ ...formState.value, packageIds: newPackageIds });
                }}
            />

            {/* Carousel Section */}
            <CarouselSection
                value={carouselItemsForComponent}
                onChange={(newCarousel) => {
                    // Transform back from image object format to imageUrl/imageId format
                    const transformedCarousel = newCarousel.map((item: {
                        title: string;
                        description: string;
                        buttonText: string;
                        buttonUrl: string;
                        badge?: string | null | undefined;
                        image: {id: string; name: string; size: number; category: 'image'; downloadUrl: string} | null;
                    }) => ({
                        title: item.title,
                        description: item.description,
                        buttonText: item.buttonText,
                        buttonUrl: item.buttonUrl,
                        badge: item.badge ?? undefined,
                        imageUrl: item.image?.downloadUrl ?? null,
                        imageId: item.image?.id ? Number(item.image.id) : null
                    }));
                    formState.setValue({ ...formState.value, carousel: transformedCarousel });
                }}
                onFileUpload={handleFileUpload}
                onFileDelete={handleFileDelete}
                onFileDownload={handleFileDownload}
                uploadType='upload_offers_page_carousel_card_image'
            />

        </div>
    );
}
