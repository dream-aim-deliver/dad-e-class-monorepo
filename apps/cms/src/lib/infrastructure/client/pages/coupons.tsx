'use client';

// Auto-generated by page-scaffold command v2
// Notion: https://www.notion.so/CMS-Coupons-26e5084127d642e0874bca1f789b5e68
// Usecases: listCoupons
// Features: FEAT-177: listCoupons
// API Endpoints:
// User Types: CMS (admin/superadmin)
// Figma: https://www.figma.com/design/8KEwRuOoD5IgxTtFAtLlyS/Just_Do_Ad-1.2?node-id=5127-27462

import { trpc } from '../trpc/cms-client';
import { useState, useRef } from 'react';
import { DefaultLoading, DefaultError, CouponGrid, Breadcrumbs } from '@maany_shr/e-class-ui-kit';
import { useLocale, useTranslations } from 'next-intl';
import { TLocale } from '@maany_shr/e-class-translations';
import { viewModels } from '@maany_shr/e-class-models';
import { useListCouponsPresenter } from '../hooks/use-list-coupons-presenter';
import { useRequiredPlatformLocale } from '../context/platform-locale-context';
import { useRequiredPlatform } from '../context/platform-context';
import { useRouter } from 'next/navigation';

interface CouponsProps {
  locale: string;
  platformSlug: string;
  platformLocale: string;
}

export default function Coupons({ platformSlug, platformLocale }: CouponsProps) {
  const locale = useLocale() as TLocale;
  const t = useTranslations('pages.coupons');
  const breadcrumbsTranslations = useTranslations('components.breadcrumbs');

  // Platform context
  const platformContext = useRequiredPlatformLocale();
  const { platform } = useRequiredPlatform();
  const router = useRouter();

  // Grid ref for AG Grid instance
  const gridRef = useRef<any>(null);

  // ViewModel state
  const [listCouponsViewModel, setListCouponsViewModel] = useState<
    viewModels.TListCouponsViewModel | undefined
  >(undefined);

  // Presenter hook
  const { presenter } = useListCouponsPresenter(setListCouponsViewModel);

  // TRPC query for page data
  const [couponsResponse] = trpc.listCoupons.useSuspenseQuery({
    // TODO: Add query parameters for the usecase
  });

  // Connect TRPC response to presenter
  // @ts-ignore
  presenter.present(couponsResponse, listCouponsViewModel);

  // Loading state
  if (!listCouponsViewModel) {
    return <DefaultLoading locale={locale} variant="minimal" />;
  }

  // Error handling
  if (listCouponsViewModel.mode === 'kaboom') {
    const errorData = listCouponsViewModel.data;
    console.error(errorData);
    return (
      <DefaultError
        locale={locale}
        title={t('error.kaboom.title')}
        description={t('error.kaboom.description')}
      />
    );
  }

  if (listCouponsViewModel.mode === 'not-found') {
    const errorData = listCouponsViewModel.data;
    console.error(errorData);
    return (
      <DefaultError
        locale={locale}
        title={t('error.notFound.title')}
        description={t('error.notFound.description')}
      />
    );
  }

  // Success state - extract data from ViewModel
  const couponsData = listCouponsViewModel.data;

  // Breadcrumbs following the standard pattern
  const breadcrumbItems = [
    {
      label: breadcrumbsTranslations('platforms'),
      onClick: () => router.push('/'),
    },
    {
      label: platform.name,
      onClick: () => {
        // TODO: Implement navigation to platform
      },
    },
    {
      label: breadcrumbsTranslations('coupons'),
      onClick: () => {
        // Nothing should happen on clicking the current page
      },
    },
  ];

  return (
    <div className="flex flex-col space-y-2 bg-card-fill p-5 border border-card-stroke rounded-medium gap-4 h-screen">
      <Breadcrumbs items={breadcrumbItems} />

      <div className="flex flex-col space-y-2">
        <h1>{t('title')}</h1>
        <p className="text-text-secondary text-sm">
          Platform: {platformContext.platformSlug} | Content Language: {platformLocale.toUpperCase()}
        </p>
      </div>

      {/* Coupons Grid */}
      <div className="flex flex-col grow bg-transparent">
        <CouponGrid
          gridRef={gridRef}
          coupons={couponsData.coupons}
          locale={locale}
          onRevokeCoupon={(couponId) => {
            // TODO: Implement revoke coupon functionality
            console.log('Revoke coupon:', couponId);
          }}
          onCreateCoupon={() => {
            // TODO: Implement create coupon functionality
            console.log('Create new coupon');
          }}
        />
      </div>
    </div>
  );
}
