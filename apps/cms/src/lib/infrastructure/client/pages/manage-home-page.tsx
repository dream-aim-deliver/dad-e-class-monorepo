'use client';

// Auto-generated by page-scaffold command
// Notion: https://www.notion.so/CMS-Manage-Homepage-13a5a7432d018034836ff1ff30ebf200
// Features: getHomePage, saveHomePage, requestFileUpload
// User Types: CMS
// Figma: https://www.figma.com/design/8KEwRuOoD5IgxTtFAtLlyS/Just_Do_Ad-1.2?node-id=5664-69581&t=GjW3V89mle6BrGgh-4

import { trpc } from '../trpc/cms-client';
import { useLocale, useTranslations } from 'next-intl';
import { useRouter } from 'next/navigation';

import {
	DefaultError,
	DefaultLoading,
	DefaultNotFound,
	Button,
	Tabs,
	Banner,
	IconSave,
	Breadcrumbs,
	FeedBackMessage
} from '@maany_shr/e-class-ui-kit';
import { viewModels } from '@maany_shr/e-class-models';
import { TLocale, getDictionary } from '@maany_shr/e-class-translations';
import { useEffect, useState, useMemo } from 'react';
import { useGetHomePagePresenter } from '../hooks/use-get-home-page-presenter';
import { useSaveHomePagePresenter } from '../hooks/use-save-home-page-presenter';
import { useContentLocale } from '../hooks/use-platform-translations';
import { useRequiredPlatformLocale } from '../context/platform-locale-context';
import { useRequiredPlatform } from '../context/platform-context';
import { HeroSection, CarouselSection, CoachingDemandSection, HowItWorksSection } from '@maany_shr/e-class-ui-kit';
import { useHomePageFileUpload } from './common/hooks/use-homepage-file-upload';
import { useHomePageVideoUpload } from './common/hooks/use-homepage-video-upload';
import { useFormState } from 'packages/ui-kit/lib/hooks/use-form-state';

// Static default data - moved outside component for better performance
const DEFAULT_HOME_PAGE_DATA: viewModels.TGetHomePageSuccess = {
	banner: {
		title: '',
		description: '',
		video: null,
		thumbnailImage: null,
	},
	carousel: [],
	coachingOnDemand: {
		title: '',
		description: '',
		desktopImage: null,
		tabletImage: null,
		mobileImage: null,
	},
	accordion: {
		title: '',
		showNumbers: true,
		items: [],
	},
} as const;

/**
 * ManageHomepage component for CMS
 * Allows admins to manage the homepage content including:
 * - Banner with title, description, video, and thumbnail
 * - Carousel items with text, images, buttons, and badges
 * - Coaching On Demand section
 * - Accordion section
 */
export default function ManageHomepage() {
	// TRPC utils for query invalidation
	const utils = trpc.useUtils();

	// App locale - used for UI elements
	const appLocale = useLocale() as TLocale;

	// Translations for this page
	const t = useTranslations('pages.manageHomePage');
	const platformTranslations = useTranslations('pages.managePagesGeneral');
	const breadcrumbsTranslations = useTranslations('components.breadcrumbs');
	const router = useRouter();

	// Platform context
	const platformContext = useRequiredPlatformLocale();
	const { platform } = useRequiredPlatform();
	const contentLocale = useContentLocale();

	// Fetch homepage data (refetch retained for future integration)
	const [getHomePageResponse, { refetch: refetchHomePage }] = trpc.getHomePage.useSuspenseQuery(
		{},
		{
			refetchOnWindowFocus: false,
		}
	);
	const [homePageViewModel, setHomePageViewModel] = useState<
		viewModels.TGetHomePageViewModel | undefined
	>(undefined);

	const { presenter: homePagePresenter } = useGetHomePagePresenter(setHomePageViewModel);

	// Present the data when it changes (moved to useEffect to avoid side effects during render)
	useEffect(() => {
		// @ts-ignore - Presenter doesn't handle progress states
		homePagePresenter.present(getHomePageResponse, homePageViewModel);
	}, [getHomePageResponse, homePagePresenter]);

	// Track upload progress
	const [uploadProgress, setUploadProgress] = useState<number | undefined>(undefined);
	const [videoUploadProgress, setVideoUploadProgress] = useState<number | undefined>(undefined);


	// Save mutation
	const saveHomePageMutation = trpc.saveHomePage.useMutation();
	const [saveViewModel, setSaveViewModel] = useState<
		viewModels.TSaveHomePageViewModel | undefined
	>(undefined);

	// Mutation presenter
	const { presenter: savePresenter } = useSaveHomePagePresenter(setSaveViewModel);

	// Error and success message state
	const [errorMessage, setErrorMessage] = useState<string | null>(null);
	const [successMessage, setSuccessMessage] = useState<string | null>(null);

	useEffect(() => {
		if (saveHomePageMutation.isSuccess && saveHomePageMutation.data) {
			// @ts-ignore
			savePresenter.present(saveHomePageMutation.data, saveViewModel);
		}
	}, [saveHomePageMutation.isSuccess, saveHomePageMutation.data, savePresenter, saveViewModel]);

	useEffect(() => {
		if (
			saveHomePageMutation.isSuccess &&
			saveViewModel?.mode === 'default'
		) {
			// Success case
			setErrorMessage(null);
			setSuccessMessage('Home page content saved successfully!');
			// Auto-dismiss success message after 5 seconds
			const timer = setTimeout(() => setSuccessMessage(null), 5000);
			return () => clearTimeout(timer);
		}
		// Handle kaboom and other error modes
		if (
			saveHomePageMutation.isSuccess &&
			saveViewModel?.mode === 'kaboom'
		) {
			setErrorMessage(
				'Failed to save home page content. Please try again.'
			);
			setSuccessMessage(null);
		}
	}, [saveViewModel, saveHomePageMutation.isSuccess]);

	useEffect(() => {
		if (saveHomePageMutation.isError) {
			setErrorMessage(
				saveHomePageMutation.error?.message ||
				'Failed to save home page content. Please try again.'
			);
			setSuccessMessage(null);
		}
	}, [saveHomePageMutation.isError, saveHomePageMutation.error]);

	const { handleFileUpload, handleFileDelete, handleFileDownload } = useHomePageFileUpload(setUploadProgress);
	const videoUpload = useHomePageVideoUpload(setVideoUploadProgress);

	const initialHomePageData = useMemo(() => {
		if (homePageViewModel?.mode !== 'default') {
			return DEFAULT_HOME_PAGE_DATA;
		}

		// Transform backend data to frontend format
		const backendData = homePageViewModel.data;

		return {
			banner: {
				title: backendData.banner.title,
				description: backendData.banner.description,
				// Transform video: map downloadUrl→url, playbackId→videoId, add status
				video: backendData.banner.video
					? {
						...backendData.banner.video,
						url: backendData.banner.video.downloadUrl,
						thumbnailUrl: backendData.banner.video.thumbnailUrl || backendData.banner.video.downloadUrl,
						videoId: backendData.banner.video.playbackId || null,
						status: 'available' as const,
					}
					: null,
				// Transform thumbnail image: map downloadUrl→url and thumbnailUrl
				thumbnailImage: backendData.banner.thumbnailImage
					? {
						...backendData.banner.thumbnailImage,
						url: backendData.banner.thumbnailImage.downloadUrl,
						thumbnailUrl: backendData.banner.thumbnailImage.downloadUrl,
						status: 'available' as const,
					}
					: null,
			},
			carousel: backendData.carousel.map(item => ({
				...item,
				image: item.image
					? {
						...item.image,
						url: item.image.downloadUrl,
						thumbnailUrl: item.image.downloadUrl,
						status: 'available' as const,
					}
					: null,
			})),
			coachingOnDemand: {
				title: backendData.coachingOnDemand.title,
				description: backendData.coachingOnDemand.description,
				desktopImage: backendData.coachingOnDemand.desktopImage
					? {
						...backendData.coachingOnDemand.desktopImage,
						url: backendData.coachingOnDemand.desktopImage.downloadUrl,
						thumbnailUrl: backendData.coachingOnDemand.desktopImage.downloadUrl,
						status: 'available' as const,
					}
					: null,
				tabletImage: backendData.coachingOnDemand.tabletImage
					? {
						...backendData.coachingOnDemand.tabletImage,
						url: backendData.coachingOnDemand.tabletImage.downloadUrl,
						thumbnailUrl: backendData.coachingOnDemand.tabletImage.downloadUrl,
						status: 'available' as const,
					}
					: null,
				mobileImage: backendData.coachingOnDemand.mobileImage
					? {
						...backendData.coachingOnDemand.mobileImage,
						url: backendData.coachingOnDemand.mobileImage.downloadUrl,
						thumbnailUrl: backendData.coachingOnDemand.mobileImage.downloadUrl,
						status: 'available' as const,
					}
					: null,
			},
			accordion: {
				title: backendData.accordion.title,
				showNumbers: backendData.accordion.showNumbers,
				items: backendData.accordion.items.map(item => ({
					...item,
					iconImage: item.iconImage
						? {
							...item.iconImage,
							url: item.iconImage.downloadUrl,
							thumbnailUrl: item.iconImage.downloadUrl,
							status: 'available' as const,
						}
						: null,
				})),
			},
		} as viewModels.TGetHomePageSuccess;
	}, [homePageViewModel]);

	const formState = useFormState<viewModels.TGetHomePageSuccess>(initialHomePageData, { enableReloadProtection: true });
	const { setValue: setFormValue } = formState;

	const handleBannerChange = (banner: viewModels.TGetHomePageSuccess['banner']) => {
		setFormValue((prev: viewModels.TGetHomePageSuccess | null) => {
			if (!prev) return prev;
			return {
				...prev,
				banner,
			};
		});
	};

	const handleCarouselChange = (carousel: viewModels.TGetHomePageSuccess['carousel']) => {
		setFormValue((prev: viewModels.TGetHomePageSuccess | null) => {
			if (!prev) return prev;
			return {
				...prev,
				carousel,
			};
		});
	};

	const handleCoachingDemandChange = (coachingOnDemand: viewModels.TGetHomePageSuccess['coachingOnDemand']) => {
		setFormValue((prev: viewModels.TGetHomePageSuccess | null) => {
			if (!prev) return prev;
			return {
				...prev,
				coachingOnDemand,
			};
		});
	};

	const handleAccordionChange = (accordion: viewModels.TGetHomePageSuccess['accordion']) => {
		setFormValue((prev: viewModels.TGetHomePageSuccess | null) => {
			if (!prev) return prev;
			return {
				...prev,
				accordion,
			};
		});
	};


	// All hooks must be called before any conditional returns
	if (!homePageViewModel) {
		return <DefaultLoading locale={appLocale} variant="minimal" />;
	}

	// Error handling - only kaboom errors should prevent rendering
	// Note: 'not-found' is acceptable since save mutation supports upsert
	if (homePageViewModel.mode === 'kaboom') {
		const dictionary = getDictionary(appLocale);
		return (
			<DefaultError
				type="simple"
				locale={appLocale}
				title={dictionary.components.defaultError.title}
				description={dictionary.components.defaultError.description}
				onRetry={() => {
					refetchHomePage();
				}}
			/>
		);
	}

	// Single state for all homepage data - ensure it's defined before proceeding
	if (!formState.value) {
		return <DefaultLoading locale={appLocale} variant="minimal" />;
	}

	const editableHomePageData: viewModels.TGetHomePageSuccess = formState.value;

	const handleSaveHomePage = async () => {
		setErrorMessage(null);
		setSuccessMessage(null);

		try {
			await saveHomePageMutation.mutateAsync({
				banner: {
					title: editableHomePageData.banner.title,
					description: editableHomePageData.banner.description,
					videoId: editableHomePageData.banner.video?.id ? Number(editableHomePageData.banner.video.id) : null,
					thumbnailImageId: editableHomePageData.banner.thumbnailImage?.id ? Number(editableHomePageData.banner.thumbnailImage.id) : null,
				},
				carousel: editableHomePageData.carousel.map(item => ({
					title: item.title,
					description: item.description,
					buttonText: item.buttonText,
					buttonUrl: item.buttonUrl,
					badge: item.badge,
					imageId: item.image?.id ? Number(item.image.id) : null,
				})),
				coachingOnDemand: {
					title: editableHomePageData.coachingOnDemand.title,
					description: editableHomePageData.coachingOnDemand.description,
					desktopImageId: editableHomePageData.coachingOnDemand.desktopImage?.id ? Number(editableHomePageData.coachingOnDemand.desktopImage.id) : null,
					tabletImageId: editableHomePageData.coachingOnDemand.tabletImage?.id ? Number(editableHomePageData.coachingOnDemand.tabletImage.id) : null,
					mobileImageId: editableHomePageData.coachingOnDemand.mobileImage?.id ? Number(editableHomePageData.coachingOnDemand.mobileImage.id) : null,
				},
				accordion: {
					title: editableHomePageData.accordion.title,
					showNumbers: editableHomePageData.accordion.showNumbers,
					items: editableHomePageData.accordion.items.map(item => ({
						title: item.title,
						content: item.content,
						position: item.position,
						iconImageId: item.iconImage?.id ? Number(item.iconImage.id) : null,
					})),
				},
			});
			// Invalidate query to trigger refetch - useFormState will auto-sync when new data arrives
			await utils.getHomePage.invalidate();
		} catch (error) {
			// Error handled by useEffect
		}
	};

	// Breadcrumbs following the standard pattern
	const breadcrumbItems = [
		{
			label: breadcrumbsTranslations('platforms'),
			onClick: () => router.push('/'),
		},
		{
			label: platform.name,
			onClick: () => {
				router.push(`/${appLocale}/platform/${platformContext.platformSlug}/${platformContext.platformLocale}`);
			},
		},
		{
			label: breadcrumbsTranslations('homePage'),
			onClick: () => {
				// Nothing should happen on clicking the current page
			},
		},
	];

	return (
		<div className="flex flex-col space-y-2 gap-4">
			<Breadcrumbs items={breadcrumbItems} />

			{/* Page header with translations */}
			<div className="flex flex-col space-y-2">
				<h1>{t('title')}</h1>
				<p className="text-text-secondary text-sm">
					{platformTranslations('platformLabel')} {platform.name} | {platformTranslations('contentLanguageLabel')} {contentLocale.toUpperCase()}
				</p>
			</div>

			<div className="sticky top-18 z-50 flex justify-end">
				<Button
					onClick={handleSaveHomePage}
					disabled={saveHomePageMutation.isPending || !formState.isDirty}
					variant="primary"
					size="medium"
					text={saveHomePageMutation.isPending ? t('savingBanner') : t('save')}
					className='shadow-lg'
				/>
			</div>

			{/* Success Banner */}
			{successMessage && (
				<Banner
					title="Success!"
					description={successMessage}
					style="success"
					closeable={true}
					onClose={() => setSuccessMessage(null)}
				/>
			)}

			{/* Error Message */}
			{errorMessage && (
				<FeedBackMessage
					type="error"
					message={errorMessage}
				/>
			)}

			{/* Tabs for Homepage Sections */}
			<Tabs.Root defaultTab="hero" className="w-full">
				<Tabs.List variant="default">
					<Tabs.Trigger value="hero" isLast={false}>
						{t('tabs.hero')}
					</Tabs.Trigger>
					<Tabs.Trigger value="carousel" isLast={false}>
						{t('tabs.carousel')}
					</Tabs.Trigger>
					<Tabs.Trigger value="coaching" isLast={false}>
						{t('tabs.coaching')}
					</Tabs.Trigger>
					<Tabs.Trigger value="accordion" isLast={true}>
						{t('tabs.accordion')}
					</Tabs.Trigger>
				</Tabs.List>

				<div className="mt-6">
					<Tabs.Content value="hero">
						<HeroSection
							value={editableHomePageData.banner}
							onChange={handleBannerChange}
							onFileUpload={handleFileUpload}
							onVideoUpload={videoUpload.handleFileChange}
							onFileDelete={handleFileDelete}
							onFileDownload={handleFileDownload}
							uploadProgress={uploadProgress}
							videoUploadProgress={videoUploadProgress}
							locale={appLocale}
						/>
					</Tabs.Content>

					<Tabs.Content value="carousel">
						<CarouselSection
							value={editableHomePageData.carousel}
							onChange={handleCarouselChange}
							onFileUpload={handleFileUpload}
							onFileDelete={handleFileDelete}
							onFileDownload={handleFileDownload}
							uploadProgress={uploadProgress}
							uploadType='upload_home_page_carousel_item_image'
							locale={appLocale}
						/>
					</Tabs.Content>

					<Tabs.Content value="coaching">
						<CoachingDemandSection
							value={editableHomePageData.coachingOnDemand}
							onChange={handleCoachingDemandChange}
							onFileUpload={handleFileUpload}
							onFileDelete={handleFileDelete}
							onFileDownload={handleFileDownload}
							uploadProgress={uploadProgress}
							locale={appLocale}
						/>
					</Tabs.Content>

					<Tabs.Content value="accordion">
						<HowItWorksSection
							value={editableHomePageData.accordion}
							onChange={handleAccordionChange}
							onFileUpload={handleFileUpload}
							onFileDelete={handleFileDelete}
							onFileDownload={handleFileDownload}
							uploadProgress={uploadProgress}
							locale={appLocale}
						/>
					</Tabs.Content>
				</div>
			</Tabs.Root>
		</div >
	);
}
