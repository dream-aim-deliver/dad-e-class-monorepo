'use client';

// Auto-generated by page-scaffold command
// Notion: https://www.notion.so/CMS-Manage-Homepage-13a5a7432d018034836ff1ff30ebf200
// Features: getHomePage, saveHomePage, requestFileUpload
// User Types: CMS
// Figma: https://www.figma.com/design/8KEwRuOoD5IgxTtFAtLlyS/Just_Do_Ad-1.2?node-id=5664-69581&t=GjW3V89mle6BrGgh-4

import { trpc } from '../trpc/cms-client';
import { useLocale, useTranslations } from 'next-intl';

import {
	DefaultError,
	DefaultLoading,
	DefaultNotFound,
	Button,
	Tabs,
	Banner
} from '@maany_shr/e-class-ui-kit';
import { viewModels } from '@maany_shr/e-class-models';
import { TLocale } from '@maany_shr/e-class-translations';
import { useEffect, useState, useMemo } from 'react';
import { useGetHomePagePresenter } from '../hooks/use-get-home-page-presenter';
import { useContentLocale } from '../hooks/use-platform-translations';
import { useRequiredPlatformLocale } from '../context/platform-locale-context';
import { HeroSection, CarouselSection, CoachingDemandSection, HowItWorksSection } from '@maany_shr/e-class-ui-kit';
import { useHomePageFileUpload } from './common/hooks/use-homepage-file-upload';
import { useHomePageVideoUpload } from './common/hooks/use-homepage-video-upload';
import { useFormState } from 'packages/ui-kit/lib/hooks/use-form-state';

// Static default data - moved outside component for better performance
const DEFAULT_HOME_PAGE_DATA: viewModels.TGetHomePageSuccess = {
	banner: {
		title: '',
		description: '',
		video: null,
		thumbnailImage: null,
	},
	carousel: [],
	coachingOnDemand: {
		title: '',
		description: '',
		desktopImage: null,
		tabletImage: null,
		mobileImage: null,
	},
	accordion: {
		title: '',
		showNumbers: true,
		items: [],
	},
} as const;

/**
 * ManageHomepage component for CMS
 * Allows admins to manage the homepage content including:
 * - Banner with title, description, video, and thumbnail
 * - Carousel items with text, images, buttons, and badges
 * - Coaching On Demand section
 * - Accordion section
 */
export default function ManageHomepage() {
	// App locale - used for UI elements
	const appLocale = useLocale() as TLocale;

	// Translations for this page
	const t = useTranslations('pages.manageHomePage');

	// Platform context
	const platformContext = useRequiredPlatformLocale();
	const contentLocale = useContentLocale();

	// Fetch homepage data (refetch retained for future integration)
	const [getHomePageResponse, { refetch: refetchHomePage }] = trpc.getHomePage.useSuspenseQuery({});
	const [homePageViewModel, setHomePageViewModel] = useState<
		viewModels.TGetHomePageViewModel | undefined
	>(undefined);

	const { presenter: homePagePresenter } = useGetHomePagePresenter(setHomePageViewModel);

	// Present the data when it changes (moved to useEffect to avoid side effects during render)
	useEffect(() => {
		// @ts-ignore - Presenter doesn't handle progress states
		homePagePresenter.present(getHomePageResponse, homePageViewModel);
	}, [getHomePageResponse, homePagePresenter, homePageViewModel]);

	// Track upload progress
	const [uploadProgress, setUploadProgress] = useState<number | undefined>(undefined);
	const [videoUploadProgress, setVideoUploadProgress] = useState<number | undefined>(undefined);


	const [saveState, setSaveState] = useState<{
		status: 'idle' | 'success' | 'error';
		message: string | null;
	}>({ status: 'idle', message: null });

	const { handleFileUpload, handleFileDelete, handleFileDownload } = useHomePageFileUpload(setUploadProgress);
	const videoUpload = useHomePageVideoUpload(setVideoUploadProgress);

	const initialHomePageData = useMemo(() =>
		homePageViewModel?.mode === 'default'
			? homePageViewModel.data
			: DEFAULT_HOME_PAGE_DATA,
		[homePageViewModel]
	);

	const formState = useFormState<viewModels.TGetHomePageSuccess>(initialHomePageData, { enableReloadProtection: true });
	const { setValue: setFormValue } = formState;


	useEffect(() => {
		if (homePageViewModel?.mode === 'default') {
			setFormValue(homePageViewModel.data);
		}
	}, [homePageViewModel?.mode, homePageViewModel?.data, setFormValue]);

	// Define all callbacks before any conditional returns (Rules of Hooks)
	const handleBannerChange = (banner: viewModels.TGetHomePageSuccess['banner']) => {
		console.log('Banner changed:', banner);
		setFormValue((prev: viewModels.TGetHomePageSuccess | null) => ({
			...prev!,
			banner,
		}));
	};

	const handleCarouselChange = (carousel: viewModels.TGetHomePageSuccess['carousel']) => {
		console.log('Carousel changed:', carousel);
		setFormValue((prev: viewModels.TGetHomePageSuccess | null) => ({
			...prev!,
			carousel,
		}));
	};

	const handleCoachingDemandChange = (coachingOnDemand: viewModels.TGetHomePageSuccess['coachingOnDemand']) => {
		console.log('Coaching On Demand changed:', coachingOnDemand);
		setFormValue((prev: viewModels.TGetHomePageSuccess | null) => ({
			...prev!,
			coachingOnDemand,
		}));
	};

	const handleAccordionChange = (accordion: viewModels.TGetHomePageSuccess['accordion']) => {
		console.log(accordion);
		setFormValue((prev: viewModels.TGetHomePageSuccess | null) => ({
			...prev!,
			accordion,
		}));
	};

	const saveHomePageMutation = trpc.saveHomePage.useMutation({
		onSuccess: (data) => {
			if (data.success) {
				setSaveState({ status: 'success', message: t('savedBanner') });
				formState.markAsSaved();
			} else {
				setSaveState({ status: 'error', message: t('failedBanner') });
			}
		},
		onError: (error) => {
			setSaveState({ status: 'error', message: error.message ?? t('failedBanner') });
			console.error('Error saving homepage:', error);
		},

	});

	// All hooks must be called before any conditional returns
	if (!homePageViewModel) {
		return <DefaultLoading locale={appLocale} variant="minimal" />;
	}

	// Error handling - only kaboom errors should prevent rendering
	// Note: 'not-found' is acceptable since save mutation supports upsert
	if (homePageViewModel.mode === 'kaboom') {
		return (
			<DefaultError
				locale={appLocale}
				onRetry={() => {
					refetchHomePage();
				}}
			/>
		);
	}

	// Single state for all homepage data - ensure it's defined before proceeding
	if (!formState.value) {
		return <DefaultLoading locale={appLocale} variant="minimal" />;
	}

	const editableHomePageData: viewModels.TGetHomePageSuccess = formState.value;

	const handleSaveHomePage = () => {
		setSaveState({ status: 'idle', message: null });

		saveHomePageMutation.mutate({
			banner: {
				title: editableHomePageData.banner.title,
				description: editableHomePageData.banner.description,
				videoId: editableHomePageData.banner.video?.id ? Number(editableHomePageData.banner.video.id) : null,
				thumbnailImageId: editableHomePageData.banner.thumbnailImage?.id ? Number(editableHomePageData.banner.thumbnailImage.id) : null,
			},
			carousel: editableHomePageData.carousel.map(item => ({
				title: item.title,
				description: item.description,
				buttonText: item.buttonText,
				buttonUrl: item.buttonUrl,
				badge: item.badge,
				imageId: item.image?.id ? Number(item.image.id) : null,
			})),
			coachingOnDemand: {
				title: editableHomePageData.coachingOnDemand.title,
				description: editableHomePageData.coachingOnDemand.description,
				desktopImageId: editableHomePageData.coachingOnDemand.desktopImage?.id ? Number(editableHomePageData.coachingOnDemand.desktopImage.id) : null,
				tabletImageId: editableHomePageData.coachingOnDemand.tabletImage?.id ? Number(editableHomePageData.coachingOnDemand.tabletImage.id) : null,
				mobileImageId: editableHomePageData.coachingOnDemand.mobileImage?.id ? Number(editableHomePageData.coachingOnDemand.mobileImage.id) : null,
			},
			accordion: {
				title: editableHomePageData.accordion.title,
				showNumbers: editableHomePageData.accordion.showNumbers,
				items: editableHomePageData.accordion.items.map(item => ({
					title: item.title,
					content: item.content,
					position: item.position,
					iconImageId: item.iconImage?.id ? Number(item.iconImage.id) : null,
				})),
			},
		});
	};

	return (
		<div className="flex flex-col space-y-6 p-6 max-w-7xl mx-auto">
			{/* Page Header */}
			<div className="bg-gradient-to-r from-primary-500 to-primary-600 text-white p-6 rounded-lg shadow-lg">
				<div className="flex justify-between items-center">
					<div>
						<h1 className="text-3xl font-bold mb-2">{t('title')}</h1>
						<p className="text-lg opacity-90">
							Platform: {platformContext.platformSlug} | Content Language: {contentLocale.toUpperCase()}
						</p>
					</div>
					<Button
						variant="primary"
						size="medium"
						text={t('save')}
						onClick={handleSaveHomePage}
						disabled={saveHomePageMutation.isPending || !formState.isDirty}

					/>
				</div>
			</div>

			{saveHomePageMutation.isPending && (
				<Banner style="success" title={t('savingBanner')} />

			)}
			{saveState.status === 'success' && saveState.message && (
				<Banner style="success" title={saveState.message} />
			)
			}
			{
				saveState.status === 'error' && saveState.message && (
					<Banner style="error" title={saveState.message} />
				)
			}

			{/* Tabs for Homepage Sections */}
			<Tabs.Root defaultTab="hero" className="w-full">
				<Tabs.List variant="default">
					<Tabs.Trigger value="hero" isLast={false}>
						{t('tabs.hero')}
					</Tabs.Trigger>
					<Tabs.Trigger value="carousel" isLast={false}>
						{t('tabs.carousel')}
					</Tabs.Trigger>
					<Tabs.Trigger value="coaching" isLast={false}>
						{t('tabs.coaching')}
					</Tabs.Trigger>
					<Tabs.Trigger value="accordion" isLast={true}>
						{t('tabs.accordion')}
					</Tabs.Trigger>
				</Tabs.List>

				<div className="mt-6">
					<Tabs.Content value="hero">
						<HeroSection
							value={editableHomePageData.banner}
							onChange={handleBannerChange}
							onFileUpload={handleFileUpload}
							onVideoUpload={videoUpload.handleFileChange}
							onFileDelete={handleFileDelete}
							onFileDownload={handleFileDownload}
							uploadProgress={uploadProgress}
							videoUploadProgress={videoUploadProgress}
							locale={appLocale}
						/>
					</Tabs.Content>

					<Tabs.Content value="carousel">
						<CarouselSection
							value={editableHomePageData.carousel.map(item => ({ ...item, badge: item.badge ?? undefined }))}
							onChange={handleCarouselChange}
							onFileUpload={handleFileUpload}
							onFileDelete={handleFileDelete}
							onFileDownload={handleFileDownload}
							uploadProgress={uploadProgress}
							uploadType='upload_home_page_carousel_item_image'
							locale={appLocale}
						/>
					</Tabs.Content>

					<Tabs.Content value="coaching">
						<CoachingDemandSection
							value={editableHomePageData.coachingOnDemand}
							onChange={handleCoachingDemandChange}
							onFileUpload={handleFileUpload}
							onFileDelete={handleFileDelete}
							onFileDownload={handleFileDownload}
							uploadProgress={uploadProgress}
							locale={appLocale}
						/>
					</Tabs.Content>

					<Tabs.Content value="accordion">
						<HowItWorksSection
							value={editableHomePageData.accordion}
							onChange={handleAccordionChange}
							onFileUpload={handleFileUpload}
							onFileDelete={handleFileDelete}
							onFileDownload={handleFileDownload}
							uploadProgress={uploadProgress}
							locale={appLocale}
						/>
					</Tabs.Content>
				</div>
			</Tabs.Root>
		</div >
	);
}
