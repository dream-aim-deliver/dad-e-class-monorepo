'use client';

// Auto-generated by page-scaffold command v2
// Notion: https://www.notion.so/CMS-Manage-Legal-Texts-5f461ddb9426476aa3816c88dea1ec9e
// Usecases from Notion: getPlatformLanguage, savePlatformLanguageLegalTexts
// Features from Notion: FEAT-87 (getPlatformLanguage), FEAT-215 (savePlatformLanguageLegalTexts)
// User Types from Notion: CMS
// Comments from Notion:
// upsert:
// impressum_content: str | None = None
// privacy_policy_content: str | None = None
// terms_of_use: str | None = None
// for the given platformLanguage
// â‡’ With a tab for each

import { useLocale, useTranslations } from 'next-intl';
import { TLocale } from '@maany_shr/e-class-translations';
import { trpc } from '../trpc/cms-client';
import { useEffect, useState, useRef } from 'react';
import { Button, Tabs, Banner, DefaultLoading, DefaultError, RichTextDesignerComponent, RichTextElement, FormElementType, Breadcrumbs } from '@maany_shr/e-class-ui-kit';
import { useRequiredPlatformLocale } from '../context/platform-locale-context';
import { useRequiredPlatform } from '../context/platform-context';
import { useContentLocale } from '../hooks/use-platform-translations';
import { viewModels } from '@maany_shr/e-class-models';
import { useGetPlatformLanguagePresenter } from '../hooks/use-platform-language-presenter';
import { useRouter } from 'next/navigation';

interface LegalTextsData {
  impressumContent: string;
  privacyPolicyContent: string;
  termsOfUseContent: string;
}

interface ManageLegalTextsProps {
  initialTab?: string;
}

export default function ManageLegalTexts({ initialTab }: ManageLegalTextsProps) {
  const t = useTranslations('pages.manageLegalTexts');
  const currentLocale = useLocale() as TLocale;
  const router = useRouter();
  const breadcrumbsTranslations = useTranslations('components.breadcrumbs');

  // Platform context
  const platformContext = useRequiredPlatformLocale();
  const { platform } = useRequiredPlatform();
  const contentLocale = useContentLocale();

  // Fetch platform language data
  const [getPlatformLanguageResponse, { refetch: refetchPlatformLanguage }] = trpc.getPlatformLanguage.useSuspenseQuery({});

  const [platformLanguageViewModel, setPlatformLanguageViewModel] = useState<
    viewModels.TPlatformLanguageViewModel | undefined
  >(undefined);

  // Query presenter
  const { presenter: platformLanguagePresenter } = useGetPlatformLanguagePresenter(
    setPlatformLanguageViewModel,
  );

  // @ts-ignore
  platformLanguagePresenter.present(getPlatformLanguageResponse, platformLanguageViewModel);

  // State for each legal text field - just like ManageAboutPage
  const [impressumContent, setImpressumContent] = useState<string>('');
  const [privacyPolicyContent, setPrivacyPolicyContent] = useState<string>('');
  const [termsOfUseContent, setTermsOfUseContent] = useState<string>('');
  const [rulesContent, setRulesContent] = useState<string>('');
  const [offerInformationContent, setOfferInformationContent] = useState<string>('');
  const [isContentInitialized, setIsContentInitialized] = useState(false);

  // Track the locale for which data was loaded to prevent race conditions
  const loadedForLocaleRef = useRef<string>('');
  const lastDataHashRef = useRef<string>('');

  // Track update counter to force remount when data changes
  const [updateCounter, setUpdateCounter] = useState(0);

  // Initialize content state from fetched data for saving later
  // Update whenever the data actually changes (detected by content hash)
  useEffect(() => {
    if (
      platformLanguageViewModel?.mode === 'default' &&
      platformLanguageViewModel.data
    ) {
      // Create a hash of the content to detect actual data changes
      const dataHash = (platformLanguageViewModel.data.impressumContent || '').substring(0, 100);

      console.log('[ManageLegalTexts] State update check:', {
        currentLocale: contentLocale,
        loadedFor: loadedForLocaleRef.current,
        lastHash: lastDataHashRef.current.substring(0, 30),
        currentHash: dataHash.substring(0, 30),
        hashChanged: lastDataHashRef.current !== dataHash,
        localeChanged: loadedForLocaleRef.current !== contentLocale,
        willUpdate: lastDataHashRef.current !== dataHash || loadedForLocaleRef.current !== contentLocale,
      });

      // Only update if the data hash actually changed OR we haven't loaded for this locale yet
      if (lastDataHashRef.current !== dataHash || loadedForLocaleRef.current !== contentLocale) {
        console.log('[ManageLegalTexts] UPDATING STATE - data changed for locale:', contentLocale);
        console.log('[ManageLegalTexts] Setting impressumContent to:', (platformLanguageViewModel.data.impressumContent || '').substring(0, 50));
        setImpressumContent(platformLanguageViewModel.data.impressumContent || '');
        setPrivacyPolicyContent(platformLanguageViewModel.data.privacyPolicyContent || '');
        setTermsOfUseContent(platformLanguageViewModel.data.termsOfUseContent || '');
        setRulesContent(platformLanguageViewModel.data.rules || '');
        setOfferInformationContent(platformLanguageViewModel.data.offerInformation || '');
        loadedForLocaleRef.current = contentLocale;
        lastDataHashRef.current = dataHash;
        setIsContentInitialized(true);
        // Increment counter to force remount of RichTextDesignerComponent
        setUpdateCounter(prev => prev + 1);
      }
    }
  }, [platformLanguageViewModel, contentLocale]);

  // When content locale changes, just refetch - the first useEffect will handle state updates
  useEffect(() => {
    if (loadedForLocaleRef.current && loadedForLocaleRef.current !== contentLocale) {
      console.log('[ManageLegalTexts] Locale changed from', loadedForLocaleRef.current, 'to', contentLocale, '- refetching');
      refetchPlatformLanguage();
    }
  }, [contentLocale]);

  // Save mutation
  const saveLegalTextsMutation = trpc.savePlatformLanguageLegalTexts.useMutation();

  const handleSave = () => {
    saveLegalTextsMutation.mutate({
      impressumContent,
      privacyPolicyContent,
      termsOfUse: termsOfUseContent,
      rules: rulesContent,
      offerInformation: offerInformationContent,
    });
  };

  if (platformLanguageViewModel?.mode === 'kaboom') {
    return (
      <DefaultError
        locale={currentLocale}
        onRetry={() => refetchPlatformLanguage()}
      />
    );
  }

  // Loading state - show loading animation while data is being fetched
  if (!platformLanguageViewModel) {
    return <DefaultLoading locale={currentLocale} variant="minimal" />;
  }

  // Breadcrumbs following the standard pattern
  const breadcrumbItems = [
    {
      label: breadcrumbsTranslations('platforms'),
      onClick: () => router.push('/'),
    },
    {
      label: platformContext.platformSlug,
      onClick: () => {
        // TODO: Implement navigation to platform
      },
    },
    {
      label: breadcrumbsTranslations('legalTexts'),
      onClick: () => {
        // Nothing should happen on clicking the current page
      },
    },
  ];

  return (
    <div className="flex flex-col space-y-2 gap-4">
      <Breadcrumbs items={breadcrumbItems} />

      <div className="flex flex-col space-y-2">
        <div className="flex flex-col sm:space-y-0 sm:flex-row sm:justify-between sm:items-center">
          <h1>{t('title')}</h1>
        </div>
        <p className="text-text-secondary text-sm">
          Platform: {platform.name} | Content Language: {contentLocale.toUpperCase()}
        </p>
      </div>
          <div className="sticky top-18 z-50 flex justify-end">
            <Button
              variant="primary"
              size="medium"
              text={saveLegalTextsMutation.isPending ? t('saving') : t('saveButton')}
              onClick={handleSave}
              disabled={saveLegalTextsMutation.isPending}
              className="shadow-lg"
            />
          </div>

      <p className="text-text-primary">{t('description')}</p>

      {/* Save Status Banner */}
      {saveLegalTextsMutation.isPending && (
        <Banner style="success" title={t('saving')} />
      )}
      {saveLegalTextsMutation.isSuccess && (
        <Banner style="success" title={t('saveSuccess')} />
      )}
      {saveLegalTextsMutation.isError && (
        <Banner style="error" title={saveLegalTextsMutation.error?.message ?? t('saveError')} />
      )}

      {/* Tabs for Legal Texts */}
      <Tabs.Root defaultTab={initialTab || 'impressum'} className="w-full">
        <Tabs.List variant="default">
          <Tabs.Trigger value="impressum" isLast={false}>
            {t('tabs.impressum')}
          </Tabs.Trigger>
          <Tabs.Trigger value="privacy-policy" isLast={false}>
            {t('tabs.privacyPolicy')}
          </Tabs.Trigger>
          <Tabs.Trigger value="terms-of-use" isLast={false}>
            {t('tabs.termsOfUse')}
          </Tabs.Trigger>
          <Tabs.Trigger value="rules" isLast={false}>
            {t('tabs.rules')}
          </Tabs.Trigger>
          <Tabs.Trigger value="offer-information" isLast={true}>
            {t('tabs.offerInformation')}
          </Tabs.Trigger>
        </Tabs.List>

        <div className="mt-6">
          <Tabs.Content value="impressum">
            <div className="flex flex-col gap-4 bg-card-fill p-5 border border-card-stroke rounded-medium">
              <h2>{t('tabs.impressum')}</h2>
              <RichTextDesignerComponent
                key={`impressum-${updateCounter}`}
                elementInstance={{
                  id: 'impressum-content',
                  type: FormElementType.RichText,
                  content: impressumContent || '',
                } as RichTextElement}
                locale={currentLocale}
                onContentChange={(value: string) => {
                  setImpressumContent(value);
                }}
                isCourseBuilder={false}
              />
            </div>
          </Tabs.Content>

          <Tabs.Content value="privacy-policy">
            <div className="flex flex-col gap-4 bg-card-fill p-5 border border-card-stroke rounded-medium">
              <h2>{t('tabs.privacyPolicy')}</h2>
              <RichTextDesignerComponent
                key={`privacy-policy-${updateCounter}`}
                elementInstance={{
                  id: 'privacy-policy-content',
                  type: FormElementType.RichText,
                  content: privacyPolicyContent || '',
                } as RichTextElement}
                locale={currentLocale}
                onContentChange={(value: string) => {
                  setPrivacyPolicyContent(value);
                }}
                isCourseBuilder={false}
              />
            </div>
          </Tabs.Content>

          <Tabs.Content value="terms-of-use">
            <div className="flex flex-col gap-4 bg-card-fill p-5 border border-card-stroke rounded-medium">
              <h2>{t('tabs.termsOfUse')}</h2>
              <RichTextDesignerComponent
                key={`terms-of-use-${updateCounter}`}
                elementInstance={{
                  id: 'terms-of-use-content',
                  type: FormElementType.RichText,
                  content: termsOfUseContent || '',
                } as RichTextElement}
                locale={currentLocale}
                onContentChange={(value: string) => {
                  setTermsOfUseContent(value);
                }}
                isCourseBuilder={false}
              />
            </div>
          </Tabs.Content>

          <Tabs.Content value="rules">
            <div className="flex flex-col gap-4 bg-card-fill p-5 border border-card-stroke rounded-medium">
              <h2>{t('tabs.rules')}</h2>
              <RichTextDesignerComponent
                key={`rules-${updateCounter}`}
                elementInstance={{
                  id: 'rules-content',
                  type: FormElementType.RichText,
                  content: rulesContent || '',
                } as RichTextElement}
                locale={currentLocale}
                onContentChange={(value: string) => {
                  setRulesContent(value);
                }}
                isCourseBuilder={false}
              />
            </div>
          </Tabs.Content>

          <Tabs.Content value="offer-information">
            <div className="flex flex-col gap-4 bg-card-fill p-5 border border-card-stroke rounded-medium">
              <h2>{t('tabs.offerInformation')}</h2>
              <RichTextDesignerComponent
                key={`offer-information-${updateCounter}`}
                elementInstance={{
                  id: 'offer-information-content',
                  type: FormElementType.RichText,
                  content: offerInformationContent || '',
                } as RichTextElement}
                locale={currentLocale}
                onContentChange={(value: string) => {
                  setOfferInformationContent(value);
                }}
                isCourseBuilder={false}
              />
            </div>
          </Tabs.Content>
        </div>
      </Tabs.Root>
    </div>
  );
}
