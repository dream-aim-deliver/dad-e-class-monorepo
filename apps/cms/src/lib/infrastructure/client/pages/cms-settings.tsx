'use client';

// Auto-generated by page-scaffold command v2
// Notion: https://www.notion.so/CMS-Settings-4fa22586f7044ee28498c561c59d17e0
// Usecases from Notion: getPlatform, updatePlatform, requestFileUpload
// Features from Notion: Platform configuration management
// API Endpoints from Notion:
// User Types from Notion: CMS
// Figma: https://www.figma.com/design/8KEwRuOoD5IgxTtFAtLlyS/Just_Do_Ad-1.2?node-id=5127-26799&t=GjW3V89mle6BrGgh-4

import { useLocale, useTranslations } from 'next-intl';
import { TLocale } from '@maany_shr/e-class-translations';
import { trpc } from '../trpc/cms-client';
import { useEffect, useState } from 'react';
import {
  Banner,
  Breadcrumbs,
  Button,
  DefaultError,
  DefaultLoading,
  Divider,
  InputField,
  Uploader,
} from '@maany_shr/e-class-ui-kit';
import { viewModels } from '@maany_shr/e-class-models';
import { fileMetadata } from '@maany_shr/e-class-models';
import { useGetPlatformPresenter } from '../hooks/use-get-platform-presenter';
import { useGetEmailConfigPresenter } from '../hooks/use-get-email-config-presenter';
import { useRequiredPlatformLocale } from '../context/platform-locale-context';
import { useRequiredPlatform } from '../context/platform-context';
import { useRouter } from 'next/navigation';
import { usePlatformLogoUpload } from './common/hooks/use-platform-logo-upload';
import { usePlatformBackgroundUpload } from './common/hooks/use-platform-background-upload';

interface CmsSettingsProps {
  locale: string;
  platformSlug: string;
  platformLocale: string;
}

export default function CmsSettings({ platformSlug, platformLocale }: CmsSettingsProps) {
  // TRPC utils for query invalidation
  const utils = trpc.useUtils();

  const locale = useLocale() as TLocale;
  const t = useTranslations('pages.cmsSettings');
  const breadcrumbsTranslations = useTranslations('components.breadcrumbs');
  const router = useRouter();

  // Platform context
  const platformContext = useRequiredPlatformLocale();
  const { platform } = useRequiredPlatform();

  // No-op for disabled fields
  const noOp = () => {
    // Intentionally empty - used for disabled read-only fields
  };

  // Fetch platform data
  const [getPlatformResponse, { refetch: refetchPlatform }] = trpc.getPlatform.useSuspenseQuery({});

  // Fetch email config data
  const [getEmailConfigResponse, { refetch: refetchEmailConfig }] = trpc.getEmailConfig.useSuspenseQuery({});

  const [platformViewModel, setPlatformViewModel] = useState<
    viewModels.TGetPlatformViewModel | undefined
  >(undefined);

  const [emailConfigViewModel, setEmailConfigViewModel] = useState<
    viewModels.TGetEmailConfigViewModel | undefined
  >(undefined);

  const { presenter: platformPresenter } = useGetPlatformPresenter(setPlatformViewModel);
  const { presenter: emailConfigPresenter } = useGetEmailConfigPresenter(setEmailConfigViewModel);

  // Present platform data on mount and when response changes
  useEffect(() => {
    // @ts-ignore - Presenter doesn't handle progress states
    platformPresenter.present(getPlatformResponse, platformViewModel);
  }, [getPlatformResponse, platformPresenter, platformViewModel]);

  // Present email config data on mount and when response changes
  useEffect(() => {
    // @ts-ignore - Presenter doesn't handle progress states
    emailConfigPresenter.present(getEmailConfigResponse, emailConfigViewModel);
  }, [getEmailConfigResponse, emailConfigPresenter, emailConfigViewModel]);

  // Upload progress tracking
  const [logoUploadProgress, setLogoUploadProgress] = useState<number | undefined>(undefined);
  const [backgroundUploadProgress, setBackgroundUploadProgress] = useState<number | undefined>(
    undefined,
  );

  // Upload hooks
  const logoUpload = usePlatformLogoUpload(setLogoUploadProgress);
  const backgroundUpload = usePlatformBackgroundUpload(setBackgroundUploadProgress);

  // Form state - individual fields
  const [name, setName] = useState<string>('');
  const [companyName, setCompanyName] = useState<string>('');
  const [companyAddress, setCompanyAddress] = useState<string>('');
  const [companyUuid, setCompanyUuid] = useState<string>('');
  const [logo, setLogo] = useState<fileMetadata.TFileMetadata | null>(null);
  const [backgroundImage, setBackgroundImage] = useState<fileMetadata.TFileMetadata | null>(null);

  // Read-only fields
  const [slug, setSlug] = useState<string>('');
  const [currency, setCurrency] = useState<string>('');
  const [domainName, setDomainName] = useState<string>('');

  // Email configuration fields
  const [templateId, setTemplateId] = useState<string>('');
  const [emailAddress, setEmailAddress] = useState<string>('');
  const [emailName, setEmailName] = useState<string>('');

  // Save platform mutation
  const updatePlatformMutation = trpc.updatePlatform.useMutation({
    onSuccess: async (data) => {
      if (data.success) {
        setSaveStatus('success');
        setSaveMessage(t('saveSuccess') ?? 'Settings saved successfully!');
        // Invalidate query to trigger refetch
        await utils.getPlatform.invalidate();
      } else {
        setSaveStatus('error');
        setSaveMessage(t('saveError') ?? 'Failed to save settings');
      }
    },
    onError: (error) => {
      setSaveStatus('error');
      setSaveMessage((error.message ?? t('saveError')) ?? 'An error occurred while saving');
      console.error('Error saving platform settings:', error);
    },
  });

  // Save email config mutation
  const saveEmailConfigMutation = trpc.saveEmailConfig.useMutation({
    onSuccess: async (data) => {
      if (data.success) {
        setEmailSaveStatus('success');
        setEmailSaveMessage(t('saveSuccess') ?? 'Settings saved successfully!');
        // Invalidate query to trigger refetch
        await utils.getEmailConfig.invalidate();
      } else {
        setEmailSaveStatus('error');
        setEmailSaveMessage(t('saveError') ?? 'Failed to save settings');
      }
    },
    onError: (error) => {
      setEmailSaveStatus('error');
      setEmailSaveMessage((error.message ?? t('saveError')) ?? 'An error occurred while saving');
      console.error('Error saving email config:', error);
    },
  });

  const [saveStatus, setSaveStatus] = useState<'idle' | 'success' | 'error'>('idle');
  const [saveMessage, setSaveMessage] = useState<string | null>(null);
  const [emailSaveStatus, setEmailSaveStatus] = useState<'idle' | 'success' | 'error'>('idle');
  const [emailSaveMessage, setEmailSaveMessage] = useState<string | null>(null);

  // Initialize form state from fetched data
  useEffect(() => {
    if (platformViewModel?.mode === 'default' && platformViewModel.data) {
      const data = platformViewModel.data;
      setName(data.name ?? '');
      setCompanyName(data.companyName ?? '');
      setCompanyAddress(data.companyAddress ?? '');
      setCompanyUuid(data.companyUuid ?? '');

      // Map backend image objects to TFileMetadata
      if (data.logo) {
        setLogo({
          id: data.logo.id,
          name: data.logo.name,
          size: data.logo.size,
          category: data.logo.category,
          url: data.logo.downloadUrl,
          thumbnailUrl: data.logo.downloadUrl,
          status: 'available',
        });
      }

      if (data.backgroundImage) {
        setBackgroundImage({
          id: data.backgroundImage.id,
          name: data.backgroundImage.name,
          size: data.backgroundImage.size,
          category: data.backgroundImage.category,
          url: data.backgroundImage.downloadUrl,
          thumbnailUrl: data.backgroundImage.downloadUrl,
          status: 'available',
        });
      }

      setSlug(data.slug ?? '');
      setCurrency(data.currency ?? '');
      setDomainName(data.domainName ?? '');
    }
  }, [platformViewModel]);

  // Initialize email config state from fetched data
  useEffect(() => {
    if (emailConfigViewModel?.mode === 'default' && emailConfigViewModel.data) {
      const data = emailConfigViewModel.data;
      setTemplateId(data.templateId ?? '');
      setEmailAddress(data.email ?? '');
      setEmailName(data.emailName ?? '');
    }
  }, [emailConfigViewModel]);

  // Loading state
  if (!platformViewModel || !emailConfigViewModel) {
    return <DefaultLoading locale={locale} variant="minimal" />;
  }

  // Error handling
  if (platformViewModel.mode === 'kaboom') {
    return (
      <DefaultError
        locale={locale}
        onRetry={() => {
          refetchPlatform();
        }}
      />
    );
  }

  if (platformViewModel.mode === 'not-found') {
    return (
      <DefaultError
        locale={locale}
        title={t('error.notFound.title')}
        description={t('error.notFound.description')}
        onRetry={() => {
          refetchPlatform();
        }}
      />
    );
  }

  // Error handling for email config
  if (emailConfigViewModel.mode === 'kaboom') {
    return (
      <DefaultError
        locale={locale}
        onRetry={() => {
          refetchEmailConfig();
        }}
      />
    );
  }

  // Handle logo upload
  const handleLogoUpload = async (
    uploadRequest: fileMetadata.TFileUploadRequest,
    abortSignal?: AbortSignal,
  ): Promise<fileMetadata.TFileMetadata> => {
    const uploadedFile = await logoUpload.handleFileUpload(uploadRequest, abortSignal);
    return uploadedFile;
  };

  // Handle background image upload
  const handleBackgroundUpload = async (
    uploadRequest: fileMetadata.TFileUploadRequest,
    abortSignal?: AbortSignal,
  ): Promise<fileMetadata.TFileMetadata> => {
    const uploadedFile = await backgroundUpload.handleFileUpload(uploadRequest, abortSignal);
    return uploadedFile;
  };

  // Handle save for platform settings
  const handleSave = () => {
    setSaveStatus('idle');
    setSaveMessage(null);

    updatePlatformMutation.mutate({
      name,
      companyName: companyName || '',
      companyAddress: companyAddress || '',
      companyUuid: companyUuid || '',
      logoId: logo?.id ? Number(logo.id) : null,
      backgroundImageId: backgroundImage?.id ? Number(backgroundImage.id) : null,
    });

    // Also save email config
    setEmailSaveStatus('idle');
    setEmailSaveMessage(null);

    saveEmailConfigMutation.mutate({
      templateId: templateId || null,
      email: emailAddress || null,
      emailName: emailName || null,
    });
  };

  // Breadcrumbs
  const breadcrumbItems = [
    {
      label: breadcrumbsTranslations('platforms'),
      onClick: () => router.push('/'),
    },
    {
      label: platform.name,
      onClick: () => {
        // TODO: Implement navigation to platform
      },
    },
    {
      label: breadcrumbsTranslations('cmsSettings'),
      onClick: () => {
        // Nothing should happen on clicking the current page
      },
    },
  ];

  return (
    <div className="flex flex-col space-y-2 gap-4">
      <Breadcrumbs items={breadcrumbItems} />

      <div className="flex flex-col space-y-2">
          <h1>{t('title')}</h1>
        <p className="text-text-secondary text-sm">
          {t('description')} | Platform: {platform.name}
        </p>
      </div>
      <div className="sticky top-18 z-50 flex justify-end">
          <Button
            variant="primary"
            size="medium"
            text={
              (updatePlatformMutation.isPending || saveEmailConfigMutation.isPending)
                ? (t('saving') ?? 'Saving...')
                : (t('saveButton') ?? 'Save Changes')
            }
            onClick={handleSave}
            disabled={updatePlatformMutation.isPending || saveEmailConfigMutation.isPending}
            className='shadow-lg'
          />
      </div>

      {/* Save Status Banner */}
      {(updatePlatformMutation.isPending || saveEmailConfigMutation.isPending) && (
        <Banner style="success" title={t('saving') ?? 'Saving changes...'} />
      )}
      {saveStatus === 'success' && saveMessage && <Banner style="success" title={saveMessage} />}
      {saveStatus === 'error' && saveMessage && <Banner style="error" title={saveMessage} />}
      {emailSaveStatus === 'error' && emailSaveMessage && <Banner style="error" title={emailSaveMessage} />}
      {logoUpload.uploadError && <Banner style="error" title={logoUpload.uploadError} />}
      {backgroundUpload.uploadError && <Banner style="error" title={backgroundUpload.uploadError} />}

      {/* Settings Form */}
      <div className="flex flex-col gap-8 bg-card-fill p-5 border border-card-stroke rounded-medium">
        {/* Basic Information Section */}
        <div className="flex flex-col gap-4">
          <h2>
            {t('sections.basicInfo') ?? 'Basic Information'}
          </h2>

          {/* Platform Name */}
          <div className="flex flex-col gap-1">
            <label className="text-sm font-medium text-text-primary">
              {t('fields.name') ?? 'Platform Name'}
            </label>
            <InputField
              inputText={t('fields.namePlaceholder') ?? 'Enter platform name'}
              value={name}
              setValue={setName}
            />
          </div>

          {/* Read-only fields */}
          <div className="flex flex-col gap-1">
            <label className="text-sm font-medium text-text-secondary">
              {t('fields.slug') ?? 'Slug'} ({t('fields.readOnly') ?? 'Read-only'})
            </label>
            <InputField
              inputText={t('fields.slugPlaceholder') ?? 'Platform slug'}
              value={slug}
              setValue={noOp}
              state="filled"
              className="opacity-70 cursor-not-allowed"
            />
          </div>

          <div className="flex flex-col gap-1">
            <label className="text-sm font-medium text-text-secondary">
              {t('fields.currency') ?? 'Currency'} ({t('fields.readOnly') ?? 'Read-only'})
            </label>
            <InputField
              inputText={t('fields.currencyPlaceholder') ?? 'Currency code'}
              value={currency}
              setValue={noOp}
              state="filled"
              className="opacity-70 cursor-not-allowed"
            />
          </div>

          <div className="flex flex-col gap-1">
            <label className="text-sm font-medium text-text-secondary">
              {t('fields.domainName') ?? 'Domain Name'} ({t('fields.readOnly') ?? 'Read-only'})
            </label>
            <InputField
              inputText={t('fields.domainNamePlaceholder') ?? 'Platform domain'}
              value={domainName}
              setValue={noOp}
              state="filled"
              className="opacity-70 cursor-not-allowed"
            />
          </div>
        </div>

        <Divider className='my-1'/>

        {/* Company Information Section */}
        <div className="flex flex-col gap-4">
          <h2>
            {t('sections.companyInfo') ?? 'Company Information'}
          </h2>

          <div className="flex flex-col gap-1">
            <label className="text-sm font-medium text-text-primary">
              {t('fields.companyName') ?? 'Company Name'}
            </label>
            <InputField
              inputText={t('fields.companyNamePlaceholder') ?? 'Enter company name'}
              value={companyName}
              setValue={setCompanyName}
            />
          </div>

          <div className="flex flex-col gap-1">
            <label className="text-sm font-medium text-text-primary">
              {t('fields.companyAddress') ?? 'Company Address'}
            </label>
            <InputField
              inputText={t('fields.companyAddressPlaceholder') ?? 'Enter company address'}
              value={companyAddress}
              setValue={setCompanyAddress}
            />
          </div>

          <div className="flex flex-col gap-1">
            <label className="text-sm font-medium text-text-primary">
              {t('fields.companyUuid') ?? 'Company UUID'}
            </label>
            <InputField
              inputText={t('fields.companyUuidPlaceholder') ?? 'Enter company UUID'}
              value={companyUuid}
              setValue={setCompanyUuid}
            />
          </div>
        </div>

        <Divider className='my-1'/>

        {/* Branding Section */}
        <div className="flex flex-col gap-4">
          <h2>
            {t('sections.branding') ?? 'Branding'}
          </h2>

          {/* Logo Upload */}
          <div className="flex flex-col gap-2">
            <label className="text-sm font-medium text-text-primary">
              {t('fields.logo') ?? 'Platform Logo'}
            </label>
            <Uploader
              type="single"
              variant="image"
              locale={locale}
              onFilesChange={handleLogoUpload}
              onUploadComplete={(file) => setLogo(file)}
              onDelete={() => setLogo(null)}
              onDownload={(id) => {
                if (logo?.url) {
                  window.open(logo.url, '_blank');
                }
              }}
              uploadProgress={logoUploadProgress}
              file={logo}
            />
            <p className="text-xs text-text-secondary">
              {t('fields.logoRecommendation')}
            </p>
          </div>

          {/* Background Image Upload */}
          <div className="flex flex-col gap-2">
            <label className="text-sm font-medium text-text-primary">
              ({t('fields.backgroundImage') ?? 'Background Image'})
            </label>
            <Uploader
              type="single"
              variant="image"
              locale={locale}
              onFilesChange={handleBackgroundUpload}
              onUploadComplete={(file) => setBackgroundImage(file)}
              onDelete={() => setBackgroundImage(null)}
              onDownload={(id) => {
                if (backgroundImage?.url) {
                  window.open(backgroundImage.url, '_blank');
                }
              }}
              uploadProgress={backgroundUploadProgress}
              file={backgroundImage}
            />
            <p className="text-xs text-text-secondary">
              ({t('fields.backgroundImageRecommendation')})
            </p>
          </div>
        </div>

        <Divider className='my-1'/>

        {/* Email Configuration Section */}
        <div className="flex flex-col gap-4">
          <h2>
            {t('sections.email') ?? 'Email Configuration'}
          </h2>

          {/* Template ID */}
          <div className="flex flex-col gap-1">
            <label className="text-sm font-medium text-text-primary">
              {t('fields.templateId') ?? 'Email Template ID'}
            </label>
            <InputField
              inputText={t('fields.templateIdPlaceholder') ?? 'e.g., d-abc123def456'}
              value={templateId}
              setValue={setTemplateId}
            />
            <p className="text-xs text-text-secondary">
              {t('fields.templateIdDescription') ?? 'The SendGrid template ID used for automated emails'}
            </p>
          </div>

          {/* Email Address */}
          <div className="flex flex-col gap-1">
            <label className="text-sm font-medium text-text-primary">
              {t('fields.emailAddress') ?? 'Sender Email Address'}
            </label>
            <InputField
              inputText={t('fields.emailAddressPlaceholder') ?? 'e.g., noreply@platform.com'}
              value={emailAddress}
              setValue={setEmailAddress}
            />
            <p className="text-xs text-text-secondary">
              {t('fields.emailAddressDescription') ?? 'The email address from which automated emails will be sent'}
            </p>
          </div>

          {/* Email Name */}
          <div className="flex flex-col gap-1">
            <label className="text-sm font-medium text-text-primary">
              {t('fields.emailName') ?? 'Sender Name'}
            </label>
            <InputField
              inputText={t('fields.emailNamePlaceholder') ?? 'e.g., Platform Team'}
              value={emailName}
              setValue={setEmailName}
            />
            <p className="text-xs text-text-secondary">
              {t('fields.emailNameDescription') ?? 'The display name that appears alongside the sender email address'}
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}
