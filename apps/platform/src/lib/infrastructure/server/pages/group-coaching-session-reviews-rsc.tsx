// Auto-generated by page-scaffold command
// Notion: https://www.notion.so/Group-Coaching-Session-Reviews-Tab-2245a7432d0180cf9b1ac4b112ae9d8f
// Feature: listGroupCoachingSessionReviews
// UI Components: CourseReviewFilterModal, GroupCoachingSessionReviews Banner
// User Type: Coach

import { HydrateClient, prefetch, trpc } from '../config/trpc/cms-server';
import { Suspense } from 'react';
import DefaultLoadingWrapper from '../../client/wrappers/default-loading';
import GroupCoachingSessionReviews from '../../client/pages/group-coaching-session-reviews';
import { getDictionary, TLocale } from '@maany_shr/e-class-translations';
import { redirect } from 'next/navigation';
import getSession from '../config/auth/get-session';

interface GroupCoachingSessionReviewsProps {
    locale: TLocale;
    courseSlug: string;
    groupId: number;
    coachingSessionId: number;
}

export default async function GroupCoachingSessionReviewsServerComponent(
    props: GroupCoachingSessionReviewsProps
) {
    const session = await getSession();

    if (!session || !session.user) {
        redirect('/auth/login');
    }

    const roles = session.user.roles;
    const isCoach = roles && roles.includes('coach');
    const dictionary = getDictionary(props.locale);

    if (!isCoach) {
        throw new Error(dictionary.pages.groupCoachingSessionReviews.error.accessDenied);
    }

    // Streaming pattern: Fire prefetches without awaiting (TSK-PERF-007)
    // React will stream HTML while queries are pending
    prefetch(trpc.listGroupCoachingSessionReviews.queryOptions({
        coachingSessionId: props.coachingSessionId,
    }));
    prefetch(trpc.getGroupIntroduction.queryOptions({
        courseSlug: props.courseSlug,
        additionalParams: {
            groupId: props.groupId,
            requestType: "requestForCoach",
        },
    }));

    return (
        <HydrateClient>
            <Suspense fallback={<DefaultLoadingWrapper />}>
                <GroupCoachingSessionReviews
                    locale={props.locale}
                    courseSlug={props.courseSlug}
                    groupId={props.groupId}
                    coachingSessionId={props.coachingSessionId}
                />
            </Suspense>
        </HydrateClient>
    );
}