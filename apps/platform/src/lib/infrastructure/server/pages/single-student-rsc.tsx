// Auto-generated by page-scaffold command
// Feature: listStudentInteractions

import { Suspense } from 'react';
import DefaultLoadingWrapper from '../../client/wrappers/default-loading';
import { redirect } from 'next/navigation';
import getSession from '../config/auth/get-session';
import SingleStudent from '../../client/pages/student/single-student';
import { HydrateClient, prefetch, trpc } from '../config/trpc/cms-server';
import { TLocale } from '@maany_shr/e-class-translations';

interface SingleStudentServerComponentProps {
    studentUsername: string;
    tab?: string;
    locale: TLocale;
    courseSlug: string;
}

export default async function SingleStudentServerComponent({
    studentUsername,
    tab,
    locale,
    courseSlug,
}: SingleStudentServerComponentProps) {
    const session = await getSession();

    if (!session || !session.user) {
        redirect('/auth/login');
    }

    const roles = session.user.roles;
    const isCoachOrAdmin = roles && (roles.includes('coach') || roles.includes('admin'));

    if (!isCoachOrAdmin) {
        // TODO: localize this error message
        throw new Error('Access denied. Only coaches and admins can access student details.');
    }

    // Streaming pattern: Fire prefetches without awaiting (TSK-PERF-007)
    // React will stream HTML while queries are pending
    // Note: We don't prefetch course-dependent queries (listStudentInteractions, etc.)
    // since there's no default course selection - they'll be fetched client-side after user selects a course
    prefetch(trpc.listCoachStudentCourses.queryOptions({ studentUsername }));
    prefetch(trpc.getStudentDetails.queryOptions({ username: studentUsername }));

    return (
        <>
            <HydrateClient>
                <Suspense fallback={<DefaultLoadingWrapper />}>
                    <SingleStudent studentUsername={studentUsername} initialTab={tab} roles={roles} courseSlug={courseSlug} />
                </Suspense>
            </HydrateClient>
        </>
    );
}
