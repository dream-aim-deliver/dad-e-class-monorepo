// Auto-generated by page-scaffold command
// Notion: https://www.notion.so/Ended-Group-Coaching-Sessions-group-course-tab-2245a7432d0180cab050ef2e0ebbb675
// Feature: listGroupCoachingSessions (FEAT-169)
// User Type: Coach
// Figma: https://www.figma.com/design/8KEwRuOoD5IgxTtFAtLlyS/Just_Do_Ad-1.2?node-id=6913-296778

import { HydrateClient, prefetch, trpc } from '../config/trpc/cms-server';
import { Suspense } from 'react';
import DefaultLoadingWrapper from '../../client/wrappers/default-loading';
import EndedGroupCoachingSessions from '../../client/pages/ended-group-coaching-sessions';
import { TLocale, getDictionary } from '@maany_shr/e-class-translations';
import { redirect } from 'next/navigation';
import getSession from '../config/auth/get-session';

interface EndedGroupCoachingSessionsProps {
    locale: TLocale;
    courseSlug: string;
    groupId: number;
}

export default async function EndedGroupCoachingSessionsServerComponent(
    props: EndedGroupCoachingSessionsProps
) {
    // Server-side authentication - Coach only
    const session = await getSession();

    if (!session || !session.user) {
        redirect('/auth/login');
    }

    const roles = session.user.roles;
    const isCoach = roles && roles.includes('coach');

    const dictionary = getDictionary(props.locale);

    if (!isCoach) {
        throw new Error(dictionary.pages.endedGroupCoachingSessions.error.accessDenied);
    }

    // Streaming pattern: Fire prefetches without awaiting (TSK-PERF-007)
    // React will stream HTML while queries are pending
    prefetch(trpc.listGroupCoachingSessions.queryOptions({
        groupId: props.groupId,
    }));
    prefetch(trpc.getGroupIntroduction.queryOptions({
        courseSlug: props.courseSlug,
        additionalParams: {
            groupId: props.groupId,
            requestType: "requestForCoach",
        }
    }));

    return (
        <HydrateClient>
            <Suspense fallback={<DefaultLoadingWrapper />}>
                <EndedGroupCoachingSessions
                    locale={props.locale}
                    courseSlug={props.courseSlug}
                    groupId={props.groupId}
                />
            </Suspense>
        </HydrateClient>
    );
}
