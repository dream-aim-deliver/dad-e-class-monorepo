'use client';

// Auto-generated by page-scaffold command v2
// Notion: https://www.notion.so/Group-Workspace-Coach-workspace-2245a7432d01807c8606d25a58943c2e
// Usecases: saveGroupNotes, getGroupNotes, listGroupAssignments, listGroupMembers, getGroupNextCoachingSession
// Features: Group notes management, assignments tracking, member management, coaching session scheduling
// User Types: Coach
// Figma: https://www.figma.com/design/8KEwRuOoD5IgxTtFAtLlyS/Just_Do_Ad-1.2?node-id=6913-292532

import { useState } from 'react';
import { TLocale } from '@maany_shr/e-class-translations';
import { trpc } from '../trpc/cms-client';
import { DefaultLoading, DefaultError, Breadcrumbs, GroupIntroduction, Button, CoachNotesView, Dropdown, IconFilter, AssignmentCardFilterModal, TextInput, IconSearch, StudentCardList, StudentCard, IconEdit, CoachingSessionGroupOverviewCard, AssignmentOverview, AssignmentOverviewList, CoachNotesCreate, CoachNotesEditDialog, CoachNotesResultPopup, downloadFile } from '@maany_shr/e-class-ui-kit';
import { useLocale, useTranslations } from 'next-intl';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { fileMetadata, viewModels } from '@maany_shr/e-class-models';
import { useGetGroupIntroductionPresenter } from '../hooks/use-get-group-introduction-presenter';
import { useGetGroupNotesPresenter } from '../hooks/use-get-group-notes-presenter';
import { useGetGroupNextCoachingSessionPresenter } from '../hooks/use-get-group-next-coaching-session-presenter';
import { useGroupNotesFileUpload } from './common/hooks/use-group-notes-image-upload';
import { useAssignmentFilters } from './hooks/use-assignment-filters';
import { useGroupMembers } from './hooks/use-group-members';
import useClientSidePagination from '../utils/use-client-side-pagination';

interface GroupWorkspaceCoachProps {
  locale: TLocale;
  courseSlug: string;
  groupId: number;
}

export default function GroupWorkspaceCoach({
  locale,
  courseSlug,
  groupId,
}: GroupWorkspaceCoachProps) {
  const currentLocale = useLocale() as TLocale;
  const router = useRouter();
  const t = useTranslations('pages.groupWorkspaceCoach');
  const breadcrumbsTranslations = useTranslations('components.breadcrumbs');
  const paginationTranslations = useTranslations('components.paginationButton');

  // Authentication using Pattern B (Coach role only)
  const sessionDTO = useSession();

  // Create/Edit Notes state
  const [noteDescription, setNoteDescription] = useState('');
  const [noteLinks, setNoteLinks] = useState<{
    url: string;
    title: string;
    customIconMetadata?: fileMetadata.TFileMetadata;
    id?: number;
  }[]>([]);
  const [includeInMaterials, setIncludeInMaterials] = useState(false);

  const { handleFileUpload, handleFileDelete, handleFileDownload } = useGroupNotesFileUpload();

  // Edit notes dialog state
  const [isEditNotesDialogOpen, setIsEditNotesDialogOpen] = useState(false);

  // Notes result popup state
  const [showNotesResultPopup, setShowNotesResultPopup] = useState(false);
  const [notesResultType, setNotesResultType] = useState<'success' | 'error'>('success');

  const [groupIntroductionViewModel, setGroupIntroductionViewModel] = useState<
    viewModels.TGetGroupIntroductionViewModel | undefined
  >(undefined);

  const [groupNotesViewModel, setGroupNotesViewModel] = useState<
    viewModels.TGetGroupNotesViewModel | undefined
  >(undefined);

  const [nextSessionViewModel, setNextSessionViewModel] = useState<
    viewModels.TGetGroupNextCoachingSessionViewModel | undefined
  >(undefined);

  // TRPC queries for page data

  // Fetch group introduction from getGroupIntroduction usecase
  const [groupIntroductionResponse] = trpc.getGroupIntroduction.useSuspenseQuery({
    courseSlug: courseSlug,
    additionalParams: {
      groupId: groupId,
      requestType: "requestForCoach",
    }
  });

  // Fetch group notes from getGroupNotes usecase
  const [groupNotesResponse, { refetch: refetchGroupNotesResponse }] = trpc.getGroupNotes.useSuspenseQuery({
    courseSlug: courseSlug,
    additionalParams: {
      groupId: groupId,
      requestType: "requestForCoach",
    }
  });

  // Fetch next coaching session from getGroupNextCoachingSession usecase
  const [nextSessionResponse] = trpc.getGroupNextCoachingSession.useSuspenseQuery({
    courseSlug: courseSlug,
    additionalParams: {
      groupId: groupId,
      requestType: "requestForCoach",
    }
  });

  const saveNotesMutation = trpc.saveGroupNotes.useMutation();

  const { presenter: groupIntroductionPresenter } = useGetGroupIntroductionPresenter(setGroupIntroductionViewModel);
  const { presenter: notesPresenter } = useGetGroupNotesPresenter(setGroupNotesViewModel);
  const { presenter: nextSessionPresenter } = useGetGroupNextCoachingSessionPresenter(setNextSessionViewModel);

  // Assignment filters and sorting hook (includes data fetching and presenter logic)
  const {
    filters,
    sortBy,
    showFilterModal,
    assignmentsViewModel,
    isLoading: isAssignmentsLoading,
    sortedAndFilteredAssignments,
    availableStatuses,
    availableCourses,
    availableModules,
    availableLessons,
    handleApplyFilters,
    handleSortChange,
    handleOpenFilterModal,
    handleCloseFilterModal,
    resetFilters,
  } = useAssignmentFilters({
    courseSlug,
    groupId,
    initialFilters: {},
    requestType: 'requestForCoach',
  });

  // Group members hook (includes data fetching, presenter logic, and search)
  const {
    search,
    setSearch,
    membersViewModel,
    isLoading: isMembersLoading,
    filteredMembers,
    allMembers,
    clearSearch,
  } = useGroupMembers({
    courseSlug,
    groupId,
    requestType: 'requestForCoach',
  });

  // Sort options for dropdown
  const sortOptions = [
    { value: 'title', label: t('assignments.sortOptions.title') },
    { value: 'status', label: t('assignments.sortOptions.status') },
    { value: 'date', label: t('assignments.sortOptions.date') },
    { value: 'student', label: t('assignments.sortOptions.student') },
  ];

  // Notes handlers
  const handleEditNotesClick = () => {
    // Initialize state with current notes data when opening edit dialog
    setNoteDescription(notesData.notes);
    setNoteLinks(notesData.links?.map(link => ({
      url: link.url || '',
      title: link.title,
      id: link.id ? Number(link.id) : undefined,
      customIconMetadata: link.icon ? {
        id: link.icon.id,
        name: link.icon.name,
        size: link.icon.size,
        status: 'available' as const,
        category: link.icon.category,
        url: link.icon.downloadUrl,
        thumbnailUrl: link.icon.downloadUrl,
      } : undefined,
    })) || []);
    setIncludeInMaterials(false);
    setIsEditNotesDialogOpen(true);
  };

  const handlePublishNotes = (
    description: string, 
    links: {
      url: string;
      title: string;
      customIconMetadata?: fileMetadata.TFileMetadata;
      id?: number;
    }[], 
    includeInMaterials: boolean
  ) => {

    // Prevent publishing if already in progress
    if (saveNotesMutation.isPending) {
      return;
    }

    saveNotesMutation.mutate(
      {
        notes: description,
        links: links.map(link => ({
          title: link.title,
          url: link.url,
          state: 'draft' as const,
          iconFileId: link.customIconMetadata?.id ? Number(link.customIconMetadata.id) : null,
          id: link.id,
        }))
      },
      {
        onSuccess: () => {
          // Close the edit dialog if it's open
          if (isEditNotesDialogOpen) {
            setIsEditNotesDialogOpen(false);
          }
          
          // Show success popup
          setNotesResultType('success');
          setShowNotesResultPopup(true);
          
          // Refetch to get updated notes data
          refetchGroupNotesResponse();
        },
        onError: (error) => {
          // Close the edit dialog if it's open
          if (isEditNotesDialogOpen) {
            setIsEditNotesDialogOpen(false);
          }
          
          // Show error popup
          setNotesResultType('error');
          setShowNotesResultPopup(true);
          
        }
      }
    );
  };

  const handleBackFromEdit = () => {
    setIsEditNotesDialogOpen(false);
  };

  const handleImageChange = async (index: number, fileRequest: any, abortSignal?: AbortSignal) => {
    const result = await handleFileUpload(fileRequest, 'upload_group_note_icon', groupId, abortSignal);
    return result;
  };

  const handleDeleteIcon = (index: number) => {
    // Add handle icon delete logic if needed
  };

  // Pagination for assignments
  const {
    displayedItems: displayedAssignments,
    hasMoreItems: hasMoreAssignments,
    handleLoadMore: handleLoadMoreAssignments,
  } = useClientSidePagination({
    items: sortedAndFilteredAssignments,
    itemsPerPage: 3,
    itemsPerPage2xl: 4,
  });

  // Pagination for members
  const {
    displayedItems: displayedMembers,
    hasMoreItems: hasMoreMembers,
    handleLoadMore: handleLoadMoreMembers,
  } = useClientSidePagination({
    items: filteredMembers,
    itemsPerPage: 3,
    itemsPerPage2xl: 4,
  });

  const session = sessionDTO.data;
  const isCoach = session?.user?.roles?.includes('coach');

  if (!isCoach) {
    return (
      <DefaultError
        locale={currentLocale}
        title={t('error.accessDenied.title')}
        description={t('error.accessDenied.description')}
      />
    );
  }


  // @ts-ignore
  groupIntroductionPresenter.present(groupIntroductionResponse, groupIntroductionViewModel);
  // @ts-ignore
  notesPresenter.present(groupNotesResponse, groupNotesViewModel);
  // @ts-ignore
  nextSessionPresenter.present(nextSessionResponse, nextSessionViewModel);

  if (!groupIntroductionViewModel || !groupNotesViewModel || !nextSessionViewModel || !membersViewModel || !assignmentsViewModel) {
    return <DefaultLoading locale={currentLocale} variant="minimal" />;
  }

  if (groupIntroductionViewModel.mode === 'kaboom' || groupNotesViewModel.mode === 'kaboom' || nextSessionViewModel.mode === 'kaboom' || assignmentsViewModel.mode === 'kaboom' || membersViewModel.mode === 'kaboom') {
    return (
      <DefaultError
        locale={currentLocale}
        title={t('error.title')}
        description={t('error.description')}
      />
    );
  }

  if (groupIntroductionViewModel.mode === 'not-found' || groupNotesViewModel.mode === 'not-found' || nextSessionViewModel.mode === 'not-found' || assignmentsViewModel.mode === 'not-found' || membersViewModel.mode === 'not-found') {
    return (
      <DefaultError
        locale={currentLocale}
        title={t('error.title')}
        description={t('error.description')}
      />
    );
  }

  // Success state 
  const introductionData = groupIntroductionViewModel.data;
  const notesData = groupNotesViewModel.data;
  const nextSessionData = nextSessionViewModel.data;

  // Breadcrumb items for navigation
  const breadcrumbItems = [
    {
      label: breadcrumbsTranslations('home'),
      onClick: () => router.push(`/${locale}`),
    },
    {
      label: breadcrumbsTranslations('workspace'),
      onClick: () => router.push(`/${locale}/workspace`),
    },
    {
      label: breadcrumbsTranslations('yourCourses'),
      onClick: () => router.push(`/${locale}/workspace/courses`),
    },
    {
      label: courseSlug,
      onClick: () => router.push(`/${locale}/courses/${courseSlug}`),
    },
    {
      label: breadcrumbsTranslations('groups'),
      onClick: () => router.push(`/${locale}/workspace/courses/${courseSlug}/groups`),
    },
    {
      label: introductionData.name,
      onClick: () => router.push(`/${locale}/workspace/courses/${courseSlug}/groups/${groupId}`),
    },
  ];

  // Function to render StudentCards based on members data and status
  const renderStudentCards = (members: viewModels.TListGroupMembersSuccess['members']) => {
    return members.map((member, index) => {
      // Base props common to all student card variants
      const baseProps = {
        locale: locale,
        studentName: `${member.name} ${member.surname}`,
        studentImageUrl: member.avatarUrl || '',
        coachName: `${member.coach.name} ${member.coach.surname}`,
        coachImageUrl: member.coach.avatarUrl || '',
        courseName: member.course.title,
        courseImageUrl: member.course.imageUrl || '',
        coachingSessionsLeft: member.coachingSessionCount || undefined,
        isYou: member.coach.isCurrentUser,
        onStudentDetails: () => {
          // TODO: Redirect to user profile page
        },
        onClickCourse: () => {
          router.push(`/${locale}/courses/${member.course.slug}`)
        },
        onClickCoach: () => {
          router.push(`/${locale}/coaches/${member.coach.username}`)
        },
      };

      const key = member.id ?? index;

      // Handle different status cases based on lastAssignment
      if (!member.lastAssignment) {
        // No assignment case
        return (
          <StudentCard
            {...baseProps}
            key={key}
            status="no-assignment"
          />
        );
      }

      const { status, title } = member.lastAssignment;

      if (status === "waiting-feedback") {
        return (
          <StudentCard
            {...baseProps}
            key={key}
            status="waiting-feedback"
            assignmentTitle={title}
            onViewAssignment={() => {
              // TODO: Implement view assignment functionality
            }}
          />
        );
      }

      if (status === "long-wait") {
        return (
          <StudentCard
            {...baseProps}
            key={key}
            status="long-wait"
            assignmentTitle={title}
            onViewAssignment={() => {
              // TODO: Implement view assignment functionality
            }}
          />
        );
      }

      if (status === "passed") {
        return (
          <StudentCard
            {...baseProps}
            key={key}
            status="passed"
            completedCourseDate={member.courseCompletionDate ? new Date(member.courseCompletionDate) : new Date()}
          />
        );
      }

      // Fallback to no-assignment if status is unknown
      return (
        <StudentCard
          {...baseProps}
          key={key}
          status="no-assignment"
        />
      );
    });
  };

  return (
    <div className="flex flex-col space-y-10">
      {/* Section: Group Introduction */}
      <div className='flex flex-col gap-4'>
        <div className='flex flex-col gap-3'>
          <Breadcrumbs items={breadcrumbItems} />
          <h5 className='text-text-primary md:text-lg text-md font-bold leading-[120%]'>
            {t('title')}
          </h5>
          <p className='text-text-secondary text-sm md:text-md'>
            {t('description')}
          </p>
        </div>
        <GroupIntroduction
          groupName={introductionData.name}
          courseName={introductionData.course.title}
          coaches={introductionData.coaches}
          courseImageUrl={introductionData.course.imageUrl || ''}
          actualStudentCount={introductionData.actualStudentCount}
          maxStudentCount={introductionData.maxStudentCount}
          locale={locale}
          onClickCourse={() => router.push(`/${locale}/courses/${courseSlug}`)}
          onClickUser={(username) => {
            router.push(`/${locale}/coaches/${username}`);
          }}
        />
      </div>

      {/* Section: Group Notes (saveGroupNotes, getGroupNotes) */}
      <div className="flex gap-4 items-start flex-col md:flex-row lg:flex-row">
        {/* Notes section*/}
        {/* TODO: There is some issue in text editor component regarding resizing so we need to investigate further */}
        <div className='flex flex-col gap-4 w-full md:max-w-[700px] lg:max-w-[900px] sm:max-w-[450px] max-w-[300px]'>
          <div className='flex  gap-7 items-center'>
            <h3 className='text-text-primary md:text-2xl text-xl font-bold leading-[110%]'>
              {t('notes.title')}
            </h3>
            {/* Only show edit button when notes data exists */}
            {notesData.notes !== '' || (notesData.links && notesData.links.length > 0) ? (
              <Button
                variant="text"
                text={t('notes.editButton')}
                onClick={handleEditNotesClick}
                hasIconLeft
                iconLeft={<IconEdit />}
              />
            ) : null}
          </div>
          {notesData.notes === '' && (!notesData.links || notesData.links.length === 0) ? (
            <CoachNotesCreate
              noteDescription={noteDescription}
              noteLinks={noteLinks}
              includeInMaterials={includeInMaterials}
              locale={locale}
              onPublish={handlePublishNotes}
              onImageChange={handleImageChange}
              onDeleteIcon={handleDeleteIcon}
              onNoteLinksChange={setNoteLinks}
              onIncludeInMaterialsChange={setIncludeInMaterials}
              onNoteDescriptionChange={setNoteDescription}
              isEditMode={false}
              onBack={() => {
                // No action needed on back for create mode
              }}
              isLoading={saveNotesMutation.isPending}
            />
          ) :
            <CoachNotesView
              noteDescription={notesData.notes}
              noteLinks={notesData.links?.map(link => ({
                url: link.url || '',
                title: link.title,
                customIconMetadata: link.icon ? {
                  id: link.icon.id,
                  name: link.icon.name,
                  size: link.icon.size,
                  status: 'available' as const,
                  category: link.icon.category,
                  url: link.icon.downloadUrl,
                  thumbnailUrl: link.icon.downloadUrl,
                } : undefined,
              }))}
              locale={locale}
              onExploreCourses={() => {
                // TODO: Implement explore courses functionality
              }}
            />
          }
        </div>

        {/* Next coaching session */}
        <div className='flex flex-col gap-4 w-full'>
          <div className='flex items-center justify-between w-full gap-7'>
            <h3 className='text-text-primary md:text-2xl text-xl font-bold leading-[110%] whitespace-nowrap'>
              {t('nextCoachingSession.title')}
            </h3>
            <Button
              variant="text"
              text={t('nextCoachingSession.closedSessionsButton')}
              onClick={() => {
                // TODO: Implement view closed sessions functionality
              }}
            />
          </div>
          {/* Group Coaching Sessions */}
          {nextSessionData.nextSession ? (
            <CoachingSessionGroupOverviewCard
              userType='coach'
              status='unscheduled'
              locale={locale}
              title={nextSessionData.nextSession.coachingOfferingTitle}
              duration={nextSessionData.nextSession.coachingOfferingDuration}
              withinCourse={true}
              courseName={nextSessionData.nextSession.course.title}
              courseImageUrl={nextSessionData.nextSession.course.imageUrl || ''}
              groupName={nextSessionData.nextSession.groupName}
              onClickCourse={() => {
                if (nextSessionData?.nextSession?.course.slug) {
                  router.push(`/${locale}/courses/${nextSessionData?.nextSession?.course.slug}`)
                }
              }}
              onClickGroup={() => {
                if (nextSessionData?.nextSession?.course.slug && nextSessionData?.nextSession?.groupId) {
                  router.push(`/${locale}/workspace/courses/${nextSessionData?.nextSession?.course.slug}/groups/${nextSessionData?.nextSession?.groupId}`)
                }
              }}
              onClickScheduleSession={() => {
                // TODO: Implement schedule session functionality
              }}
            />
          ) : (
            <div className='flex items-center justify-center py-16'>
              <p className='text-text-secondary text-sm md:text-md'>
                {t('nextCoachingSession.noSession')}
              </p>
            </div>
          )}
        </div>
      </div>

      {/* Section: Group Assignments (listGroupAssignments) */}
      <div className="flex flex-col gap-4 w-full">
        <div className='flex items-center justify-between w-full flex-wrap gap-4'>
          <h3 className='text-text-primary md:text-2xl text-xl font-bold leading-[110%]'>
            {t('assignments.title')}
          </h3>
          <div className="flex items-center gap-2 flex-wrap">
            <div className="flex items-center gap-2 ">
              <p className="text-sm text-text-primary">
                {t('assignments.sortBy')}
              </p>
              <div className="w-48">
                <Dropdown
                  type="simple"
                  options={sortOptions}
                  onSelectionChange={handleSortChange}
                  defaultValue={sortBy}
                  text={{ simpleText: t('assignments.selectSort') }}
                />
              </div>
            </div>
            <Button
              variant="secondary"
              size="medium"
              text={t('assignments.filterButton')}
              onClick={handleOpenFilterModal}
              hasIconLeft
              iconLeft={<IconFilter />}
              className="w-auto"
            />
          </div>
        </div>
        <AssignmentOverviewList locale={locale}>
          {displayedAssignments.map((assignment) =>
            <AssignmentOverview
              key={assignment.id}
              {...assignment}
              locale={locale}
              role="coach"
              onClickCourse={() => router.push(`/${locale}/courses/${assignment.course.slug}`)}
              onClickUser={() => {
                // TODO: Navigate to student profile page
              }}
              onClickView={() => {
                // TODO: Implement view assignment functionality
              }}
              onClickGroup={() => router.push(`/${locale}/workspace/courses/${assignment.course.slug}/groups/${assignment.groupId}`)}
              onFileDownload={(url , name) => downloadFile(url, name)}
            />
          )}
        </AssignmentOverviewList>
        {hasMoreAssignments && (
          <div className="flex justify-center items-center w-full mt-6">
            <Button
              variant="text"
              text={paginationTranslations('loadMore')}
              onClick={handleLoadMoreAssignments}
            />
          </div>
        )}
      </div>

      {/* Section: Group Members (listGroupMembers) */}
      <div className='flex flex-col gap-4 w-full'>
        <div className='flex items-center justify-between w-full flex-wrap gap-4'>
          <h3 className='text-text-primary md:text-2xl text-xl font-bold items-center'>
            {t('members.title')}
          </h3>
          <div className='flex w-full md:w-fit lg:w-fit'>
            <div className='flex-1'>
              <TextInput
                inputField={{
                  id: 'search',
                  className: 'w-full',
                  value: search,
                  setValue: setSearch,
                  inputText: t('members.searchstudent'),
                  hasLeftContent: true,
                  leftContent: <IconSearch />,
                }}
              />
            </div>
          </div>
        </div>
        <StudentCardList locale={locale}>
          {renderStudentCards(displayedMembers)}
        </StudentCardList>
        {hasMoreMembers && (
          <div className="flex justify-center items-center w-full mt-6">
            <Button
              variant="text"
              text={paginationTranslations('loadMore')}
              onClick={handleLoadMoreMembers}
            />
          </div>
        )}
      </div>

      {/* Assignment Filter Modal */}
      {showFilterModal && (
        <AssignmentCardFilterModal
          onApplyFilters={handleApplyFilters}
          onClose={handleCloseFilterModal}
          initialFilters={filters}
          availableStatuses={availableStatuses}
          availableCourses={availableCourses}
          availableModules={availableModules}
          availableLessons={availableLessons}
          locale={locale}
        />
      )}

      {/* Coach Notes Edit Dialog */}
      <CoachNotesEditDialog
        isOpen={isEditNotesDialogOpen}
        onOpenChange={setIsEditNotesDialogOpen}
        noteDescription={noteDescription}
        noteLinks={noteLinks}
        includeInMaterials={includeInMaterials}
        locale={locale}
        onPublish={handlePublishNotes}
        onBack={handleBackFromEdit}
        onImageChange={handleImageChange}
        onDeleteIcon={handleDeleteIcon}
        onNoteLinksChange={setNoteLinks}
        onIncludeInMaterialsChange={setIncludeInMaterials}
        onNoteDescriptionChange={setNoteDescription}
        isEditMode={true}
        isLoading={saveNotesMutation.isPending}
      />

      {/* Coach Notes Result Popup */}
      {showNotesResultPopup && (
        <div className="fixed inset-0 flex items-center justify-center z-50 backdrop-blur-sm">
          <CoachNotesResultPopup
            onClose={() => {
              setShowNotesResultPopup(false);
            }}
            isSuccess={notesResultType === 'success'}
            isError={notesResultType === 'error'}
            locale={locale}
          />
        </div>
      )}
    </div>
  );
}