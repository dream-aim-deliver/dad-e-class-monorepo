'use client';

// Auto-generated by page-scaffold command v2
// Notion: https://www.notion.so/Group-Workspace-Coach-workspace-2245a7432d01807c8606d25a58943c2e
// Usecases: saveGroupNotes, getGroupNotes, listGroupAssignments, listGroupMembers, getGroupNextCoachingSession
// Features: Group notes management, assignments tracking, member management, coaching session scheduling
// User Types: Coach
// Figma: https://www.figma.com/design/8KEwRuOoD5IgxTtFAtLlyS/Just_Do_Ad-1.2?node-id=6913-292532

import { useState } from 'react';
import { TLocale } from '@maany_shr/e-class-translations';
import { trpc } from '../trpc/cms-client';
import { DefaultLoading, DefaultError, Breadcrumbs, GroupIntroduction, Button, CoachNotesView, Dropdown, IconFilter, AssignmentCardFilterModal, TextInput, IconSearch, StudentCardList, StudentCard, IconEdit, CoachingSessionGroupOverviewCard, AssignmentOverview, AssignmentOverviewList, CoachNotesCreate, CoachNotesEditDialog } from '@maany_shr/e-class-ui-kit';
import { useLocale, useTranslations } from 'next-intl';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { viewModels } from '@maany_shr/e-class-models';
import { useGetGroupIntroductionPresenter } from '../hooks/use-get-group-introduction-presenter';
import { useGetGroupNotesPresenter } from '../hooks/use-get-group-notes-presenter';
import { useGetGroupNextCoachingSessionPresenter } from '../hooks/use-get-group-next-coaching-session-presenter';
import { useCourseImageUpload } from './common/hooks/use-course-image-upload';
import { useAssignmentFilters } from './workspace/hooks/use-assignment-filters';
import { useGroupMembers } from './workspace/hooks/use-group-members';

interface GroupWorkspaceCoachProps {
  locale: TLocale;
  courseSlug: string;
  groupId: number;
}

export default function GroupWorkspaceCoach({
  locale,
  courseSlug,
  groupId,
}: GroupWorkspaceCoachProps) {
  const currentLocale = useLocale() as TLocale;
  const router = useRouter();
  const t = useTranslations('pages.groupWorkspaceCoach');
  const breadcrumbsTranslations = useTranslations('components.breadcrumbs');

  // Authentication using Pattern B (Coach role only)
  const sessionDTO = useSession();

  // Create/Edit Notes state
  const [noteDescription, setNoteDescription] = useState('');
  const [noteLinks, setNoteLinks] = useState<{
    url: string;
    title: string;
    customIconMetadata?: any;
  }[]>([]);
  const [includeInMaterials, setIncludeInMaterials] = useState(false);

  const {
    courseImage,
    uploadError,
    handleFileChange,
    handleUploadComplete,
    handleDelete,
    handleDownload,
  } = useCourseImageUpload(null);

  // Edit notes dialog state
  const [isEditNotesDialogOpen, setIsEditNotesDialogOpen] = useState(false);

  const [groupIntroductionViewModel, setGroupIntroductionViewModel] = useState<
    viewModels.TGetGroupIntroductionViewModel | undefined
  >(undefined);

  const [groupNotesViewModel, setGroupNotesViewModel] = useState<
    viewModels.TGetGroupNotesViewModel | undefined
  >(undefined);

  const [nextSessionViewModel, setNextSessionViewModel] = useState<
    viewModels.TGetGroupNextCoachingSessionViewModel | undefined
  >(undefined);

  // TRPC queries for page data
  // TODO: Replace with actual usecases from: saveGroupNotes, getGroupNotes, listGroupAssignments, listGroupMembers, getGroupNextCoachingSession

  // Fetch group introduction from getGroupIntroduction usecase
  const [groupIntroductionResponse] = trpc.getGroupIntroduction.useSuspenseQuery({
    courseSlug: courseSlug,
    additionalParams: {
      groupId: groupId,
      requestType: "requestForCoach",
    }
  });

  // Fetch group notes from getGroupNotes usecase
  const [groupNotesResponse, {refetch: refetchGroupNotesResponse}] = trpc.getGroupNotes.useSuspenseQuery({
    courseSlug: courseSlug,
    additionalParams: {
      groupId: groupId,
      requestType: "requestForCoach",
    }
  });

  // Fetch next coaching session from getGroupNextCoachingSession usecase
  const [nextSessionResponse] = trpc.getGroupNextCoachingSession.useSuspenseQuery({
    courseSlug: courseSlug,
    additionalParams: {
      groupId: groupId,
      requestType: "requestForCoach",
    }
  });

  const saveNotesMutation = trpc.saveGroupNotes.useMutation();

  const { presenter: groupIntroductionPresenter } = useGetGroupIntroductionPresenter(setGroupIntroductionViewModel);
  const { presenter: notesPresenter } = useGetGroupNotesPresenter(setGroupNotesViewModel);
  const { presenter: nextSessionPresenter } = useGetGroupNextCoachingSessionPresenter(setNextSessionViewModel);

  // Assignment filters and sorting hook (includes data fetching and presenter logic)
  const {
    filters,
    sortBy,
    showFilterModal,
    assignmentsViewModel,
    isLoading: isAssignmentsLoading,
    sortedAndFilteredAssignments,
    availableStatuses,
    availableCourses,
    availableModules,
    availableLessons,
    handleApplyFilters,
    handleSortChange,
    handleOpenFilterModal,
    handleCloseFilterModal,
    resetFilters,
  } = useAssignmentFilters({
    courseSlug,
    groupId,
    initialFilters: {},
  });

  // Group members hook (includes data fetching, presenter logic, and search)
  const {
    search,
    setSearch,
    membersViewModel,
    isLoading: isMembersLoading,
    filteredMembers,
    allMembers,
    clearSearch,
  } = useGroupMembers({
    courseSlug,
    groupId,
    requestType: 'requestForCoach',
  });

  // Sort options for dropdown
  const sortOptions = [
    { value: 'title', label: t('assignments.sortOptions.title') },
    { value: 'status', label: t('assignments.sortOptions.status') },
    { value: 'date', label: t('assignments.sortOptions.date') },
    { value: 'student', label: t('assignments.sortOptions.student') },
  ];

  // Notes handlers
  const handleEditNotesClick = () => {
    setIsEditNotesDialogOpen(true);
  };

  const handlePublishNotes = (description: string, links: any[], includeInMaterials: boolean) => {
    //  saveNotesMutation with the data
    saveNotesMutation.mutate({
      notes: description,
      links: links.map(link => ({
        title: link.title,
        url: link.url,
        state: 'draft' as const,
        iconFileId: link.customIconMetadata?.id ? Number(link.customIconMetadata.id) : null
      }))
    });
    setIsEditNotesDialogOpen(false);
    refetchGroupNotesResponse();
  };

  const handleBackFromEdit = () => {
    setIsEditNotesDialogOpen(false);
  };

  const handleImageChange = async (index: number, fileRequest: any, abortSignal?: AbortSignal) => {
    // TODO: Replace handleFileChange with notes image upload logic if different
    const result = await handleFileChange(fileRequest, abortSignal);
    return result;
  };

  const handleDeleteIcon = (index: number) => {
    // Handle icon deletion if needed
    console.log('Delete icon:', index);
  };

  const session = sessionDTO.data;
  const isCoach = session?.user?.roles?.includes('coach');

  if (!isCoach) {
    return (
      <DefaultError
        locale={currentLocale}
        title={t('error.accessDenied.title')}
        description={t('error.accessDenied.description')}
      />
    );
  }


  // @ts-ignore
  groupIntroductionPresenter.present(groupIntroductionResponse, groupIntroductionViewModel);
  // @ts-ignore
  notesPresenter.present(groupNotesResponse, groupNotesViewModel);
  // @ts-ignore
  nextSessionPresenter.present(nextSessionResponse, nextSessionViewModel);

  if (!groupIntroductionViewModel || !groupNotesViewModel || !nextSessionViewModel || !membersViewModel || !assignmentsViewModel) {
    return <DefaultLoading locale={currentLocale} variant="minimal" />;
  }

  if (groupIntroductionViewModel.mode === 'kaboom' || groupNotesViewModel.mode === 'kaboom' || nextSessionViewModel.mode === 'kaboom' || assignmentsViewModel.mode === 'kaboom' || membersViewModel.mode === 'kaboom') {
    return (
      <DefaultError
        locale={currentLocale}
        title={t('error.title')}
        description={t('error.description')}
      />
    );
  }

  if (groupIntroductionViewModel.mode === 'not-found' || groupNotesViewModel.mode === 'not-found' || nextSessionViewModel.mode === 'not-found' || assignmentsViewModel.mode === 'not-found' || membersViewModel.mode === 'not-found') {
    return (
      <DefaultError
        locale={currentLocale}
        title={t('error.title')}
        description={t('error.description')}
      />
    );
  }

  // Success state 
  const introductionData = groupIntroductionViewModel.data;
  const notesData = groupNotesViewModel.data;
  const nextSessionData = nextSessionViewModel.data;

  // Breadcrumb items for navigation
  const breadcrumbItems = [
    {
      label: breadcrumbsTranslations('home'),
      onClick: () => router.push(`/${locale}`),
    },
    {
      label: breadcrumbsTranslations('workspace'),
      onClick: () => router.push(`/${locale}/workspace`),
    },
    {
      label: breadcrumbsTranslations('yourCourses'),
      onClick: () => router.push(`/${locale}/workspace/courses`),
    },
    {
      label: courseSlug,
      onClick: () => router.push(`/${locale}/workspace/courses/${courseSlug}`),
    },
    {
      label: breadcrumbsTranslations('groups'),
      onClick: () => router.push(`/${locale}/workspace/courses/${courseSlug}/groups`),
    },
    {
      label: introductionData.name,
      onClick: () => router.push(`/${locale}/workspace/courses/${courseSlug}/groups/${groupId}`),
    },
  ];

  // Function to render StudentCard based on member data and status
  const renderStudentCard = (member: typeof allMembers[0]) => {
    // Base props common to all student card variants
    const baseProps = {
      locale: locale,
      studentName: `${member.name} ${member.surname}`,
      studentImageUrl: member.avatarUrl || '',
      coachName: `${member.coach.name} ${member.coach.surname}`,
      coachImageUrl: member.coach.avatarUrl || '',
      courseName: member.course.title,
      courseImageUrl: member.course.imageUrl || '',
      coachingSessionsLeft: member.coachingSessionCount || undefined,
      isYou: member.coach.isCurrentUser,
      onStudentDetails: () => console.log("Click on student"),
      onClickCourse: () => console.log("Click on course"),
      onClickCoach: () => console.log("Click on coach"),
    };

    // Handle different status cases based on lastAssignment
    if (!member.lastAssignment) {
      // No assignment case
      return (
        <StudentCard
          {...baseProps}
          key={member.id}
          status="no-assignment"
        />
      );
    }

    const { status, title } = member.lastAssignment;

    if (status === "waiting-feedback") {
      return (
        <StudentCard
          {...baseProps}
          status="waiting-feedback"
          assignmentTitle={title}
          onViewAssignment={() => console.log("View assignment:", member.lastAssignment?.id)}
        />
      );
    }

    if (status === "long-wait") {
      return (
        <StudentCard
          {...baseProps}
          status="long-wait"
          assignmentTitle={title}
          onViewAssignment={() => console.log("View assignment:", member.lastAssignment?.id)}
        />
      );
    }

    if (status === "course-completed") {
      return (
        <StudentCard
          {...baseProps}
          status="course-completed"
          completedCourseDate={new Date()} // TODO: Add completion date from member data when available
        />
      );
    }

    // Fallback to no-assignment if status is unknown
    return (
      <StudentCard
        {...baseProps}
        status="no-assignment"
      />
    );
  };

  return (
    <div className="flex flex-col space-y-10">
      {/* Section: Group Introduction */}
      <div className='flex flex-col gap-4'>
        <div className='flex flex-col gap-3'>
          <Breadcrumbs items={breadcrumbItems} />
          <h5 className='text-text-primary md:text-lg text-md font-bold leading-[120%]'>
            {t('title')}
          </h5>
          <p className='text-text-secondary text-sm md:text-md'>
            {t('description')}
          </p>
        </div>
        <GroupIntroduction
          groupName={introductionData.name}
          courseName={introductionData.course.title}
          // TODO: In getGroupIntroduction response we need single coach instead of array
          isYou={introductionData.coaches[0].isCurrentUser}
          coachName={`${introductionData.coaches[0].name} ${introductionData.coaches[0].surname}`}
          courseImageUrl={introductionData.course.imageUrl || ''}
          coachImageUrl={introductionData.coaches[0].avatarUrl || ''}
          actualStudentCount={introductionData.actualStudentCount}
          maxStudentCount={introductionData.maxStudentCount}
          locale={locale}
          onClickCourse={() => router.push(`/${locale}/workspace/courses/${courseSlug}`)}
          onClickUser={() => {
            // TODO: Navigate to coach profile page
            console.log('Navigate to user')
          }}
        />
      </div>

      {/* Section: Group Notes (saveGroupNotes, getGroupNotes) */}
      <div className="flex gap-4 items-start flex-col md:flex-row lg:flex-row">
        {/* Notes section*/}
        <div className='flex flex-col gap-4 w-full'>
          <div className='flex  gap-7 items-center'>
            <h3 className='text-text-primary md:text-2xl text-xl font-bold leading-[110%]'>
              {t('notes.title')}
            </h3>
            {/* Only show edit button when notes data exists */}
            {notesData.notes !== '' || (notesData.links && notesData.links.length > 0) ? (
              <Button
                variant="text"
                text={t('notes.editButton')}
                onClick={handleEditNotesClick}
                hasIconLeft
                iconLeft={<IconEdit />}
              />
            ) : null}
          </div>
          {notesData.notes === '' && (!notesData.links || notesData.links.length === 0) ? (
            <CoachNotesCreate
              noteDescription={noteDescription}
              noteLinks={noteLinks}
              includeInMaterials={includeInMaterials}
              locale="en"
              onPublish={handlePublishNotes}
              onImageChange={handleImageChange}
              onDeleteIcon={handleDeleteIcon}
              onNoteLinksChange={setNoteLinks}
              onIncludeInMaterialsChange={setIncludeInMaterials}
              onNoteDescriptionChange={setNoteDescription}
              isEditMode={false}
              onBack={() => console.log('onBack clicked')}
            />
          ) :
            <CoachNotesView
              noteDescription={notesData.notes}
              // TODO: Change this mapping once notesData.links structure matches with CoachNotesView props
              noteLinks={notesData.links?.map(link => ({
                url: link.url || '',
                title: link.title,
                customIconMetadata: link.icon ? {
                  id: link.icon.id,
                  name: link.icon.name,
                  size: link.icon.size,
                  status: 'available' as const,
                  category: link.icon.category,
                  url: link.icon.downloadUrl,
                  thumbnailUrl: null,
                } : undefined,
              }))}
              locale="en"
              onExploreCourses={() => alert('onExploreCourses')}
            />
          }
        </div>

        {/* Next coaching session */}
        <div className='flex flex-col gap-4 md:w-fit lg:w-fit w-full'>
          <div className='flex items-center justify-between w-full gap-7'>
            <h3 className='text-text-primary md:text-2xl text-xl font-bold leading-[110%] whitespace-nowrap'>
              {t('nextCoachingSession.title')}
            </h3>
            <Button
              variant="text"
              text={t('nextCoachingSession.closedSessionsButton')}
              onClick={() => {
                // TODO: Implement view closed sessions functionality
                console.log('View closed is clicked')
              }}
            />
          </div>
          {/* Group Coaching Sessions */}
          {nextSessionData.nextSession ? (
            <CoachingSessionGroupOverviewCard
              userType='coach'
              status='unscheduled'
              locale={locale}
              title={nextSessionData.nextSession.coachingOfferingTitle}
              duration={nextSessionData.nextSession.coachingOfferingDuration}
              withinCourse={true}
              courseName={nextSessionData.nextSession.course.title}
              courseImageUrl={nextSessionData.nextSession.course.imageUrl || ''}
              groupName={nextSessionData.nextSession.groupName}
              onClickCourse={() => {
                if (nextSessionData?.nextSession?.course.slug) {
                  router.push(`/${locale}/workspace/courses/${nextSessionData?.nextSession?.course.slug}`)
                }
              }}
              onClickGroup={() => {
                if (nextSessionData?.nextSession?.course.slug && nextSessionData?.nextSession?.groupId) {
                  router.push(`/${locale}/workspace/courses/${nextSessionData?.nextSession?.course.slug}/groups/${nextSessionData?.nextSession?.groupId}`)
                }
              }}
              onClickScheduleSession={() => {
                // TODO: Implement schedule session functionality
                console.log('Schedule session clicked');
              }}
            />
          ) : (
            <div className='flex items-center justify-center py-16'>
              <p className='text-text-secondary text-sm md:text-md'>
                {t('nextCoachingSession.noSession')}
              </p>
            </div>
          )}
        </div>
      </div>

      {/* Section: Group Assignments (listGroupAssignments) */}
      <div className="flex flex-col gap-4 w-full">
        <div className='flex items-center justify-between w-full flex-wrap gap-4'>
          <h3 className='text-text-primary md:text-2xl text-xl font-bold leading-[110%]'>
            {t('assignments.title')}
          </h3>
          <div className="flex items-center gap-2 flex-wrap">
            <div className="flex items-center gap-2 ">
              <p className="text-sm text-text-primary">
                {t('assignments.sortBy')}
              </p>
              <div className="w-48">
                <Dropdown
                  type="simple"
                  options={sortOptions}
                  onSelectionChange={handleSortChange}
                  defaultValue={sortBy}
                  text={{ simpleText: t('assignments.selectSort') }}
                />
              </div>
            </div>
            <Button
              variant="secondary"
              size="medium"
              text={t('assignments.filterButton')}
              onClick={handleOpenFilterModal}
              hasIconLeft
              iconLeft={<IconFilter />}
              className="w-auto"
            />
          </div>
        </div>
        <AssignmentOverviewList locale={locale}>
          {sortedAndFilteredAssignments.map((assignment) => {
            // Transform assignment to add missing isCurrentUser property
            const transformedAssignment = {
              ...assignment,
              lastReply: assignment.lastReply ? {
                ...assignment.lastReply,
                sender: {
                  ...assignment.lastReply.sender,
                  // TODO: Replace with actual current user check once backend provides this field
                  isCurrentUser: false // Hardcoded as requested
                }
              } : assignment.lastReply
            };

            return (
              <AssignmentOverview
                key={assignment.id}
                {...transformedAssignment}
                locale={locale}
                role="coach"
                onClickCourse={() => console.log("Course is clicked")}
                onClickUser={() => console.log("User is clicked")}
                onClickView={() => console.log("View assignment clicked")}
                onClickGroup={() => console.log("Group is clicked")}
                onFileDownload={(downloadUrl: string) => console.log("Download file:", downloadUrl)}
              />
            );
          })}
        </AssignmentOverviewList>
      </div>

      {/* Section: Group Members (listGroupMembers) */}
      <div className='flex flex-col gap-4 w-full'>
        <div className='flex items-center justify-between w-full flex-wrap gap-4'>
          <h3 className='text-text-primary md:text-2xl text-xl font-bold items-center'>
            {t('members.title')}
          </h3>
          <div className='flex w-full md:w-fit lg:w-fit'>
            <div className='flex-1'>
              <TextInput
                inputField={{
                  id: 'search',
                  className: 'w-full',
                  value: search,
                  setValue: setSearch,
                  inputText: t('members.searchstudent'),
                  hasLeftContent: true,
                  leftContent: <IconSearch />,
                }}
              />
            </div>
          </div>
        </div>
        <StudentCardList locale={locale}>
          {filteredMembers.map((member) => renderStudentCard(member))}
        </StudentCardList>
      </div>

      {/* Assignment Filter Modal */}
      {showFilterModal && (
        <AssignmentCardFilterModal
          onApplyFilters={handleApplyFilters}
          onClose={handleCloseFilterModal}
          initialFilters={filters}
          availableStatuses={availableStatuses}
          availableCourses={availableCourses}
          availableModules={availableModules}
          availableLessons={availableLessons}
          locale={locale}
        />
      )}

      {/* Coach Notes Edit Dialog */}
      <CoachNotesEditDialog
        isOpen={isEditNotesDialogOpen}
        onOpenChange={setIsEditNotesDialogOpen}
        noteDescription={notesData.notes}
        noteLinks={notesData.links?.map(link => ({
          url: link.url || '',
          title: link.title,
          customIconMetadata: link.icon ? {
            id: link.icon.id,
            name: link.icon.name,
            size: link.icon.size,
            status: 'available' as const,
            category: link.icon.category,
            url: link.icon.downloadUrl,
            thumbnailUrl: null,
          } : undefined,
        })) || []}
        includeInMaterials={includeInMaterials}
        locale={locale}
        onPublish={handlePublishNotes}
        onBack={handleBackFromEdit}
        onImageChange={handleImageChange}
        onDeleteIcon={handleDeleteIcon}
        onNoteLinksChange={setNoteLinks}
        onIncludeInMaterialsChange={setIncludeInMaterials}
        onNoteDescriptionChange={setNoteDescription}
        isEditMode={true}
      />
    </div>
  );
}
