'use client';

// Auto-generated by page-scaffold command
// Notion: https://www.notion.so/Group-Coaching-Session-Reviews-Tab-2245a7432d0180cf9b1ac4b112ae9d8f
// Feature: listGroupCoachingSessionReviews
// UI Components: CourseReviewFilterModal, GroupCoachingSessionReviews Banner
// User Type: Coach

import { useState, useEffect, useMemo } from 'react';
import { useLocale, useTranslations } from 'next-intl';
import { useSession } from 'next-auth/react';
import { getDictionary, TLocale } from '@maany_shr/e-class-translations';
import { viewModels } from '@maany_shr/e-class-models';
import { DefaultLoading, DefaultError, CoachReviewCard, Breadcrumbs, Button, IconFilter, CoachReviewFilterModal, GroupCoachingSessionReviewsBanner } from '@maany_shr/e-class-ui-kit';
import type { CoachReviewFilterModel } from '@maany_shr/e-class-ui-kit';
import { trpc } from '../trpc/cms-client';
import { useListGroupCoachingSessionReviewsPresenter } from '../hooks/use-list-group-coaching-session-reviews-presenter';
import useClientSidePagination from '../utils/use-client-side-pagination';
import { useRouter } from 'next/navigation';
import { useGetGroupIntroductionPresenter } from '../hooks/use-get-group-introduction-presenter';

interface GroupCoachingSessionReviewsProps {
    locale: TLocale;
    courseSlug: string;
    groupId: number;
    coachingSessionId: number;
}

export default function GroupCoachingSessionReviews({
    locale: localeProp,
    courseSlug,
    groupId,
    coachingSessionId,
}: GroupCoachingSessionReviewsProps) {
    const currentLocale = useLocale() as TLocale;
    const t = useTranslations('pages.groupCoachingSessionReviews');
    const breadcrumbsTranslations = useTranslations('components.breadcrumbs');
    const paginationTranslations = useTranslations('components.paginationButton');
    const dictionary = getDictionary(localeProp);
    const { data: session, status } = useSession();

    const route = useRouter();

    // Fetch data using TRPC
    const [reviewsResponse] = trpc.listGroupCoachingSessionReviews.useSuspenseQuery({
        coachingSessionId,
    });

    const [groupIntroductionResponse] = trpc.getGroupIntroduction.useSuspenseQuery({
        courseSlug: courseSlug,
        additionalParams: {
            groupId: groupId,
            requestType: "requestForCoach",
        }
    });

    // View model state
    const [reviewsViewModel, setReviewsViewModel] = useState<
        viewModels.TListGroupCoachingSessionReviewsViewModel | undefined
    >(undefined);

    const [groupIntroductionViewModel, setGroupIntroductionViewModel] = useState<
        viewModels.TGetGroupIntroductionViewModel | undefined
    >(undefined);

    // Filter states
    const [showFilterModal, setShowFilterModal] = useState(false);
    const [filters, setFilters] = useState<CoachReviewFilterModel>({
        maxRating: 5,
        minRating: 1,
        dateBefore: '',
        dateAfter: ''
    });

    // Initialize presenter
    const { presenter } = useListGroupCoachingSessionReviewsPresenter(setReviewsViewModel);
    const { presenter: groupIntroPresenter } = useGetGroupIntroductionPresenter(setGroupIntroductionViewModel);

    // Present data to view model
    useEffect(() => {
        // @ts-ignore - Presenter type compatibility issue
        presenter.present(reviewsResponse, reviewsViewModel);
    }, [reviewsResponse, presenter, reviewsViewModel]);

    // @ts-ignore
    groupIntroPresenter.present(groupIntroductionResponse, groupIntroductionViewModel);

    // Get reviews data or use empty array for filtering
    const allReviews = useMemo(() => {
        if (!reviewsViewModel || reviewsViewModel.mode !== 'default') {
            return [];
        }
        return reviewsViewModel.data.reviews;
    }, [reviewsViewModel]);

    // Apply filters to the reviews using useMemo for performance
    const filteredReviews = useMemo(() => {
        return allReviews.filter(review => {
            const rating = review.rating;
            const date = new Date(review.createdAt);

            // Apply rating filters
            if (rating < (filters.minRating || 1) || rating > (filters.maxRating || 5)) {
                return false;
            }

            // Apply date filters
            if (filters.dateBefore) {
                const beforeDate = new Date(filters.dateBefore);
                if (date > beforeDate) return false;
            }

            if (filters.dateAfter) {
                const afterDate = new Date(filters.dateAfter);
                if (date < afterDate) return false;
            }

            return true;
        });
    }, [allReviews, filters]);

    // Pagination for reviews
    const {
        displayedItems: displayedReviews,
        hasMoreItems: hasMoreReviews,
        handleLoadMore: handleLoadMoreReviews,
    } = useClientSidePagination({
        items: filteredReviews,
        itemsPerPage: 6,
        itemsPerPage2xl: 9,
    });

    // Loading state
    if (status === 'loading' || !reviewsViewModel || !groupIntroductionViewModel) {
        return <DefaultLoading locale={currentLocale} variant="minimal" />;
    }

    // Authentication check
    if (!session) {
        return (
            <DefaultError
                type="simple"
                locale={currentLocale}
                title={t('error.title')}
                description={t('error.description')}
            />
        );
    }

    // Error handling
    if (reviewsViewModel.mode === 'kaboom' || groupIntroductionViewModel.mode === 'kaboom') {
        return (
            <DefaultError
                type="simple"
                locale={currentLocale}
                title={t('error.title')}
                description={t('error.description')}
            />
        );
    }

    if (reviewsViewModel.mode === 'not-found' || groupIntroductionViewModel.mode === 'not-found') {
        return (
            <DefaultError
                type="simple"
                locale={currentLocale}
                title={t('error.title')}
                description={t('error.description')}
            />
        );
    }

    const reviewsData = reviewsViewModel.data;
    const groupIntroductionData = groupIntroductionViewModel.data;

    return (
        <div className="flex flex-col space-y-5">
            <Breadcrumbs
                items={[
                    {
                        label: breadcrumbsTranslations('home'),
                        onClick: () => {
                            route.push(`/${localeProp}`);
                        },
                    },
                    {
                        label: breadcrumbsTranslations('workspace'),
                        onClick: () => {
                            route.push(`/${localeProp}/workspace`);
                        },
                    },
                    {
                        label: breadcrumbsTranslations('yourCourses'),
                        onClick: () => route.push(`/${localeProp}/workspace/courses`),
                    },
                    {
                        label: courseSlug,
                        onClick: () => route.push(`/${localeProp}/workspace/courses/${courseSlug}`),
                    },
                    {
                        label: breadcrumbsTranslations('groups'),
                        onClick: () => route.push(`/${localeProp}/workspace/courses/${courseSlug}/groups`),
                    },
                    {
                        label: groupIntroductionData.name,
                        onClick: () => route.push(`/${localeProp}/workspace/courses/${courseSlug}/groups/${groupId}`),
                    },
                    {
                        label: breadcrumbsTranslations('coachingSessionReviews'),
                        onClick: () => route.push(`/${localeProp}/workspace/courses/${courseSlug}/groups/${groupId}/coaching-sessions`),
                    },
                ]}
            />
            <div className='flex flex-col gap-4'>
                <div className='flex flex-col gap-2'>
                    <h6 className='text-text-secondary text-sm md:text-md leading-[120%]'>
                        {groupIntroductionData.name}
                    </h6>
                    <h2 className='text-text-primary md:text-3xl text-xl font-bold'>
                        {t('title')}
                    </h2>
                    <p className='text-text-secondary text-sm md:text-md'>
                        {t('description')}
                    </p>
                </div>
                
                <div className="w-full flex items-center justify-between gap-4">
                    <GroupCoachingSessionReviewsBanner
                        reviewCount={reviewsData.reviewCount}
                        averageRating={Math.round((reviewsData.averageRating || 0) * 100) / 100}
                        studentCount={reviewsData.studentCount}
                        locale={localeProp}
                    />
                    {/* Filter Button */}
                    <Button
                        variant="secondary"
                        size="medium"
                        text={dictionary.components.coachReviewFilterModal.filterButton}
                        onClick={() => setShowFilterModal(true)}
                        hasIconLeft
                        iconLeft={<IconFilter />}
                        className="w-auto"
                    />
                </div>

                {/* Reviews with pagination */}
                {displayedReviews.length > 0 ? (
                    <>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 w-full">
                            {displayedReviews.map((review) => (
                                <CoachReviewCard
                                    key={review.id}
                                    type="with-group"
                                    locale={localeProp}
                                    rating={review.rating}
                                    reviewerName={review.student.username}
                                    reviewerAvatar={review.student.avatarUrl || undefined}
                                    reviewText={review.notes || ""}
                                    workshopTitle={review.coachingOfferingTitle}
                                    date={review.createdAt}
                                    time={new Date(review.createdAt).toLocaleTimeString(localeProp)}
                                    groupName={review.group.name}
                                    onClickReviewer={() => window.open(`/${localeProp}/students/${review.student.username}`, '_blank')}
                                />
                            ))}
                        </div>
                        {hasMoreReviews && (
                            <div className="flex justify-center items-center w-full mt-6">
                                <Button
                                    variant="text"
                                    text={paginationTranslations('loadMore')}
                                    onClick={handleLoadMoreReviews}
                                />
                            </div>
                        )}
                    </>
                ) : (
                    <div className="flex items-center justify-center py-16">
                        <p className="text-text-secondary md:text-xl text-lg">
                            {allReviews.length === 0 ? t('groupHasNoReviews') : t('noReviewsFound')}
                        </p>
                    </div>
                )}
            </div>

            {/* Coach Review Filter Modal */}
            {showFilterModal && (
                <CoachReviewFilterModal
                    onApplyFilters={(f) => setFilters(f)}
                    onClose={() => setShowFilterModal(false)}
                    initialFilters={filters}
                    locale={localeProp}
                />
            )}
        </div>
    );
}