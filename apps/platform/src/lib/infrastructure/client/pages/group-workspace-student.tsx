'use client';

// Auto-generated by page-scaffold command v2
// Usecases: getGroupNotes, listGroupAssignments, listGroupMembers, getGroupNextCoachingSession
// Features: Group notes tracking, assignments tracking, member management, coaching session tracking
// User Types: Student
// Figma: https://www.figma.com/design/8KEwRuOoD5IgxTtFAtLlyS/Just_Do_Ad-1.2?node-id=6913-292532

import { useState, Suspense } from 'react';
import { TLocale } from '@maany_shr/e-class-translations';
import { trpc } from '../trpc/cms-client';
import { DefaultLoading, DefaultError, Breadcrumbs, GroupIntroduction, Button, CoachNotesView, Dropdown, IconFilter, AssignmentCardFilterModal, TextInput, IconSearch, StudentCardList, StudentCard, CoachingSessionGroupOverviewCard, AssignmentOverview, AssignmentOverviewList, downloadFile, Dialog, DialogContent } from '@maany_shr/e-class-ui-kit';
import { useLocale, useTranslations } from 'next-intl';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { viewModels } from '@maany_shr/e-class-models';
import { useGetGroupIntroductionPresenter } from '../hooks/use-get-group-introduction-presenter';
import { useGetGroupNotesPresenter } from '../hooks/use-get-group-notes-presenter';
import { useGetGroupNextCoachingSessionPresenter } from '../hooks/use-get-group-next-coaching-session-presenter';
import { useAssignmentFilters } from './hooks/use-assignment-filters';
import { useGroupMembers } from './hooks/use-group-members';
import useClientSidePagination from '../utils/use-client-side-pagination';
import AssignmentContent from './course/enrolled-course/assignment-content';

interface GroupWorkspaceStudentProps {
  locale: TLocale;
  courseSlug: string;
  groupId?: number;
}

export default function GroupWorkspaceStudent({
  locale,
  courseSlug,
  groupId,
}: GroupWorkspaceStudentProps) {
  const currentLocale = useLocale() as TLocale;
  const router = useRouter();
  const t = useTranslations('pages.groupWorkspaceStudent');
  const breadcrumbsTranslations = useTranslations('components.breadcrumbs');
  const paginationTranslations = useTranslations('components.paginationButton');

  // Authentication using Pattern B (Student role only)
  const sessionDTO = useSession();

  const [groupIntroductionViewModel, setGroupIntroductionViewModel] = useState<
    viewModels.TGetGroupIntroductionViewModel | undefined
  >(undefined);

  const [groupNotesViewModel, setGroupNotesViewModel] = useState<
    viewModels.TGetGroupNotesViewModel | undefined
  >(undefined);

  const [nextSessionViewModel, setNextSessionViewModel] = useState<
    viewModels.TGetGroupNextCoachingSessionViewModel | undefined
  >(undefined);

  // State for assignment modal
  const [selectedAssignment, setSelectedAssignment] = useState<{
    id: string;
    studentUsername?: string;
  } | null>(null);

  // TRPC queries for page data

  // Fetch group introduction from getGroupIntroduction usecase
  const [groupIntroductionResponse] = trpc.getGroupIntroduction.useSuspenseQuery({
    courseSlug: courseSlug,
    additionalParams: {
      requestType: 'requestForStudent',
    }
  });

  // Fetch group notes from getGroupNotes usecase
  const [groupNotesResponse] = trpc.getGroupNotes.useSuspenseQuery({
    courseSlug: courseSlug,
    additionalParams: {
      requestType: 'requestForStudent',
    }
  });

  // Fetch next coaching session from getGroupNextCoachingSession usecase
  const [nextSessionResponse] = trpc.getGroupNextCoachingSession.useSuspenseQuery({
    courseSlug: courseSlug,
    additionalParams: {
      requestType: 'requestForStudent',
    }
  });

  const { presenter: groupIntroductionPresenter } = useGetGroupIntroductionPresenter(setGroupIntroductionViewModel);
  const { presenter: notesPresenter } = useGetGroupNotesPresenter(setGroupNotesViewModel);
  const { presenter: nextSessionPresenter } = useGetGroupNextCoachingSessionPresenter(setNextSessionViewModel);

  // Assignment filters and sorting hook (includes data fetching and presenter logic)
  const {
    filters,
    sortBy,
    showFilterModal,
    assignmentsViewModel,
    isLoading: isAssignmentsLoading,
    sortedAndFilteredAssignments,
    availableStatuses,
    availableCourses,
    availableModules,
    availableLessons,
    handleApplyFilters,
    handleSortChange,
    handleOpenFilterModal,
    handleCloseFilterModal,
    resetFilters,
  } = useAssignmentFilters({
    courseSlug,
    initialFilters: {},
    requestType: 'requestForStudent',
  });

  // Group members hook (includes data fetching, presenter logic, and search)
  const {
    search,
    setSearch,
    membersViewModel,
    isLoading: isMembersLoading,
    filteredMembers,
    allMembers,
    clearSearch,
  } = useGroupMembers({
    courseSlug,
    requestType: 'requestForStudent',
  });

  // Sort options for dropdown
  const sortOptions = [
    { value: 'title', label: t('assignments.sortOptions.title') },
    { value: 'status', label: t('assignments.sortOptions.status') },
    { value: 'date', label: t('assignments.sortOptions.date') },
    { value: 'student', label: t('assignments.sortOptions.student') },
  ];

  const session = sessionDTO.data;
  const isStudent = session?.user?.roles?.includes('student');

  // Pagination for assignments
  const {
    displayedItems: displayedAssignments,
    hasMoreItems: hasMoreAssignments,
    handleLoadMore: handleLoadMoreAssignments,
  } = useClientSidePagination({
    items: sortedAndFilteredAssignments,
    itemsPerPage: 3,
    itemsPerPage2xl: 4,
  });

  // Pagination for members
  const {
    displayedItems: displayedMembers,
    hasMoreItems: hasMoreMembers,
    handleLoadMore: handleLoadMoreMembers,
  } = useClientSidePagination({
    items: filteredMembers,
    itemsPerPage: 3,
    itemsPerPage2xl: 4,
  });

  if (!isStudent) {
    return (
      <DefaultError
        type="simple"
        locale={currentLocale}
        title={t('error.accessDenied.title')}
        description={t('error.accessDenied.description')}
      />
    );
  }

  // @ts-ignore
  groupIntroductionPresenter.present(groupIntroductionResponse, groupIntroductionViewModel);
  // @ts-ignore
  notesPresenter.present(groupNotesResponse, groupNotesViewModel);
  // @ts-ignore
  nextSessionPresenter.present(nextSessionResponse, nextSessionViewModel);


  if (!groupIntroductionViewModel || !groupNotesViewModel || !nextSessionViewModel || !membersViewModel || !assignmentsViewModel) {
    return <DefaultLoading locale={currentLocale} variant="minimal" />;
  }

  if (groupIntroductionViewModel.mode === 'kaboom' || groupNotesViewModel.mode === 'kaboom' || nextSessionViewModel.mode === 'kaboom' || assignmentsViewModel.mode === 'kaboom' || membersViewModel.mode === 'kaboom') {
    return (
      <DefaultError
        type="simple"
        locale={currentLocale}
        title={t('error.title')}
        description={t('error.description')}
      />
    );
  }

  if (groupIntroductionViewModel.mode === 'not-found' || groupNotesViewModel.mode === 'not-found' || nextSessionViewModel.mode === 'not-found' || assignmentsViewModel.mode === 'not-found' || membersViewModel.mode === 'not-found') {
    return (
      <DefaultError
        type="simple"
        locale={currentLocale}
        title={t('error.title')}
        description={t('error.description')}
      />
    );
  }

  // Success state 
  const introductionData = groupIntroductionViewModel.data;
  const notesData = groupNotesViewModel.data;
  const nextSessionData = nextSessionViewModel.data;

  // Breadcrumb items for navigation (simplified for student view)
  const breadcrumbItems = [
    {
      label: breadcrumbsTranslations('home'),
      onClick: () => router.push(`/${locale}`),
    },
    {
      label: breadcrumbsTranslations('yourCourses'),
      onClick: () => router.push(`/${locale}/workspace/courses`),
    },
    {
      label: introductionData.course.title,
      onClick: () => router.push(`/${locale}/courses/${courseSlug}`),
    },
    {
      label: breadcrumbsTranslations('groupLabel').replace('{name}', introductionData.name),
      onClick: () => router.push(`/${locale}/courses/${courseSlug}/group`),
    },
  ];

  // Function to render StudentCards based on members data and status
  const renderStudentCards = (members: viewModels.TListGroupMembersSuccess['members']) => {
    return members.map((member, index) => {
      // Base props common to all student card variants
      // Note: onStudentDetails is intentionally omitted - students can't view other students' profiles
      const baseProps = {
        locale: locale,
        studentName: member.username,
        studentImageUrl: member.avatarUrl || '',
        coachName: `${member.coach.name} ${member.coach.surname}`,
        coachImageUrl: member.coach.avatarUrl || '',
        courseName: member.course.title,
        courseImageUrl: member.course.imageUrl || '',
        coachingSessionsLeft: member.coachingSessionCount || undefined,
        isYou: member.coach.isCurrentUser,
        onClickCourse: () => {
          router.push(`/${locale}/courses/${member.course.slug}`)
        },
        onClickCoach: () => {
          router.push(`/${locale}/coaches/${member.coach.username}`)
        },
      };

      const key = member.id ?? index;

      // Check course completion FIRST - if courseCompletionDate is set, student completed the course
      if (member.courseCompletionDate) {
        return (
          <StudentCard
            {...baseProps}
            key={key}
            status="passed"
            completedCourseDate={new Date(member.courseCompletionDate)}
          />
        );
      }

      // Then check assignment status
      if (!member.lastAssignment) {
        // No assignment case
        return (
          <StudentCard
            {...baseProps}
            key={key}
            status="no-assignment"
          />
        );
      }

      const { id: assignmentId, status, title } = member.lastAssignment;

      if (status === "waiting-feedback") {
        return (
          <StudentCard
            {...baseProps}
            key={key}
            status="waiting-feedback"
            assignmentTitle={title}
            onViewAssignment={() => {
              setSelectedAssignment({
                id: assignmentId,
                studentUsername: member.username,
              });
            }}
          />
        );
      }

      if (status === "long-wait") {
        return (
          <StudentCard
            {...baseProps}
            key={key}
            status="long-wait"
            assignmentTitle={title}
            onViewAssignment={() => {
              setSelectedAssignment({
                id: assignmentId,
                studentUsername: member.username,
              });
            }}
          />
        );
      }

      if (status === "passed") {
        // Assignment passed but course not yet completed
        return (
          <StudentCard
            {...baseProps}
            key={key}
            status="assignment-passed"
            assignmentTitle={title}
          />
        );
      }

      // Fallback to no-assignment if status is unknown
      return (
        <StudentCard
          {...baseProps}
          key={key}
          status="no-assignment"
        />
      );
    });
  };

  return (
    <div className="flex flex-col space-y-10">
      {/* Section: Group Introduction */}
      <div className='flex flex-col gap-4'>
        <div className='flex flex-col gap-3'>
          <Breadcrumbs items={breadcrumbItems} />
          <h5 className='text-text-primary md:text-lg text-md font-bold leading-[120%]'>
            {t('title')}
          </h5>
          <p className='text-text-secondary text-sm md:text-md'>
            {t('description')}
          </p>
        </div>
        <GroupIntroduction
          groupName={introductionData.name}
          courseName={introductionData.course.title}
          coaches={introductionData.coaches}
          courseImageUrl={introductionData.course.imageUrl || ''}
          actualStudentCount={introductionData.actualStudentCount}
          maxStudentCount={introductionData.maxStudentCount}
          locale={locale}
          onClickCourse={() => router.push(`/${locale}/courses/${courseSlug}`)}
          onClickUser={(username) => {
            router.push(`/${locale}/coaches/${username}`);
          }}
        />
      </div>

      {/* Section: Group Notes (saveGroupNotes, getGroupNotes) */}
      <div className="flex gap-4 items-start w-full flex-col md:flex-row lg:flex-row">
        {/* Notes section*/}
        <div className='flex flex-col gap-4 w-full'>
          <h3 className='text-text-primary md:text-2xl text-xl font-bold leading-[110%] text-left'>
            {t('notes.title')}
          </h3>
          <CoachNotesView
            noteDescription={notesData.notes}
            noteLinks={notesData.links?.map(link => ({
              url: link.url || '',
              title: link.title,
              customIconMetadata: link.icon ? {
                id: link.icon.id,
                name: link.icon.name,
                size: link.icon.size,
                status: 'available' as const,
                category: link.icon.category,
                url: link.icon.downloadUrl,
                thumbnailUrl: link.icon.downloadUrl,
              } : undefined,
            }))}
            locale={locale}
            onExploreCourses={() => {
              // No action needed on back for create mode
            }}
          />
        </div>

        {/* Next coaching session */}
        <div className='flex flex-col gap-4 md:w-fit lg:w-fit w-full'>
          <div className='flex items-center justify-between w-full gap-7'>
            <h3 className='text-text-primary md:text-2xl text-xl font-bold leading-[110%] whitespace-nowrap'>
              {t('nextCoachingSession.title')}
            </h3>
            <Button
              variant="text"
              text={t('nextCoachingSession.closedSessionsButton')}
              onClick={() => {
                // TODO: Implement view closed sessions functionality
              }}
            />
          </div>
          {/* Group Coaching Sessions */}
          {nextSessionData.nextSession ? (
            <CoachingSessionGroupOverviewCard
              userType='student'
              status='unscheduled'
              locale={locale}
              title={nextSessionData.nextSession.coachingOfferingTitle}
              duration={nextSessionData.nextSession.coachingOfferingDuration}
            />
          ) : (
            <div className='flex items-center justify-center py-16'>
              <p className='text-text-secondary text-sm md:text-md'>
                {t('nextCoachingSession.noSession')}
              </p>
            </div>
          )}
        </div>
      </div>

      {/* Section: Group Assignments (listGroupAssignments) */}
      <div className="flex flex-col gap-4 w-full">
        <div className='flex items-center justify-between w-full flex-wrap gap-4'>
          <h3 className='text-text-primary md:text-2xl text-xl font-bold leading-[110%]'>
            {t('assignments.title')}
          </h3>
          <div className="flex items-center gap-2 flex-wrap">
            <div className="flex items-center gap-2">
              <p className="text-sm text-text-primary">
                {t('assignments.sortBy')}
              </p>
              <div className="w-48">
                <Dropdown
                  type="simple"
                  options={sortOptions}
                  onSelectionChange={handleSortChange}
                  defaultValue={sortBy}
                  text={{ simpleText: t('assignments.selectSort') }}
                />
              </div>
            </div>
            <Button
              variant="secondary"
              size="medium"
              text={t('assignments.filterButton')}
              onClick={handleOpenFilterModal}
              hasIconLeft
              iconLeft={<IconFilter />}
              className="w-auto"
            />
          </div>
        </div>
        <AssignmentOverviewList locale={locale}>
          {displayedAssignments.map((assignment) =>
            <AssignmentOverview
              key={assignment.id}
              {...assignment}
              locale={locale}
              role="coach"
              onClickCourse={() => router.push(`/${locale}/courses/${assignment.course.slug}`)}
              onClickUser={() => {
                // TODO: Navigate to student profile page
              }}
              onClickView={() => {
                setSelectedAssignment({
                  id: assignment.id,
                  studentUsername: assignment.student?.username,
                });
              }}
              onClickGroup={() => router.push(`/${locale}/workspace/courses/${assignment.course.slug}/groups/${assignment.groupId}`)}
              onFileDownload={(url , name) => downloadFile(url, name)}
            />
          )}
        </AssignmentOverviewList>
        {hasMoreAssignments && (
          <div className="flex justify-center items-center w-full mt-6">
            <Button
              variant="text"
              text={paginationTranslations('loadMore')}
              onClick={handleLoadMoreAssignments}
            />
          </div>
        )}
      </div>

      {/* Section: Group Members (listGroupMembers) */}
      <div className='flex flex-col gap-4 w-full'>
        <div className='flex items-center justify-between w-full flex-wrap gap-4'>
          <h3 className='text-text-primary md:text-2xl text-xl font-bold items-center'>
            {t('members.title')}
          </h3>
          <div className='flex w-full md:w-fit lg:w-fit'>
            <div className='flex-1'>
              <TextInput
                inputField={{
                  id: 'search',
                  className: 'w-full',
                  value: search,
                  setValue: setSearch,
                  inputText: t('members.searchstudent'),
                  hasLeftContent: true,
                  leftContent: <IconSearch />,
                }}
              />
            </div>
          </div>
        </div>
        <StudentCardList locale={locale}>
          {renderStudentCards(displayedMembers)}
        </StudentCardList>
        {hasMoreMembers && (
          <div className="flex justify-center items-center w-full mt-6">
            <Button
              variant="text"
              text={paginationTranslations('loadMore')}
              onClick={handleLoadMoreMembers}
            />
          </div>
        )}
      </div>

      {/* Assignment Filter Modal */}
      {showFilterModal && (
        <AssignmentCardFilterModal
          onApplyFilters={handleApplyFilters}
          onClose={handleCloseFilterModal}
          initialFilters={filters}
          availableStatuses={availableStatuses}
          availableCourses={availableCourses}
          availableModules={availableModules}
          availableLessons={availableLessons}
          locale={locale}
        />
      )}

      {/* Assignment View Modal */}
      {selectedAssignment && (
        <Dialog
          open={!!selectedAssignment}
          defaultOpen={false}
          onOpenChange={(open) => {
            if (!open) {
              setSelectedAssignment(null);
            }
          }}
        >
          <DialogContent
            showCloseButton
            closeOnOverlayClick
            closeOnEscape
          >
            <Suspense fallback={<DefaultLoading locale={currentLocale} />}>
              <AssignmentContent
                assignmentId={selectedAssignment.id}
                studentUsername={selectedAssignment.studentUsername}
              />
            </Suspense>
          </DialogContent>
        </Dialog>
      )}
    </div>
  );
}