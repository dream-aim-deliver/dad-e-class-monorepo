'use client';

// Auto-generated by page-scaffold command
// Notion: https://www.notion.so/Coach-profile-student-view-book-coaching-outside-courses-4417f760c1a24df8986566bb342a5270
// Features: listCoachReviews, createCourseReview, getCoachIntroduction, getCoachProfileAccess, listCoachCourses
// API Endpoints: GET /{api_version}/{platform_id}/coach?username={username}
// User Types: Student
// Figma: https://www.figma.com/design/8KEwRuOoD5IgxTtFAtLlyS/Just_Do_Ad-1.2?node-id=5731-169364&t=n19jujPl9CMQvyEQ-4

import { viewModels } from '@maany_shr/e-class-models';
import { trpc } from '../trpc/cms-client';
import { useMemo, useState } from 'react';
import { DefaultLoading, DefaultError, DefaultNotFound, Button, Breadcrumbs, IconChevronLeft, BookSessionWith, BuyCoachingSessionBanner, CourseCardList, CourseCard, Dropdown, CoachReviewCardList, CoachReviewCard, IconFilter, CoachReviewFilterModel, CoachReviewFilterModal, ReviewModal, ReviewDisplay, ReviewDialog } from '@maany_shr/e-class-ui-kit';
import { useLocale, useTranslations } from 'next-intl';
import { TLocale } from '@maany_shr/e-class-translations';
import { useGetCoachIntroductionPresenter } from '../hooks/use-get-coach-introduction-presenter';
import { useListCoachReviewsPresenter } from '../hooks/use-list-coach-reviews-presenter';
import { useListCoachCoursesPresenter } from '../hooks/use-list-coach-courses-presenter';
import { useGetCoachProfileAccessPresenter } from '../hooks/use-get-coach-profile-access-presenter';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import useClientSidePagination from '../utils/use-client-side-pagination';
import { StudentCourseTab } from '../utils/course-tabs';

interface CoachProfileProps {
	locale: TLocale;
	username: string;
}

export default function CoachProfile({ username }: CoachProfileProps) {
	const locale = useLocale() as TLocale;
	const route = useRouter();
	const sessionDTO = useSession();
	const session = sessionDTO.data;
	const isLoggedIn = !!session;

	const coachProfileTranslations = useTranslations('pages.coachProfile');
	const breadcrumbsTranslations = useTranslations('components.breadcrumbs');
	const paginationTranslations = useTranslations(
		'components.paginationButton',
	);

	// Fetch coach profile access - determines if profile can be viewed
	const [coachProfileAccessResponse] = trpc.getCoachProfileAccess.useSuspenseQuery({
		coachUsername: username,
	});

	// Fetch coach introduction data
	const [coachIntroductionResponse] = trpc.getCoachIntroduction.useSuspenseQuery({
		coachUsername: username,
	});

	// Fetch coach reviews
	const [coachReviewsResponse, { refetch: refetchCoachReviews }] = trpc.listCoachReviews.useSuspenseQuery({
		coachUsername: username,
	});

	const [coachCoursesResponse, { refetch: refetchCoachCourses }] = trpc.listCoachCourses.useSuspenseQuery({
		forStudent: isLoggedIn,
		coachUsername: username,
	});

	// Mutation for creating course reviews - must be declared before any conditional returns
	const createReviewMutation = trpc.createCourseReview.useMutation();

	const [coachIntroductionViewModel, setCoachIntroductionViewModel] = useState<
		viewModels.TGetCoachIntroductionViewModel | undefined
	>(undefined);

	const [coachReviewsViewModel, setCoachReviewsViewModel] = useState<
		viewModels.TListCoachReviewsViewModel | undefined
	>(undefined);

	const [coachCoursesViewModel, setCoachCoursesViewModel] = useState<
		viewModels.TListCoachCoursesViewModel | undefined
	>(undefined);

	const [coachProfileAccessViewModel, setCoachProfileAccessViewModel] = useState<
		viewModels.TGetCoachProfileAccessViewModel | undefined
	>(undefined);

	// Sort and Filter states
	const [sortBy, setSortBy] = useState<string>('mostRecent');
	const [showFilterModal, setShowFilterModal] = useState(false);
	const [filters, setFilters] = useState<CoachReviewFilterModel>({
		maxRating: 5,
		minRating: 1,
		dateBefore: '',
		dateAfter: ''
	});

	// Review Modal states
	const [showReviewModal, setShowReviewModal] = useState<boolean>(false);
	const [showReviewSnippet, setShowReviewSnippet] = useState<boolean>(false);

	type CourseWithStatus = Extract<
		viewModels.TListCoachCoursesSuccess['courses'][number],
		{ status: unknown }
	>;

	const [reviewingCourse, setReviewingCourse] = useState<CourseWithStatus | null>(null);

	const [reviewSubmitted, setReviewSubmitted] = useState<boolean>(false);
	const [reviewError, setReviewError] = useState<boolean>(false);

	const { presenter: coachIntroductionPresenter } = useGetCoachIntroductionPresenter(
		setCoachIntroductionViewModel,
	);
	const { presenter: coachReviewsPresenter } = useListCoachReviewsPresenter(
		setCoachReviewsViewModel,
	);
	const { presenter: coachCoursesPresenter } = useListCoachCoursesPresenter(
		setCoachCoursesViewModel,
	);
	const { presenter: coachProfileAccessPresenter } = useGetCoachProfileAccessPresenter(
		setCoachProfileAccessViewModel,
	);

	// Present the data
	// @ts-ignore
	coachIntroductionPresenter.present(coachIntroductionResponse, coachIntroductionViewModel);
	// @ts-ignore
	coachReviewsPresenter.present(coachReviewsResponse, coachReviewsViewModel);
	// @ts-ignore
	coachCoursesPresenter.present(coachCoursesResponse, coachCoursesViewModel);
	// @ts-ignore
	coachProfileAccessPresenter.present(coachProfileAccessResponse, coachProfileAccessViewModel);


	const courses = useMemo(() => {
		if (!coachCoursesViewModel || coachCoursesViewModel.mode !== 'default' || !coachCoursesViewModel.data) {
			return [];
		}
		return coachCoursesViewModel.data.courses || [];
	}, [coachCoursesViewModel]);


	// Pagination for courses
	const { displayedItems: displayedCourses, hasMoreItems: hasMoreCourses, handleLoadMore: handleLoadMoreCourses } = useClientSidePagination({
		items: courses,
		itemsPerPage: 6,
		itemsPerPage2xl: 8,
	});

	const coachReviews = useMemo(() => {
		if (!coachReviewsViewModel || coachReviewsViewModel.mode !== 'default' || !coachReviewsViewModel.data) {
			return [];
		}
		return coachReviewsViewModel.data.reviews || [];
	}, [coachReviewsViewModel]);


	// Apply filters and sorting to reviews using useMemo for performance
	const filteredReviews = useMemo(() => {
		return coachReviews.filter(review => {
			const rating = review.rating;
			const date = new Date(review.createdAt);

			// Apply rating filters
			if (rating < (filters.minRating || 1) || rating > (filters.maxRating || 5)) {
				return false;
			}

			// Apply date filters
			if (filters.dateBefore) {
				const beforeDate = new Date(filters.dateBefore);
				if (date > beforeDate) return false;
			}

			if (filters.dateAfter) {
				const afterDate = new Date(filters.dateAfter);
				if (date < afterDate) return false;
			}

			return true;
		});
	}, [coachReviews, filters]);

	// Apply sorting to filtered reviews
	const filteredAndSortedReviews = useMemo(() => {
		const sortedReviews = [...filteredReviews];

		sortedReviews.sort((a, b) => {
			switch (sortBy) {
				case 'mostRecent':
					return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
				case 'oldest':
					return new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime();
				case 'bestFirst':
					return b.rating - a.rating;
				case 'worstFirst':
					return a.rating - b.rating;
				default:
					return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
			}
		});

		return sortedReviews;
	}, [filteredReviews, sortBy]);

	// Pagination for reviews
	const {
		displayedItems: displayedReviews,
		hasMoreItems: hasMoreReviews,
		handleLoadMore: handleLoadMoreReviews,
	} = useClientSidePagination({
		items: filteredAndSortedReviews,
		itemsPerPage: 6,
		itemsPerPage2xl: 8,
	});

	// Loading state - only for page-critical data
	if (!coachIntroductionViewModel || !coachProfileAccessViewModel) {
		return <DefaultLoading locale={locale} variant="minimal" />;
	}

	// Error handling - only for page-critical data
	if (coachIntroductionViewModel?.mode === 'not-found' ||
		coachProfileAccessViewModel?.mode === 'not-found') {
		return <DefaultNotFound locale={locale} />;
	}

	if (coachIntroductionViewModel?.mode === 'kaboom' ||
		coachProfileAccessViewModel?.mode === 'kaboom') {
		return <DefaultError locale={locale} />;
	}

	// Access control check - if profile access is denied, show not found
	if (coachProfileAccessViewModel?.mode === 'default' && !coachProfileAccessViewModel.data.access) {
		return <DefaultNotFound locale={locale} />;
	}

	// Extract coach introduction from view model
	const coachIntroduction = coachIntroductionViewModel?.mode === 'default'
		? coachIntroductionViewModel.data.coach
		: null;

	// Sort and filter functions
	const sortOptions = [
		{ label: coachProfileTranslations('mostRecentFirst'), value: 'mostRecent' },
		{ label: coachProfileTranslations('oldestFirst'), value: 'oldest' },
		{ label: coachProfileTranslations('bestFirst'), value: 'bestFirst' },
		{ label: coachProfileTranslations('worstFirst'), value: 'worstFirst' },
	];

	const handleSortChange = (value: string | string[] | null) => {
		if (typeof value === 'string') {
			setSortBy(value);
		}
	};

	// Handle review submission
	const handleReviewSubmit = (rating: number, review: string) => {
		if (!reviewingCourse) return;

		// Prevent submission if already in progress (following reference pattern)
		if (createReviewMutation.isPending) {
			return;
		}

		// Reset error state before submitting
		setReviewError(false);

		// Get course slug from reviewing course
		const courseSlug = reviewingCourse.slug;

		createReviewMutation.mutate(
			{
				rating,
				courseSlug,
				review: review || null,
			},
			{
				onSuccess: (result) => {
					// Check if the business logic succeeded
					// The API returns success: true/false in the response
					if (result && result.success === true) {
						// Success - update UI state
						setReviewSubmitted(true);
						setReviewError(false);
						refetchCoachReviews();
						refetchCoachCourses();
					} else {
						// Business logic failure (e.g., course not found, validation error)
						setReviewError(true);
						setReviewSubmitted(false);
						// Keep modal open so user can retry
					}
				},
				onError: (error) => {
					// Error occurred during API call (network error, exception, etc.)
					setReviewError(true);
					setReviewSubmitted(false);
					// Keep modal open so user can retry
				}
			}
		);
	};

	// Handle review functionality - shows modal or snippet based on existing review
	const handleReviewAction = (course: CourseWithStatus) => {
		setReviewingCourse(course);
		setReviewSubmitted(false);
		setReviewError(false);

		// Check if the course is completed and has an existing review
		const isCompleted = course?.status?.status === 'completed';
		const hasReview = course.studentReview;

		if (isCompleted && hasReview) {
			// Course has been reviewed - show ReviewSnippet
			setShowReviewSnippet(true);
			setShowReviewModal(false);
		} else if (isCompleted && !hasReview) {
			// Course completed but no review - show ReviewModal
			setShowReviewModal(true);
			setShowReviewSnippet(false);
		}
	};

	// Handle closing review modal
	const handleCloseReviewModal = () => {
		setShowReviewModal(false);
		setReviewingCourse(null);
		setReviewSubmitted(false);
		setReviewError(false);
	};

	// Handle closing review snippet
	const handleCloseReviewSnippet = () => {
		setShowReviewSnippet(false);
		setReviewingCourse(null);
	};

	const renderCourseCards = (courses: viewModels.TListCoachCoursesSuccess['courses']) => {
		return courses.map((course) => {
			// Check if course has been purchased (has status property)
			const isPurchased = 'status' in course;
			const key = course.id;

			const baseProps = {
				locale: locale,
				reviewCount: course.ratingCount,
				course: {
					title: course.title,
					description: course.briefDescription,
					rating: course.rating,
					author: {
						name: `${course.creator.name} ${course.creator.surname}`,
						image: course.creator.avatarImage?.downloadUrl || ''
					},
					pricing: {
						fullPrice: course.fullPrice || 0,
						currency: course.currency,
						partialPrice: course.partialPrice || 0,
					},
					duration: {
						video: course.durationMinutes || 0,
						coaching: 0,
						selfStudy: 0
					},
					language: course.language,
					imageUrl: course.image?.downloadUrl || 'https://res.cloudinary.com/dgk9gxgk4/image/upload/v1733464948/2151206389_1_c38sda.jpg'
				},
				language: course.language,
				onClickUser: () => {
					route.push(`/${locale}/coaches/${course.creator.username}`);
				},
			};

			if (isPurchased) {
				const progress = course.status.status === 'inProgress' ? course.status.progress : 100;
				return (
					<CourseCard
						{...baseProps}
						key={key}
						userType="student"
						sales={course.salesCount}
						progress={progress}
						onBegin={() => {
							route.push(`/${locale}/courses/${course.slug}`);
						}}
						onResume={() => {
							route.push(`/${locale}/courses/${course.slug}?tab=${StudentCourseTab.STUDY}`);
						}}
						onReview={() => {
							handleReviewAction(course);
						}}
						onDetails={() => {
							window.open(`/${locale}/courses/${course.slug}`, '_blank');
						}}
					/>
				);
			} else {
				return (
					<CourseCard
						key={key}
						{...baseProps}
						userType="visitor"
						sessions={course.coachingSessionCount}
						sales={course.salesCount}
						onDetails={() => {
							window.open(`/${locale}/courses/${course.slug}`, '_blank');
						}}
						onBuy={() => {
							// TODO: Implement course purchase functionality
						}}
					/>
				);
			}
		});
	};

	return (
		<div className="flex flex-col space-y-5 px-30">
			{/* Profile Header Section */}
			{isLoggedIn && (
				<div className="flex flex-col gap-4 justify-start">
					<Button
						onClick={() => route.back()}
						variant="text"
						text={coachProfileTranslations('back')}
						hasIconLeft
						iconLeft={<IconChevronLeft />}
						className="w-fit p-0"
					/>

					<Breadcrumbs
						items={[
							{
								label: breadcrumbsTranslations('home'),
								onClick: () => route.push(`/${locale}`),
							},
							{
								label: coachIntroduction ? `${coachIntroduction.name} ${coachIntroduction.surname}` : username,
								onClick: () => route.push(`/${locale}/coaches/${username}`),
							},
						]}
					/>
				</div>
			)}

			{/* Coach Introduction Section */}
			{coachIntroduction && (
				isLoggedIn ? (
					<BookSessionWith
						coachName={`${coachIntroduction.name} ${coachIntroduction.surname}`}
						coachAvatarUrl={coachIntroduction?.avatarImage?.downloadUrl || ""}
						description={coachIntroduction.bio}
						coachRating={coachIntroduction.rating}
						totalRatings={coachIntroduction.ratingCount}
						onBookSessionWith={() => {
							window.open(`/${locale}/coaches/${username}/book`, '_blank');
						}}
						isCourseCreator={coachIntroduction.isCourseCreator}
						locale={locale}
					/>
				) : (
					<BuyCoachingSessionBanner
						coachName={`${coachIntroduction.name} ${coachIntroduction.surname}`}
						coachAvatarUrl={coachIntroduction?.avatarImage?.downloadUrl || ""}
						description={coachIntroduction.bio}
						coachRating={coachIntroduction.rating}
						totalRatings={coachIntroduction.ratingCount}
						onBookSessionWith={() => {
							window.open(`/${locale}/coaches/${username}/book`, '_blank');
						}}
						isCourseCreator={coachIntroduction.isCourseCreator}
						skills={coachIntroduction.skills.map(skill => skill.name)}
						locale={locale}
					/>
				)
			)}

			{/* Coach Courses Section for visitors */}
			{!isLoggedIn && (
				<div className='flex flex-col gap-4'>
					<h3 className='md:text-2xl text-lg font-bold text-text-primary leading-[110%]'>
						{coachProfileTranslations('coachCourses')}
					</h3>
					{!coachCoursesViewModel ? (
						<DefaultLoading locale={locale} variant="minimal" />
					) : coachCoursesViewModel.mode === 'kaboom' ? (
						<DefaultError locale={locale} />
					) : (
						<>
							<CourseCardList
								locale={locale}
								onEmptyStateButtonClick={() => {
									window.open(`/${locale}/offers`, '_blank');
								}}
								emptyStateMessage={coachProfileTranslations('emptyStateCourses')}
								emptyStateButtonText={coachProfileTranslations('exploreCourses')}
							>
								{renderCourseCards(displayedCourses)}
							</CourseCardList>

							{hasMoreCourses && (
								<Button
									variant="text"
									text={paginationTranslations('loadMore')}
									onClick={handleLoadMoreCourses}
									size="medium"
									className="pt-10"
								/>
							)}
						</>
					)}
				</div>
			)}

			{/* Coach Reviews Section */}
			<div className='flex flex-col gap-4'>
				<div className='flex justify-between items-center'>
					<h3 className='md:text-2xl text-lg font-bold text-text-primary leading-[110%]'>
						{coachProfileTranslations('coachReviews')}
					</h3>
					<div className="flex items-center gap-2">
						<div className="flex items-center gap-2">
							<p className="text-sm text-text-primary">
								{coachProfileTranslations('sortBy')}
							</p>
							<div className="w-48">
								<Dropdown
									type="simple"
									options={sortOptions}
									onSelectionChange={handleSortChange}
									defaultValue={sortBy}
									text={{ simpleText: coachProfileTranslations('selectSort') }}
								/>
							</div>
						</div>
						<Button
							variant="secondary"
							size="medium"
							text={coachProfileTranslations('filterButton')}
							onClick={() => setShowFilterModal(true)}
							hasIconLeft
							iconLeft={<IconFilter />}
							className="w-auto"
						/>
					</div>
				</div>
				{!coachReviewsViewModel ? (
					<DefaultLoading locale={locale} variant="minimal" />
				) : coachReviewsViewModel.mode === 'kaboom' ? (
					<DefaultError locale={locale} />
				) : (
					<>
						<CoachReviewCardList locale={locale}>
							{displayedReviews
								.filter(review => review && review.student && review.coachingSession && review.course)
								.map((review) => (
									<CoachReviewCard
										key={review.id}
										locale={locale}
										rating={review.rating}
										reviewerName={`${review.student.name} ${review.student.surname}`}
										reviewerAvatar={review.student.avatarImage?.downloadUrl || ''}
										reviewText={review.notes || ''}
										workshopTitle={review.coachingSession.coachingOfferingTitle}
										date={review.createdAt}
										time={new Date(review.createdAt).toLocaleTimeString(locale)}
										courseTitle={review.course?.title || ''}
										courseImage={review.course?.image?.downloadUrl || ''}
									/>
								))}
						</CoachReviewCardList>
						{hasMoreReviews && (
							<Button
								variant="text"
								text={paginationTranslations('loadMore')}
								onClick={handleLoadMoreReviews}
								size="medium"
								className="pt-10"
							/>
						)}
					</>
				)}
			</div>

			{/* Coach Review Filter Modal */}
			{showFilterModal && (
				<CoachReviewFilterModal
					onApplyFilters={(f) => setFilters(f)}
					onClose={() => setShowFilterModal(false)}
					initialFilters={filters}
					locale={locale}
				/>
			)}

			{/* Enrolled Courses Section for students */}
			{isLoggedIn && (
				<div className='flex flex-col gap-4'>
					<h3 className='md:text-2xl text-lg font-bold text-text-primary leading-[110%]'>
						{coachProfileTranslations('coachCourses')}
					</h3>
					{!coachCoursesViewModel ? (
						<DefaultLoading locale={locale} variant="minimal" />
					) : coachCoursesViewModel.mode === 'kaboom' ? (
						<DefaultError locale={locale} />
					) : (
						<>
							<CourseCardList
								locale={locale}
								onEmptyStateButtonClick={() => {
									window.open(`/${locale}/offers`, '_blank');
								}}
								emptyStateMessage={coachProfileTranslations('emptyStateCourses')}
								emptyStateButtonText={coachProfileTranslations('exploreCourses')}
							>
								{renderCourseCards(displayedCourses)}
							</CourseCardList>

							{hasMoreCourses && (
								<Button
									variant="text"
									text={paginationTranslations('loadMore')}
									onClick={handleLoadMoreCourses}
									size="medium"
									className="pt-10"
								/>
							)}
						</>
					)}
				</div>
			)}

			{/* Review Modal */}
			{showReviewModal && (
				<div className="fixed inset-0 flex items-center justify-center z-50 backdrop-blur-sm rounded-lg shadow-lg">
					<ReviewModal
						modalType="course"
						onClose={handleCloseReviewModal}
						onSubmit={handleReviewSubmit}
						onSkip={handleCloseReviewModal}
						locale={locale}
						isLoading={createReviewMutation.isPending}
						isError={createReviewMutation.isError || reviewError}
						submitted={reviewSubmitted}
					/>
				</div>
			)}

			{/* Review Display Modal - Shows existing review */}
			{showReviewSnippet && reviewingCourse && reviewingCourse.studentReview && (
				<div className="fixed inset-0 flex items-center justify-center z-50 backdrop-blur-sm">
					<ReviewDisplay
						reviewText={reviewingCourse.studentReview.review || ''}
						rating={reviewingCourse.studentReview.rating}
						onClose={handleCloseReviewSnippet}
						locale={locale}
					/>
				</div>
			)}
		</div>
	);
}
