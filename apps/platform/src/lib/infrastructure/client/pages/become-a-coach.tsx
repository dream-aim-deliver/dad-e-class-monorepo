'use client';

// Auto-generated by page-scaffold command v2
// Notion: https://www.notion.so/Become-a-coach-06c36feec8e340c79ca65f79971f1a20
// Usecases from Notion: listTopics, sendBecomeACoachEmail
// Features from Notion: listTopics, sendBecomeACoachEmail (client-side only - NOT YET IMPLEMENTED - use mailto link)
// API Endpoints from Notion:
// User Types from Notion: Visitor
// Figma: https://www.figma.com/design/8KEwRuOoD5IgxTtFAtLlyS/Just_Do_Ad-1.2?node-id=6247-208046

import { useTranslations } from 'next-intl';
import { TLocale } from '@maany_shr/e-class-translations';
import { useFormState } from 'packages/ui-kit/lib/hooks/use-form-state';
import { viewModels, fileMetadata } from '@maany_shr/e-class-models';
import { useState, useEffect, useMemo, useCallback } from 'react';
import { trpc } from '../trpc/cms-client';
import { useListTopicsPresenter } from '../hooks/use-topics-presenter';
import { Banner, DefaultError, DefaultLoading, BecomeACoachForm } from '@maany_shr/e-class-ui-kit';

// Types
type TSkill = { id: string | number; name: string; slug: string };

interface BecomeACoachProps {
  locale: TLocale;
}

export default function BecomeACoach({ locale }: BecomeACoachProps) {
  const t = useTranslations('pages.becomeACoach');

  // TRPC query for topics
  const [listTopicsResponse] = trpc.listTopics.useSuspenseQuery({});

  // State management
  const [listTopicsViewModel, setListTopicsViewModel] = useState<
    viewModels.TTopicListViewModel | undefined
  >(undefined);
  const [isSaving, setIsSaving] = useState(false);

  // State for messages
  const [errorMessage, setErrorMessage] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);

  const { presenter: listTopicsPresenter } = useListTopicsPresenter(setListTopicsViewModel);

  // Empty default professional profile data for new users - memoized to prevent re-renders
  const defaultProfessionalProfile = useMemo<viewModels.TGetProfessionalProfileSuccess['profile']>(() => ({
    id: 0,
    bio: '',
    linkedinUrl: null,
    curriculumVitae: null,
    skills: [],
    private: true,
    portfolioWebsite: null,
    companyName: null,
    companyRole: null,
    companyIndustry: null,
  }), []);

  const professionalForm = useFormState(defaultProfessionalProfile, {
    enableReloadProtection: true,
  });

  // Present topics data - called in useEffect to prevent render loops
  useEffect(() => {
    // @ts-ignore
    listTopicsPresenter.present(listTopicsResponse, listTopicsViewModel);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [listTopicsResponse, listTopicsPresenter]); // listTopicsViewModel excluded - presenter updates it via setListTopicsViewModel

  // Handle form submission and email generation - memoized to prevent recreation
  // TODO: Implement server-side email sending in the future
  const handleProfessionalSave = useCallback(async (profile: viewModels.TGetProfessionalProfileSuccess['profile']) => {
    if (!profile) return;

    // Validation
    const errors: string[] = [];

    // Bio validation (required)
    if (!profile.bio || profile.bio.trim() === '') {
      errors.push(t('validation.bioRequired'));
    }

    // LinkedIn URL validation (optional but must be valid if provided)
    const linkedInUrlRegex = /^https:\/\/(www\.)?linkedin\.com\/(in|company|school|showcase)\/[\w-]+\/?$/;
    if (profile.linkedinUrl && profile.linkedinUrl.trim() !== '' && !linkedInUrlRegex.test(profile.linkedinUrl.trim())) {
      errors.push(t('validation.linkedinInvalid'));
    }

    // Portfolio URL validation (optional but must be valid URL if provided)
    if (profile.portfolioWebsite && profile.portfolioWebsite.trim() !== '') {
      try {
        new URL(profile.portfolioWebsite.trim());
      } catch {
        errors.push(t('validation.portfolioInvalid'));
      }
    }

    // If there are validation errors, show them and return
    if (errors.length > 0) {
      setErrorMessage(errors.join('. '));
      setSuccessMessage(null);
      return;
    }

    try {
      setIsSaving(true);
      setErrorMessage(null);
      setSuccessMessage(null);

      // Generate localized email subject
      const emailSubject = t('email.subject');

      // Build email sections dynamically - only include fields that are provided
      const personalInfoLines: string[] = [];
      personalInfoLines.push(`- ${t('email.bio')}: ${profile.bio}`);
      if (profile.linkedinUrl) {
        personalInfoLines.push(`- ${t('email.linkedinProfile')}: ${profile.linkedinUrl}`);
      }
      if (profile.portfolioWebsite) {
        personalInfoLines.push(`- ${t('email.portfolioWebsite')}: ${profile.portfolioWebsite}`);
      }

      const companyInfoLines: string[] = [];
      if (profile.companyName) {
        companyInfoLines.push(`- ${t('email.companyName')}: ${profile.companyName}`);
      }
      if (profile.companyRole) {
        companyInfoLines.push(`- ${t('email.jobRole')}: ${profile.companyRole}`);
      }
      if (profile.companyIndustry) {
        companyInfoLines.push(`- ${t('email.industry')}: ${profile.companyIndustry}`);
      }

      const professionalDetailsLines: string[] = [];
      if (profile.skills.length > 0) {
        professionalDetailsLines.push(`- ${t('email.skillsExpertise')}: ${profile.skills.map(skill => skill.name).join(', ')}`);
      }

      // Build the complete email body
      const emailParts: string[] = [
        t('email.headerTitle'),
        '================================',
        '',
        t('email.personalInformation'),
        ...personalInfoLines,
      ];

      if (companyInfoLines.length > 0) {
        emailParts.push('', t('email.companyInformation'), ...companyInfoLines);
      }

      if (professionalDetailsLines.length > 0) {
        emailParts.push('', t('email.professionalDetails'), ...professionalDetailsLines);
      }

      emailParts.push('', '================================', t('email.footerNote'));

      const emailBody = emailParts.join('\n').trim();

      // Generate mailto link with encoded parameters
      const mailtoLink = `mailto:coaches@example.com?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;

      // Open email client with pre-filled data
      window.open(mailtoLink, '_blank');

      // Only set success if no error occurred
      setSuccessMessage(t('successTitle'));
    } catch {
      setErrorMessage(t('error.description'));
      setSuccessMessage(null);
    } finally {
      setIsSaving(false);
    }
  }, [t]);

  // Stable handler for form changes - prevents stale closures
  const handleProfessionalChange = useCallback((data: viewModels.TGetProfessionalProfileSuccess['profile']) => {
    professionalForm.setValue((prev) => {
      if (!prev) return prev;
      return data;
    });
  }, [professionalForm]);

  // Loading state
  if (!listTopicsViewModel) {
    return <DefaultLoading locale={locale} variant="minimal" />;
  }

  // Error handling - kaboom (hard error)
  if (listTopicsViewModel.mode === 'kaboom') {
    return (
      <DefaultError
        type="simple"
        locale={locale}
        title={t('loadError.title')}
        description={t('loadError.description')}
      />
    );
  }

  // Extract topics data and convert to TSkill format
  const listTopicsData = listTopicsViewModel.data.topics;
  const availableSkills: TSkill[] = listTopicsData.map(topic => ({
    id: topic.id,
    name: topic.name,
    slug: topic.slug
  }));

  return (
    <div className="flex flex-col gap-10 md:flex-row lg:flex-row justify-center px-4 md:px-8 max-w-[1400px] mx-auto">
      <div className='flex flex-col gap-4 md:w-[40%] lg:w-[35%]'>
        <h1 className='text-text-primary text-4xl font-bold'>{t('title')}</h1>
        <p className='text-text-primary text-md'>{t('description')}</p>
      </div>
      <div className='flex flex-col gap-4 md:w-[60%] lg:w-[65%]'>
        <p className='text-text-primary text-2xl font-bold'>{t('formTitle')}</p>
        <BecomeACoachForm
          initialData={professionalForm.value || defaultProfessionalProfile}
          onChange={handleProfessionalChange}
          availableSkills={availableSkills}
          onSave={handleProfessionalSave}
          onFileUpload={async () => ({} as fileMetadata.TFileMetadata)}
          onUploadComplete={() => { /* No-op: CV upload disabled */ }}
          onFileDelete={() => { /* No-op: CV upload disabled */ }}
          locale={locale as TLocale}
          isSaving={isSaving}
        />
        {/* Display error message */}
        {errorMessage && (
          <Banner style="error" description={errorMessage} />
        )}

        {/* Display success message */}
        {successMessage && !isSaving && (
          <Banner style="success" description={successMessage} />
        )}
      </div>
    </div>
  );
}