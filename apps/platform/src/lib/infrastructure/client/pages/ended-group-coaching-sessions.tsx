'use client';

// Auto-generated by page-scaffold command
// Notion: https://www.notion.so/Ended-Group-Coaching-Sessions-group-course-tab-2245a7432d0180cab050ef2e0ebbb675
// Feature: listGroupCoachingSessions (FEAT-169)
// User Type: Coach
// Figma: https://www.figma.com/design/8KEwRuOoD5IgxTtFAtLlyS/Just_Do_Ad-1.2?node-id=6913-296778

import { useState, useEffect, useMemo } from 'react';
import { useLocale, useTranslations } from 'next-intl';
import { useSession } from 'next-auth/react';
import { getDictionary, TLocale } from '@maany_shr/e-class-translations';
import { viewModels } from '@maany_shr/e-class-models';
import { DefaultLoading, DefaultError, DefaultNotFound, Breadcrumbs, Dropdown, Button, CoachingSessionGroupOverviewList, CoachingSessionGroupOverviewCard, CoachingSessionFilterModal, type CoachingSessionFilterModel, IconFilter } from '@maany_shr/e-class-ui-kit';
import { trpc } from '../trpc/cms-client';
import { useListGroupCoachingSessionsPresenter } from '../hooks/use-list-group-coaching-sessions-presenter';
import useClientSidePagination from '../utils/use-client-side-pagination';
import { useRouter } from 'next/navigation';
import { useGetGroupIntroductionPresenter } from '../hooks/use-get-group-introduction-presenter';

interface EndedGroupCoachingSessionsProps {
    locale: TLocale;
    courseSlug: string;
    groupId: number;
}

export default function EndedGroupCoachingSessions({
    locale: localeProp,
    courseSlug,
    groupId,
}: EndedGroupCoachingSessionsProps) {
    const currentLocale = useLocale() as TLocale;
    const t = useTranslations('pages.endedGroupCoachingSessions');
    const breadcrumbsTranslations = useTranslations('components.breadcrumbs');
    const paginationTranslations = useTranslations('components.paginationButton');
    const dictionary = getDictionary(localeProp);
    const { data: session, status } = useSession();
    const router = useRouter();

    // Fetch ended group coaching sessions using TRPC
    const [sessionsResponse] = trpc.listGroupCoachingSessions.useSuspenseQuery({
        groupId,
    });

    // Fetch group introduction using TRPC
    const [groupIntroductionResponse] = trpc.getGroupIntroduction.useSuspenseQuery({
        courseSlug,
        additionalParams: {
            groupId,
            requestType: "requestForCoach",
        }
    });

    // View model state
    const [sessionsViewModel, setSessionsViewModel] = useState<
        viewModels.TListGroupCoachingSessionsViewModel | undefined
    >(undefined);

    const [groupIntroductionViewModel , setGroupIntroductionViewModel] = useState<
        viewModels.TGetGroupIntroductionViewModel | undefined
    >(undefined);

    // Sorting state
    const [sortBy, setSortBy] = useState<string>('sessionDate');

    // Filter states
    const [isFilterModalOpen, setIsFilterModalOpen] = useState(false);
    const [filters, setFilters] = useState<CoachingSessionFilterModel>({
        maxRating: 5,
        minRating: 1,
        courseName: '',
        dateBefore: '',
        dateAfter: '',
        minParticipants: undefined,
        maxParticipants: undefined,
    });

    // Initialize presenter
    const { presenter } = useListGroupCoachingSessionsPresenter(setSessionsViewModel);
    const { presenter: groupIntroPresenter } = useGetGroupIntroductionPresenter(setGroupIntroductionViewModel);

    // Present data to view model
    useEffect(() => {
        // @ts-ignore - Presenter type compatibility issue
        presenter.present(sessionsResponse, sessionsViewModel);
    }, [sessionsResponse, presenter, sessionsViewModel]);

    // @ts-ignore
    groupIntroPresenter.present(groupIntroductionResponse, groupIntroductionViewModel);

    // Handlers
    const formatTime = (isoString: string) => {
        const date = new Date(isoString);
        return date.toLocaleTimeString(localeProp, {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
    };

    // Sort options - only keep basic sorting, filtering handles the rest
    const sortOptions = [
        { label: t('filters.sessionDateNewest'), value: 'sessionDate' },
        { label: t('filters.sessionDateOldest'), value: 'sessionDateOldest' },
        { label: t('filters.courseNameAZ'), value: 'courseName' },
        { label: t('filters.courseNameZA'), value: 'courseNameDesc' },
    ];

    // Handle dropdown change
    const handleSortChange = (value: string | string[] | null) => {
        if (typeof value === 'string') {
            setSortBy(value);
        }
    };

    const handleOpenFilterModal = () => {
        setIsFilterModalOpen(true);
    };

    // Get sessions data or use empty array for filtering
    const allSessions = useMemo(() => {
        if (!sessionsViewModel || sessionsViewModel.mode !== 'default') {
            return [];
        }
        return sessionsViewModel.data.sessions;
    }, [sessionsViewModel]);

    // Apply filters to the sessions using useMemo for performance
    const filteredSessions = useMemo(() => {
        return allSessions.filter(session => {
            const rating = session.averageRating || 0;
            const sessionDate = new Date(session.publicationDate);

            // Apply rating filters
            if (rating < (filters.minRating || 1) || rating > (filters.maxRating || 5)) {
                return false;
            }

            // Apply course name filter
            if (filters.courseName && !session.course.title.toLowerCase().includes(filters.courseName.toLowerCase())) {
                return false;
            }

            // Apply participants filter
            if (filters.minParticipants && session.studentCount < filters.minParticipants) {
                return false;
            }
            if (filters.maxParticipants && session.studentCount > filters.maxParticipants) {
                return false;
            }

            // Apply date filters
            if (filters.dateBefore) {
                const beforeDate = new Date(filters.dateBefore);
                if (sessionDate > beforeDate) return false;
            }

            if (filters.dateAfter) {
                const afterDate = new Date(filters.dateAfter);
                if (sessionDate < afterDate) return false;
            }

            return true;
        });
    }, [allSessions, filters]);

    // Apply sorting to filtered sessions
    const sortedSessions = useMemo(() => {
        const sessions = [...filteredSessions];

        return sessions.sort((a, b) => {
            switch (sortBy) {
                case 'sessionDate':
                    return new Date(b.startTime).getTime() - new Date(a.startTime).getTime();
                case 'sessionDateOldest':
                    return new Date(a.startTime).getTime() - new Date(b.startTime).getTime();
                case 'courseName':
                    return a.course.title.localeCompare(b.course.title);
                case 'courseNameDesc':
                    return b.course.title.localeCompare(a.course.title);
                default:
                    return 0;
            }
        });
    }, [filteredSessions, sortBy]);

    // Pagination for sessions
    const {
        displayedItems: displayedSessions,
        hasMoreItems: hasMoreSessions,
        handleLoadMore: handleLoadMoreSessions,
    } = useClientSidePagination({
        items: sortedSessions,
        itemsPerPage: 6,
        itemsPerPage2xl: 8,
    });

    // Loading state
    if (status === 'loading' || !sessionsViewModel || !groupIntroductionViewModel) {
        return <DefaultLoading locale={currentLocale} variant="minimal" />;
    }

    // Authentication check - Coach only
    if (!session) {
        return (
            <DefaultError
                type="simple"
                locale={currentLocale}
                title={t('error.accessDenied')}
                description={t('error.accessDenied')}
            />
        );
    }

    // Error handling using discovered project patterns
    if (sessionsViewModel.mode === 'kaboom') {
        const errorData = sessionsViewModel.data;

        return (
            <DefaultError
                type="simple"
                locale={currentLocale}
                title={t('error.title')}
                description={errorData.message || t('error.description')}
            />
        );
    }

    if( groupIntroductionViewModel.mode === 'kaboom') {
        const errorData = groupIntroductionViewModel.data;

        return (
            <DefaultError
                type="simple"
                locale={currentLocale}
                title={t('error.title')}
                description={errorData.message || t('error.description')}
            />
        );
    }
    

    if (sessionsViewModel.mode === 'not-found') {
        const errorData = sessionsViewModel.data;

        return (
            <DefaultNotFound
                locale={currentLocale}
                title={t('error.notFoundTitle')}
                description={errorData.message || t('error.notFoundDescription')}
            />
        );
    }

    if( groupIntroductionViewModel.mode === 'not-found') {
        const errorData = groupIntroductionViewModel.data;

        return (
            <DefaultNotFound
                locale={currentLocale}
                title={t('error.notFoundTitle')}
                description={errorData.message || t('error.notFoundDescription')}
            />
        );
    }

    // Success state - extract data
    const sessionsData = sessionsViewModel.data;
    const groupIntroductionData = groupIntroductionViewModel.data;

    return (
        <div className="flex flex-col space-y-5">
            <Breadcrumbs
                items={[
                    {
                        label: breadcrumbsTranslations('home'),
                        onClick: () => router.push(`/${currentLocale}`),
                    },
                    {
                        label: breadcrumbsTranslations('workspace'),
                        onClick: () => router.push(`/${currentLocale}/workspace`),
                    },
                    {
                        label: breadcrumbsTranslations('yourCourses'),
                        onClick: () => router.push(`/${currentLocale}/workspace/courses`),
                    },
                    {
                        label: courseSlug,
                        onClick: () => router.push(`/${currentLocale}/workspace/courses/${courseSlug}`),
                    },
                    {
                        label: breadcrumbsTranslations('groups'),
                        onClick: () => router.push(`/${currentLocale}/workspace/courses/${courseSlug}/groups`),
                    },
                    {
                        label: groupIntroductionData.name,
                        onClick: () => router.push(`/${currentLocale}/workspace/courses/${courseSlug}/groups/${groupId}`),
                    },
                    {
                        label: breadcrumbsTranslations('coachingSessionReviews'),
                        onClick: () => router.push(`/${currentLocale}/workspace/courses/${courseSlug}/groups/${groupId}/coaching-sessions`),
                    },
                ]}
            />

            <div className='flex flex-col gap-4'>
                <div className='flex items-start justify-between md:flex-row flex-col gap-4'>
                    <div className='flex flex-col gap-2'>
                        <h6 className='text-text-secondary text-sm md:text-md leading-[120%]'>
                            {groupIntroductionData.name}
                        </h6>
                        <h2 className='text-text-primary md:text-3xl text-xl font-bold'>
                            {t('title')}
                        </h2>
                        <p className='text-text-secondary text-sm md:text-md'>
                            {t('description')}
                        </p>
                    </div>
                    {/* Filter and sort controls */}
                    <div className="flex items-center gap-4 flex-wrap md:w-auto w-full justify-between">
                        <div className="flex items-center gap-2">
                            <p className="text-sm text-text-primary whitespace-nowrap">
                                {t('filters.sortBy')}
                            </p>
                            <div className="w-48">
                                <Dropdown
                                    type="simple"
                                    options={sortOptions}
                                    onSelectionChange={handleSortChange}
                                    defaultValue={sortBy}
                                    text={{ simpleText: t('filters.selectSort') }}
                                />
                            </div>
                        </div>
                        <Button
                            variant="secondary"
                            size="medium"
                            text={t('filters.filterSessions')}
                            onClick={handleOpenFilterModal}
                            hasIconLeft
                            iconLeft={<IconFilter />}
                            className="w-auto"
                        />
                    </div>
                </div>

                {/* Sessions with pagination */}
                {displayedSessions.length > 0 ? (
                    <>
                        <CoachingSessionGroupOverviewList locale={localeProp}>
                            {displayedSessions.map((session, idx) => (
                                <CoachingSessionGroupOverviewCard
                                    key={session.id}
                                    locale={localeProp}
                                    userType='coach'
                                    title={session.coachingOfferingTitle}
                                    duration={session.coachingOfferingDuration}
                                    date={new Date(session.publicationDate)}
                                    startTime={formatTime(session.startTime)}
                                    endTime={formatTime(session.endTime)}
                                    withinCourse={!!session.course}
                                    courseName={session.course.title}
                                    courseImageUrl={session.course.imageUrl || ""}
                                    groupName={session.group.name}
                                    status='ended'
                                    reviewCount={session.reviewCount}
                                    averageRating={session.averageRating || 0}
                                    studentCount={session.studentCount}
                                    onClickCourse={() => router.push(`/${currentLocale}/courses/${courseSlug}`)}
                                    onClickGroup={() => router.push(`/${currentLocale}/workspace/courses/${courseSlug}/groups/${groupId}`)}
                                />
                            ))}
                        </CoachingSessionGroupOverviewList>
                        {hasMoreSessions && (
                            <div className="flex justify-center items-center w-full mt-6">
                                <Button
                                    variant="text"
                                    text={paginationTranslations('loadMore')}
                                    onClick={handleLoadMoreSessions}
                                />
                            </div>
                        )}
                    </>
                ) : (
                    <div className="flex items-center justify-center py-16">
                        <p className="text-text-secondary md:text-xl text-lg">{t('groupHasNoSessions')}</p>
                    </div>
                )}
            </div>

            {/* Coaching Session Filter Modal */}
            {isFilterModalOpen && (
                <CoachingSessionFilterModal
                    onApplyFilters={(f) => setFilters(f)}
                    onClose={() => setIsFilterModalOpen(false)}
                    initialFilters={filters}
                    locale={localeProp}
                />
            )}
        </div>
    );
}