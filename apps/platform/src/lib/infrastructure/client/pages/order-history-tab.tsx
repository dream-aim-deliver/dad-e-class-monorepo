'use client';

// Auto-generated by page-scaffold command v2 - Refactored
// Notion: https://www.notion.so/Order-history-Orders-Payments-Student-workspace-6bb2794c7331418e8fbbf83c40dcb1e5
// Usecases from Notion: listUserIncomingTransactions, generateInvoicePdf
// Features from Notion: View transaction history, Download/Generate invoices
// User Types from Notion: Student, Coach
// Figma: https://www.figma.com/design/8KEwRuOoD5IgxTtFAtLlyS/Just_Do_Ad-1.2?node-id=7709-215954

import { useLocale, useTranslations } from 'next-intl';
import { TLocale } from '@maany_shr/e-class-translations';
import { trpc } from '../trpc/cms-client';
import { OrderHistoryCard, OrderHistoryCardList, Button } from '@maany_shr/e-class-ui-kit';
import { useState } from 'react';
import { useSession } from 'next-auth/react';
import { generateInvoicePdf } from '../utils/generate-invoice-pdf';

interface OrderHistoryTabProps {
  locale: TLocale;
}

export default function OrderHistoryTab({ locale }: OrderHistoryTabProps) {
  const t = useTranslations('pages.orderHistory');
  const currentLocale = useLocale() as TLocale;
  const { data: session } = useSession();

  // Pagination state - show 8 cards initially (2 rows on desktop with 4 cols)
  const [visibleCount, setVisibleCount] = useState(8);
  const ITEMS_PER_PAGE = 8;
  const [isGeneratingPdf, setIsGeneratingPdf] = useState<string | null>(null);

  // Fetch platform data for invoice branding
  const [platformResponse] = trpc.getPlatform.useSuspenseQuery({});

  // Fetch personal profile for customer details in invoice
  const [personalProfileResponse] = trpc.getPersonalProfile.useSuspenseQuery({});

  // TRPC query for listUserIncomingTransactions usecase
  const [transactionsResponse] = trpc.listUserIncomingTransactions.useSuspenseQuery({});

  // Handle error states
  if (!transactionsResponse.success) {
    const mode = (transactionsResponse as any).mode;

    // Determine which error message to show based on mode
    let errorTitle = t('error.title');
    let errorDescription = t('error.description');

    if (mode === 'kaboom') {
      errorTitle = t('error.kaboom.title');
      errorDescription = t('error.kaboom.description');
    } else if (mode === 'not-found') {
      errorTitle = t('error.notFound.title');
      errorDescription = t('error.notFound.description');
    } else if (mode === 'unauthorized') {
      errorTitle = t('error.unauthorized.title');
      errorDescription = t('error.unauthorized.description');
    }

    return (
      <div className="flex flex-col space-y-3">
        <div className="rounded-lg border border-red-200 bg-red-50 p-4">
          <h3 className="text-lg font-semibold text-red-800">{errorTitle}</h3>
          <p className="text-sm text-red-600 mt-1">{errorDescription}</p>
        </div>
      </div>
    );
  }

  // Get all transactions
  const getAllTransactions = () => {
    const responseData = transactionsResponse.data as { transactions: any[] };
    return responseData.transactions || [];
  };

  // Handler for invoice download/generation
  const handleInvoiceClick = async (transactionId: string | number) => {
    const allTransactions = getAllTransactions();
    const transaction = allTransactions.find((t: any) => t.id === transactionId);

    if (!transaction) {
      alert(t('transactionNotFound'));
      return;
    }

    // Get platform data
    const platformData = (platformResponse as any)?.success ? (platformResponse as any).data : null;

    // Get customer data
    const personalProfile = (personalProfileResponse as any)?.success
      ? (personalProfileResponse as any).data?.profile
      : null;

    setIsGeneratingPdf(String(transactionId));

    try {
      // Use the reusable invoice PDF generator utility
      await generateInvoicePdf({
        transaction,
        platformData: {
          name: platformData?.name || t('platformNameFallback'),
          logoUrl: platformData?.logoUrl,
          domainName: platformData?.domainName,
        },
        customerData: {
          name: personalProfile?.name,
          surname: personalProfile?.surname,
          email: personalProfile?.email,
          phone: personalProfile?.phone,
          companyDetails: personalProfile?.companyDetails,
        },
        locale: currentLocale,
        translations: {
          invoiceNo: t('invoice.invoiceNo'),
          invoiceDate: t('invoice.invoiceDate'),
          customerDetails: t('invoice.customerDetails'),
          fullName: t('invoice.fullName'),
          email: t('invoice.email'),
          phoneNumber: t('invoice.phoneNumber'),
          companyName: t('invoice.companyName'),
          companyUidVat: t('invoice.companyUidVat'),
          companyEmail: t('invoice.companyEmail'),
          companyAddress: t('invoice.companyAddress'),
          orderId: t('invoice.orderId'),
          pricePerUnit: t('invoice.pricePerUnit'),
          units: t('invoice.units'),
          total: t('invoice.total'),
          course: t('invoice.course'),
          coachingSession: t('invoice.coachingSession'),
          package: t('invoice.package'),
          totalLabel: t('invoice.totalLabel'),
          paymentMethod: t('invoice.paymentMethod'),
        },
      });
    } catch (error: any) {
      alert(`${t('invoiceGenerationFailed')}: ${error?.message || t('unknownError')}`);
    } finally {
      setIsGeneratingPdf(null);
    }
  };

  // Transform transactions data to OrderHistoryCard props
  const renderOrderCards = () => {
    const transactions = getAllTransactions();

    if (transactions.length === 0) {
      return null;
    }

    // Only render the visible transactions based on pagination
    const visibleTransactions = transactions.slice(0, visibleCount);

    return visibleTransactions.map((transaction: any) => {
      // Determine the transaction type based on content.type
      const orderType = transaction.content.type;

      if (orderType === 'course') {
        const course = transaction.content.course;
        return (
          <OrderHistoryCard
            key={transaction.id}
            locale={currentLocale}
            type="course"
            orderId={transaction.id}
            orderDate={new Date(transaction.createdAt).toLocaleString(currentLocale === 'de' ? 'de-DE' : 'en-GB', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            })}
            total={`${transaction.content.unitPrice} ${transaction.currency}`}
            courseTitle={course.title}
            courseImageUrl={course.imageUrl || ''}
            onClickCourse={() => {
              // TODO: Navigate to course
              console.log('Navigate to course:', course.id);
            }}
            onInvoiceClick={() => handleInvoiceClick(transaction.id)}
          />
        );
      }

      if (orderType === 'coachingOffers') {
        const coachingContent = transaction.content;
        // Calculate total price from all items
        const totalPrice = coachingContent.items.reduce((sum: number, item: any) =>
          sum + (item.unitPrice * item.quantity), 0);

        // Transform coaching items from the API to match our component structure
        const sessions = coachingContent.items.map((item: any) => ({
          sessionName: item.title,
          durationMinutes: parseInt(item.duration) || 30,
          count: item.quantity,
        }));

        return (
          <OrderHistoryCard
            key={transaction.id}
            locale={currentLocale}
            type="coaching"
            orderId={transaction.id}
            orderDate={new Date(transaction.createdAt).toLocaleString(currentLocale === 'de' ? 'de-DE' : 'en-GB', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            })}
            total={`${totalPrice} ${transaction.currency}`}
            sessions={sessions}
            onInvoiceClick={() => handleInvoiceClick(transaction.id)}
          />
        );
      }

      if (orderType === 'package') {
        const pkg = transaction.content.package;
        // Transform courses included in the package
        const coursesIncluded = transaction.content.coursesIncluded?.map((course: any) => ({
          title: course.title,
          imageUrl: course.imageUrl || '',
          onClick: () => {
            console.log('Navigate to course:', course.id);
          },
        })) || [];

        return (
          <OrderHistoryCard
            key={transaction.id}
            locale={currentLocale}
            type="package"
            orderId={transaction.id}
            orderDate={new Date(transaction.createdAt).toLocaleString(currentLocale === 'de' ? 'de-DE' : 'en-GB', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            })}
            total={`${transaction.content.unitPrice} ${transaction.currency}`}
            packageTitle={pkg.title}
            packageImageUrl={pkg.imageUrl || ''}
            coursesIncluded={coursesIncluded}
            onInvoiceClick={() => handleInvoiceClick(transaction.id)}
          />
        );
      }

      return null;
    });
  };

  const allTransactions = getAllTransactions();
  const hasMore = visibleCount < allTransactions.length;

  const handleLoadMore = () => {
    setVisibleCount(prev => prev + ITEMS_PER_PAGE);
  };

  return (
    <div className="flex flex-col gap-6">
      <OrderHistoryCardList locale={currentLocale}>
        {renderOrderCards()}
      </OrderHistoryCardList>

      {hasMore && (
        <div className="flex justify-center">
          <Button
            variant="secondary"
            size="medium"
            text={t('loadMore')}
            onClick={handleLoadMore}
          />
        </div>
      )}
    </div>
  );
}
