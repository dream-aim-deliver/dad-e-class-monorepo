import { i18nConfig, TLocale } from '@maany_shr/e-class-translations';
import './global.css';
import { NextIntlClientProvider } from 'next-intl';
import { getMessages } from 'next-intl/server';
import { Figtree, Nunito, Raleway, Roboto } from 'next/font/google';
import { notFound, redirect } from 'next/navigation';
import { SessionProvider } from 'next-auth/react';
import { auth } from '@maany_shr/e-class-models';
import { NextAuthGateway } from '@maany_shr/e-class-auth';
import nextAuth from '../../lib/infrastructure/server/config/auth/next-auth.config';
import ClientProviders from '../../lib/infrastructure/client/utils/client-providers';
import {
    getQueryClient,
    trpc,
} from '../../lib/infrastructure/server/config/trpc/server';
import { env } from '../../lib/infrastructure/server/utils/env';
import { unstable_cache } from 'next/cache';
import Header from '../../lib/infrastructure/client/pages/header';
import {
    languageCodeToLocale,
    localeToLanguageCode,
    storePlatformLanguageId,
} from '../../lib/infrastructure/server/utils/language-mapping';
import Footer from '../../lib/infrastructure/client/pages/footer';
import { viewModels } from '@maany_shr/e-class-models';
import { getPlatformPresenter } from '../../lib/infrastructure/server/presenters/get-platform-presenter';

export const metadata = {
    title: 'Welcome to Platform',
    description: 'Generated by create-nx-workspace',
};

const nunito = Nunito({
    weight: ['300', '400', '700'],
    variable: '--font-nunito',
    subsets: ['latin'],
});
const raleway = Raleway({
    weight: ['300', '400', '700'],
    variable: '--font-raleway',
    subsets: ['latin'],
});
const roboto = Roboto({
    weight: ['300', '400', '700'],
    variable: '--font-roboto',
    subsets: ['latin'],
});
const figtree = Figtree({
    weight: ['300', '400', '700'],
    variable: '--font-figtree',
    subsets: ['latin'],
});

interface RootLayoutProps {
    children: React.ReactNode;
    params: { locale: string };
}

const getCachedPlatform = unstable_cache(
    async () => {
        const queryOptions = trpc.getPlatform.queryOptions({
            id: env.platformId,
        });
        const queryClient = getQueryClient();
        const platformResponse = await queryClient.fetchQuery(queryOptions);
        let platformViewModel: viewModels.TPlatformViewModel | undefined;
        const presenter = getPlatformPresenter((newViewModel) => {
            platformViewModel = newViewModel;
        });
        await presenter.present(platformResponse, platformViewModel);

        if (!platformViewModel || platformViewModel.mode === 'kaboom') {
            throw new Error(
                platformViewModel?.data?.message ||
                    'Unknown critical error occurred',
            );
        }

        if (platformViewModel.mode === 'unauthenticated') {
            redirect(`/auth/login`);
        }

        return platformViewModel;
    },
    ['platform', env.platformId],
    {
        tags: ['platform', `platform-${env.platformId}`],
        revalidate: 3600, // 1 hour
    },
);

const listCachedLanguages = unstable_cache(
    async () => {
        const queryOptions = trpc.listLanguages.queryOptions({
            platformId: env.platformId,
        });
        const queryClient = getQueryClient();
        return await queryClient.fetchQuery(queryOptions);
    },
    ['languages', env.platformId],
    {
        tags: ['languages', `languages-${env.platformId}`],
        revalidate: 3600, // 1 hour
    },
);

export default async function RootLayout({
    children,
    params: paramsPromise,
}: {
    children: React.ReactNode;
    params: Promise<{ locale: string }>;
}) {
    // Fetch cached configuration
    const [platformViewModel, languages] = await Promise.all([
        getCachedPlatform(),
        listCachedLanguages(),
    ]);

    // Check if platform's languages are supported
    const availableLocales: TLocale[] = [];
    for (const language of languages) {
        const availableLocale = languageCodeToLocale[language.code];
        if (availableLocale && i18nConfig.locales.includes(availableLocale)) {
            availableLocales.push(availableLocale);
        } else {
            // TODO: might be a soft error
            throw new Error('A platform language is not supported');
        }
    }

    // Check if the locale is supported
    const params = await paramsPromise;
    const locale = params.locale as TLocale;
    const language = languages.find(
        (value) => value.code === localeToLanguageCode[locale],
    );

    if (!availableLocales.includes(locale) || !language) {
        notFound();
    }

    storePlatformLanguageId(locale, language.platformLanguageId);
    const messages = await getMessages({ locale });

    // Perform authentication
    const authGateway = new NextAuthGateway(nextAuth);
    const sessionDTO = await authGateway.getSession();
    let session: auth.TSession | null = null;
    if (sessionDTO.success) {
        session = sessionDTO.data;
    }

    return (
        <html lang={locale}>
            <head>
                <link
                    rel="preload"
                    href={platformViewModel.data.backgroundImageUrl}
                    as="image"
                />
            </head>
            <body
                className={`${nunito.variable} ${roboto.variable} ${raleway.variable} ${figtree.variable}`}
            >
                <SessionProvider session={session}>
                    <NextIntlClientProvider locale={locale} messages={messages}>
                        <ClientProviders
                            initialPlatformLanguageId={
                                language.platformLanguageId
                            }
                        >
                            <div
                                className="w-full min-h-screen bg-repeat-y flex flex-col justify-center items-center"
                                style={{
                                    // Temporary linear gradient to match the Figma. Should be uploaded this dark.
                                    backgroundImage: `linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url(${platformViewModel.data.backgroundImageUrl})`,
                                    backgroundSize: '100% auto',
                                    // TODO: have a fallback color
                                    backgroundColor: '#141414',
                                }}
                            >
                                <Header
                                    platformViewModel={platformViewModel}
                                    availableLocales={availableLocales}
                                    locale={locale}
                                    session={session}
                                />
                                <main className="flex-grow w-full max-w-7xl mx-auto px-4 py-16">
                                    {children}
                                </main>
                                <Footer
                                    locale={locale}
                                    availableLocales={availableLocales}
                                    platformViewModel={platformViewModel}
                                />
                            </div>
                        </ClientProviders>
                    </NextIntlClientProvider>
                </SessionProvider>
            </body>
        </html>
    );
}
